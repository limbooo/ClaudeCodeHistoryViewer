<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="appTitle">Claude JSONL È°πÁõÆÂéÜÂè≤Ëß£ÊûêÂô®</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f9fafb;
            min-height: 100vh;
        }
    </style>
</head>

<body>
    <claude-history-app></claude-history-app>

    <script>
        // Main application component
        class ClaudeCodeHistoryApp extends HTMLElement {
            constructor() {
                super();
                this.dataManager = window.dataManager;
                this.styleManager = window.styleManager || new StyleManager();
                this.languageManager = window.languageManager;
                this.attachShadow({ mode: 'open' });
            }

            connectedCallback() {
                // Initialize theme before rendering
                this.styleManager.initializeTheme();

                this.render();
                this.attachEventListeners();
                this.loadInitialState();

                // Apply initial theme to shadow DOM
                const currentTheme = this.styleManager.getCurrentTheme();
                const themeInfo = this.styleManager.getThemeManager().getThemeInfo();
                this.handleThemeChanged({ theme: currentTheme, colors: themeInfo.colors });
            }

            render() {
                this.shadowRoot.innerHTML = `
            <style>
                ${this.styleManager.generateTailwindStyles()}
                ${this.styleManager.getAppStyles()}
                ${this.getModalStyles()}
            </style>
            <div class="claude-app-container flex flex-col lg:flex-row gap-6">
                <!-- Left Panel -->
                <div class="claude-left-panel lg:w-2/5 flex flex-col gap-4">
                    <div class="rounded-xl shadow-md p-4" style="background-color: var(--bg-primary); box-shadow: var(--shadow-color) 0 4px 6px -1px, var(--shadow-color) 0 2px 4px -1px;">
                        <div class="flex justify-between items-center mb-3">
                            <h2 class="text-lg font-semibold flex items-center" style="color: var(--text-primary);">
                                <span class="mr-2" style="color: var(--button-primary);">üìÅ</span>
                                <span id="projectFolderTitle">${this.languageManager.get('projectFolder')}</span>
                            </h2>
                            <div class="flex space-x-2">
                                <button id="themeToggle" class="px-3 py-2 rounded text-sm transition-colors border-0 flex items-center hover-scale" style="background-color: var(--button-secondary); color: var(--text-primary);">
                                    <span class="mr-1" id="themeToggleIcon">${this.styleManager.getThemeManager().getThemeInfo().icon}</span>
                                </button>
                                <button id="languageToggle" class="px-3 py-2 rounded text-sm transition-colors border-0 flex items-center hover-scale" style="background-color: var(--button-secondary); color: var(--text-primary);">
                                    <span class="mr-1">üåê</span>
                                    <span id="languageToggleText">${this.languageManager.getCurrentLanguage() === 'zh-CN' ? '‰∏≠Êñá' : 'English'}</span>
                                </button>
                            </div>
                        </div>
                        <div class="flex mb-3">
                            <input type="text" id="folderPath" placeholder="${this.languageManager.get('selectFolderPlaceholder')}" readonly
                                class="flex-1 px-3 py-2 text-sm border rounded-l-lg" style="background-color: var(--bg-tertiary); color: var(--text-primary); border-color: var(--border-primary);">
                            <button id="browseBtn"
                                class="px-3 py-2 rounded-r-lg transition-colors text-sm border-0 hover-scale" style="background-color: var(--button-primary); color: var(--text-inverse);">
                                <span class="mr-1">üìÅ</span>
                                <span id="browseBtnText">${this.languageManager.get('selectButton')}</span>
                            </button>
                        </div>

                        <!-- Option buttons -->
                        <div class="flex space-x-2">
                            <button id="refreshBtn"
                                class="flex-1 px-3 py-2 rounded text-sm transition-colors border-0 hover-scale" style="background-color: var(--button-secondary); color: var(--text-primary);">
                                <span class="mr-1">üîÑ</span>
                                <span id="refreshBtnText">${this.languageManager.get('refreshButton')}</span>
                            </button>
                            <button id="expandAllBtn"
                                class="flex-1 px-3 py-2 rounded text-sm transition-colors border-0 hover-scale" style="background-color: var(--button-secondary); color: var(--text-primary);">
                                <span class="mr-1">‚¨áÔ∏è</span>
                                <span id="expandAllBtnText">${this.languageManager.get('expandAllButton')}</span>
                            </button>
                            <button id="collapseAllBtn"
                                class="flex-1 px-3 py-2 rounded text-sm transition-colors border-0 hover-scale" style="background-color: var(--button-secondary); color: var(--text-primary);">
                                <span class="mr-1">‚¨ÜÔ∏è</span>
                                <span id="collapseAllBtnText">${this.languageManager.get('collapseAllButton')}</span>
                            </button>
                            <button id="resetBtn"
                                class="flex-1 px-3 py-2 rounded text-sm transition-colors border-0 hover-scale" style="background-color: var(--button-secondary); color: var(--text-primary);">
                                <span class="mr-1">‚Ü©Ô∏è</span>
                                <span id="resetBtnText">${this.languageManager.get('resetButton')}</span>
                            </button>
                        </div>

                        <div class="mt-2 text-xs" style="color: var(--text-quaternary);">
                            <p><span class="mr-1">‚ÑπÔ∏è</span>${this.languageManager.get('browserSupportInfo')}</p>
                        </div>
                    </div>

                    <!-- File Browser Component -->
                    <file-browser></file-browser>
                </div>

                <!-- Right Panel -->
                <div class="claude-right-panel lg:w-3/5">
                    <!-- Message Viewer Component -->
                    <message-viewer></message-viewer>
                </div>
            </div>

            <!-- Search Modal -->
            <div id="searchModal" class="search-modal" style="display: none;">
                <div class="search-modal-overlay"></div>
                <div class="search-modal-content">
                    <div class="search-modal-header">
                        <h2 class="search-modal-title" style="color: var(--text-primary); font-size: 1.25rem; font-weight: 600; margin: 0;">
                            üîç ${this.languageManager.get('search')}
                        </h2>
                        <button id="closeSearchModal" class="search-modal-close" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary); padding: 0.5rem;">√ó</button>
                    </div>

                    <div class="search-modal-body">
                        <div class="search-modal-layout">
                            <!-- Left Panel: Search Controls -->
                            <div class="search-left-panel">
                                <div class="search-controls-container">
                                    <!-- Search Input -->
                                    <div class="mb-4">
                                        <input type="text" id="modalSearchInput"
                                            placeholder="${this.languageManager.get('searchPlaceholder')}"
                                            class="w-full px-4 py-3 text-sm border rounded-lg"
                                            style="background-color: var(--bg-tertiary); color: var(--text-primary); border-color: var(--border-primary);">
                                    </div>

                                    <!-- Search Options -->
                                    <div class="mb-4">
                                        <div class="text-sm font-medium mb-3" style="color: var(--text-primary);">${this.languageManager.get('searchOptions')}</div>

                                        <div class="space-y-3 mb-4">
                                            <label class="flex items-center text-sm" style="color: var(--text-secondary);">
                                                <input type="checkbox" id="modalCaseSensitiveCheck" class="mr-2">
                                                ${this.languageManager.get('caseSensitive')}
                                            </label>
                                            <label class="flex items-center text-sm" style="color: var(--text-secondary);">
                                                <input type="checkbox" id="modalUseRegexCheck" class="mr-2">
                                                ${this.languageManager.get('useRegex')}
                                            </label>
                                            <label class="flex items-center text-sm" style="color: var(--text-secondary);">
                                                <input type="checkbox" id="modalIncludeFilenamesCheck" class="mr-2" checked>
                                                ${this.languageManager.get('includeFilenames')}
                                            </label>
                                        </div>

                                        <div class="text-sm mb-3" style="color: var(--text-primary);">${this.languageManager.get('searchScope')}</div>
                                        <div class="space-y-2">
                                            <label class="flex items-center text-sm" style="color: var(--text-secondary);">
                                                <input type="radio" name="modalSearchScope" value="current" id="modalSearchScopeCurrent" class="mr-2">
                                                ${this.languageManager.get('searchCurrentFile')}
                                            </label>
                                            <label class="flex items-center text-sm" style="color: var(--text-secondary);">
                                                <input type="radio" name="modalSearchScope" value="all" id="modalSearchScopeAll" class="mr-2" checked>
                                                ${this.languageManager.get('searchAllFiles')}
                                            </label>
                                        </div>
                                    </div>

                                    <!-- Search Actions -->
                                    <div class="search-actions">
                                        <button id="modalSearchBtn" class="w-full px-4 py-3 rounded text-sm transition-colors border-0 hover-scale mb-2" style="background-color: var(--button-primary); color: var(--text-inverse);">
                                            <span class="mr-1">üîç</span>
                                            <span id="modalSearchBtnText">${this.languageManager.get('search')}</span>
                                        </button>
                                        <button id="modalClearSearchBtn" class="w-full px-4 py-3 rounded text-sm transition-colors border-0 hover-scale" style="background-color: var(--button-secondary); color: var(--text-primary);">
                                            <span class="mr-1">üóëÔ∏è</span>
                                            <span>${this.languageManager.get('clearSearch')}</span>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Right Panel: Search Results -->
                            <div class="search-right-panel">
                                <search-results-viewer id="modalSearchResults"></search-results-viewer>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
            }

            attachEventListeners() {
                const browseBtn = this.shadowRoot.getElementById('browseBtn');
                const refreshBtn = this.shadowRoot.getElementById('refreshBtn');
                const expandBtn = this.shadowRoot.getElementById('expandAllBtn');
                const collapseBtn = this.shadowRoot.getElementById('collapseAllBtn');
                const resetBtn = this.shadowRoot.getElementById('resetBtn');
                const languageToggle = this.shadowRoot.getElementById('languageToggle');
                const themeToggle = this.shadowRoot.getElementById('themeToggle');

                // Modal search elements
                const modalCloseBtn = this.shadowRoot.getElementById('closeSearchModal');
                const modalOverlay = this.shadowRoot.querySelector('.search-modal-overlay');
                const modalSearchBtn = this.shadowRoot.getElementById('modalSearchBtn');
                const modalClearSearchBtn = this.shadowRoot.getElementById('modalClearSearchBtn');
                const modalSearchInput = this.shadowRoot.getElementById('modalSearchInput');
                const modalCaseSensitiveCheck = this.shadowRoot.getElementById('modalCaseSensitiveCheck');
                const modalUseRegexCheck = this.shadowRoot.getElementById('modalUseRegexCheck');
                const modalIncludeFilenamesCheck = this.shadowRoot.getElementById('modalIncludeFilenamesCheck');
                const modalSearchScopeCurrent = this.shadowRoot.getElementById('modalSearchScopeCurrent');
                const modalSearchScopeAll = this.shadowRoot.getElementById('modalSearchScopeAll');

                browseBtn.addEventListener('click', () => this.handleBrowse());
                refreshBtn.addEventListener('click', () => this.handleRefresh());
                expandBtn.addEventListener('click', () => this.handleExpandAll());
                collapseBtn.addEventListener('click', () => this.handleCollapseAll());
                resetBtn.addEventListener('click', () => this.handleReset());
                languageToggle.addEventListener('click', () => this.handleLanguageToggle());
                themeToggle.addEventListener('click', () => this.handleThemeToggle());

                // Modal event listeners
                modalCloseBtn.addEventListener('click', () => this.closeSearchModal());
                modalOverlay.addEventListener('click', () => this.closeSearchModal());

                // Modal search event listeners
                modalSearchBtn.addEventListener('click', () => this.handleModalSearch());
                modalClearSearchBtn.addEventListener('click', () => this.handleClearSearch());
                modalSearchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.handleModalSearch();
                    }
                });

                // Modal search options listeners
                modalCaseSensitiveCheck.addEventListener('change', () => this.updateModalSearchOptions());
                modalUseRegexCheck.addEventListener('change', () => this.updateModalSearchOptions());
                modalIncludeFilenamesCheck.addEventListener('change', () => this.updateModalSearchOptions());
                modalSearchScopeCurrent.addEventListener('change', () => this.updateModalSearchOptions());
                modalSearchScopeAll.addEventListener('change', () => this.updateModalSearchOptions());

                // Close modal on Escape key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        const modal = this.shadowRoot.getElementById('searchModal');
                        if (modal && modal.style.display === 'flex') {
                            this.closeSearchModal();
                        }
                    }
                });

                // Listen for language change events
                document.addEventListener('languageChanged', () => {
                    this.updateUI();
                });

                // Listen for theme change events
                document.addEventListener('themeChanged', (event) => {
                    this.handleThemeChanged(event.detail);
                });

                // Listen for search modal open event
                document.addEventListener('openSearchModal', () => {
                    this.openSearchModal();
                });

                // Listen for navigation events from search results
                document.addEventListener('navigateToFile', (event) => {
                    this.handleNavigateToFile(event.detail);
                });

                // Check browser support
                if (!('showDirectoryPicker' in window)) {
                    this.showBrowserNotSupported();
                }
            }

            async loadInitialState() {
                try {
                    const lastDirectoryData = await this.dataManager.getLastDirectoryHandle();
                    if (lastDirectoryData && lastDirectoryData.handle) {
                        await this.dataManager.setDirectoryHandle(lastDirectoryData.handle);
                        this.shadowRoot.getElementById('folderPath').value = lastDirectoryData.handle.name;

                        const permissionStatus = await lastDirectoryData.handle.queryPermission({ mode: 'read' });
                        if (permissionStatus === 'granted') {
                            await this.loadProject();
                        } else {
                            this.showInitialState();
                        }
                    } else {
                        this.showInitialState();
                    }
                } catch (error) {
                    console.log('Âä†ËΩΩÂàùÂßãÁä∂ÊÄÅÂ§±Ë¥•:', error);
                    this.showInitialState();
                }
            }

            async handleBrowse() {
                try {
                    const browseBtn = this.shadowRoot.getElementById('browseBtn');
                    const browseBtnIcon = browseBtn.querySelector('.mr-1');
                    const browseBtnText = this.shadowRoot.getElementById('browseBtnText');

                    browseBtnIcon.textContent = '‚è≥';
                    browseBtnText.textContent = this.languageManager.get('selectingButton');
                    browseBtn.disabled = true;

                    const directoryHandle = await window.showDirectoryPicker();
                    await this.dataManager.setDirectoryHandle(directoryHandle);

                    this.shadowRoot.getElementById('folderPath').value = directoryHandle.name;
                    await this.loadProject();

                    browseBtnIcon.textContent = 'üìÅ';
                    browseBtnText.textContent = this.languageManager.get('selectButton');
                    browseBtn.disabled = false;
                } catch (error) {
                    console.error('ÈÄâÊã©Êñá‰ª∂Â§πÊó∂Âá∫Èîô:', error);
                    if (error.name !== 'AbortError') {
                        alert(`${this.languageManager.get('folderSelectionError')}: ${error.message}`);
                    }

                    const browseBtn = this.shadowRoot.getElementById('browseBtn');
                    const browseBtnIcon = browseBtn.querySelector('.mr-1');
                    const browseBtnText = this.shadowRoot.getElementById('browseBtnText');

                    browseBtnIcon.textContent = 'üìÅ';
                    browseBtnText.textContent = this.languageManager.get('selectButton');
                    browseBtn.disabled = false;
                }
            }

            async handleRefresh() {
                const refreshBtn = this.shadowRoot.getElementById('refreshBtn');
                const refreshBtnIcon = refreshBtn.querySelector('.mr-1');
                const refreshBtnText = this.shadowRoot.getElementById('refreshBtnText');

                const originalIcon = refreshBtnIcon.textContent;
                const originalText = refreshBtnText.textContent;

                refreshBtnIcon.textContent = '‚è≥';
                refreshBtnText.textContent = this.languageManager.get('refreshingButton');
                refreshBtn.disabled = true;

                try {
                    const directoryHandle = this.dataManager.getDirectoryHandle();
                    if (directoryHandle) {
                        const permissionStatus = await directoryHandle.queryPermission({ mode: 'read' });
                        if (permissionStatus === 'granted') {
                            await this.loadProject();
                        } else {
                            alert(this.languageManager.get('directoryAccessExpired'));
                            this.showInitialState();
                        }
                    } else {
                        this.showInitialState();
                    }
                } catch (error) {
                    console.error('handleRefresh error:', error);
                    alert(`${this.languageManager.get('refreshError')}: ${error.message}`);
                } finally {
                    refreshBtnIcon.textContent = originalIcon;
                    refreshBtnText.textContent = originalText;
                    refreshBtn.disabled = false;
                }
            }

            handleExpandAll() {
                const fileBrowser = this.shadowRoot.querySelector('file-browser');
                if (fileBrowser) {
                    fileBrowser.expandAll();
                }
            }

            handleCollapseAll() {
                const fileBrowser = this.shadowRoot.querySelector('file-browser');
                if (fileBrowser) {
                    fileBrowser.collapseAll();
                }
            }

            async handleReset() {
                if (confirm(this.languageManager.get('resetConfirmation'))) {
                    await this.dataManager.reset();
                    this.shadowRoot.getElementById('folderPath').value = '';
                    this.showInitialState();
                }
            }

            getMessageViewer() {
                return this.shadowRoot.querySelector('message-viewer');
            }


            async loadProject() {
                try {
                    const directoryHandle = this.dataManager.getDirectoryHandle();
                    if (!directoryHandle) return;

                    // Show loading state
                    this.showProjectLoading();

                    // Load project data
                    await this.dataManager.loadProject();

                    // Update file browser
                    const fileBrowser = this.shadowRoot.querySelector('file-browser');
                    if (fileBrowser) {
                        fileBrowser.updateProject(this.dataManager.getProjectData());
                    }

                    // Show project overview
                    this.showProjectOverview();

                } catch (error) {
                    console.error('loadProject error:', error);
                    alert(`${this.languageManager.get('loadProjectError')}: ${error.message}`);
                }
            }

            showInitialState() {
                const messageViewer = this.shadowRoot.querySelector('message-viewer');
                if (messageViewer) {
                    messageViewer.showInitialState();
                }
            }

            showProjectLoading() {
                const messageViewer = this.shadowRoot.querySelector('message-viewer');
                if (messageViewer) {
                    messageViewer.showLoading();
                }
            }

            showProjectOverview() {
                const messageViewer = this.shadowRoot.querySelector('message-viewer');
                if (messageViewer) {
                    messageViewer.showProjectOverview(this.dataManager.getProjectData());
                }
            }

            handleLanguageToggle() {
                const currentLang = this.languageManager.getCurrentLanguage();
                const newLang = currentLang === 'zh-CN' ? 'en' : 'zh-CN';
                this.languageManager.setLanguage(newLang);
            }

            handleThemeToggle() {
                const newTheme = this.styleManager.toggleTheme();
                console.log('Theme toggled to:', newTheme);
            }

            handleThemeChanged(themeDetails) {
                // Update theme toggle button
                const themeToggleIcon = this.shadowRoot.getElementById('themeToggleIcon');

                if (themeToggleIcon) {
                    const themeInfo = this.styleManager.getThemeManager().getThemeInfo();
                    themeToggleIcon.textContent = themeInfo.icon;
                }

                // Update CSS variables in shadow DOM
                this.updateThemeVariables(themeDetails.colors);
            }

            async handleNavigateToFile(details) {
                try {
                    console.log('Navigating to file:', details);

                    // Close search modal first
                    this.closeSearchModal();

                    // Find the file in the file browser
                    const fileBrowser = this.shadowRoot.querySelector('file-browser');
                    if (fileBrowser && fileBrowser.dataManager) {
                        const projectData = fileBrowser.dataManager.getProjectData();

                        // Look for the file in all projects and track the project path
                        let targetFile = null;
                        let targetProjectPath = null;
                        for (const [path, project] of Object.entries(projectData.projects)) {
                            if (project.files) {
                                targetFile = project.files.find(f => f.name === details.file);
                                if (targetFile) {
                                    targetProjectPath = path;
                                    break;
                                }
                            }
                        }

                        if (targetFile && targetProjectPath) {
                            console.log('Found file:', targetFile.name, 'in project:', targetProjectPath);

                            // Expand the project tree to show the file
                            await this.expandToFile(targetFile, targetProjectPath, fileBrowser);

                            // Load the file content
                            await fileBrowser.loadFileContent(targetFile);

                            // Wait for the content to load, then navigate to the specific message
                            setTimeout(() => {
                                const messageViewer = this.shadowRoot.querySelector('message-viewer');
                                console.log('Message viewer found:', !!messageViewer);
                                console.log('Session ID:', details.sessionId, 'Message Index:', details.messageIndex);

                                if (messageViewer && details.sessionId !== null && details.messageIndex !== null) {
                                    // Find the session index in current file
                                    const currentSessions = fileBrowser.dataManager.projectData.currentFileSessions;
                                    const sessionIndex = currentSessions.indexOf(details.sessionId);

                                    console.log('Current sessions:', currentSessions);
                                    console.log('Target session index:', sessionIndex);

                                    if (sessionIndex !== -1) {
                                        // Switch to the correct session
                                        fileBrowser.dataManager.setCurrentSessionIndex(sessionIndex);

                                        // Show the session
                                        const session = fileBrowser.dataManager.projectData.sessions[details.sessionId];
                                        if (session) {
                                            messageViewer.showSession(session);

                                            // Navigate to the specific message after a short delay
                                            setTimeout(() => {
                                                // Highlight and scroll to the specific message
                                                const messageElements = messageViewer.shadowRoot.querySelectorAll('[data-message-index]');
                                                const targetMessageElement = Array.from(messageElements).find(
                                                    el => parseInt(el.dataset.messageIndex) === details.messageIndex
                                                );

                                                if (targetMessageElement) {
                                                    targetMessageElement.scrollIntoView({
                                                        behavior: 'smooth',
                                                        block: 'center'
                                                    });

                                                    // Add temporary highlight effect
                                                    targetMessageElement.style.backgroundColor = 'rgba(59, 130, 246, 0.1)';
                                                    targetMessageElement.style.border = '1px solid rgba(59, 130, 246, 0.3)';
                                                    setTimeout(() => {
                                                        targetMessageElement.style.backgroundColor = '';
                                                        targetMessageElement.style.border = '';
                                                    }, 2000);
                                                } else {
                                                    console.warn('Target message element not found');
                                                }
                                            }, 300);
                                        }
                                    }
                                } else {
                                    console.warn('Cannot navigate: missing message viewer or session details');
                                }
                            }, 500); // Give time for the file to load
                        } else {
                            console.warn('File not found:', details.file);
                            alert((this.languageManager.get('fileNotFound') || 'File not found') + ': ' + details.file);
                        }
                    } else {
                        console.error('File browser not found');
                    }
                } catch (error) {
                    console.error('Error navigating to file:', error);
                    alert(this.languageManager.get('navigationError') || 'Error navigating to file');
                }
            }

            async expandToFile(targetFile, projectPath, fileBrowser) {
                try {
                    console.log('Expanding to file:', targetFile.name, 'in project:', projectPath);

                    // Find and expand the project that contains the target file
                    const treeNodes = fileBrowser.shadowRoot.querySelectorAll('.claude-tree-node');
                    let targetProjectNode = null;

                    for (const node of treeNodes) {
                        const nodePath = node.dataset.path;
                        const nodeProjectName = node.dataset.projectName;
                        console.log('Checking node:', nodePath, nodeProjectName);

                        // Check if this node is our target project
                        if (nodePath === projectPath || nodeProjectName === targetFile.projectName) {
                            targetProjectNode = node;
                            console.log('Found target project node');
                            break;
                        }
                    }

                    if (targetProjectNode) {
                        // Expand the project
                        const toggle = targetProjectNode.querySelector('.claude-tree-toggle');
                        const children = targetProjectNode.querySelector('.claude-tree-children');

                        if (toggle && children) {
                            if (children.classList.contains('hidden')) {
                                toggle.innerHTML = '<span class="text-xs">‚ñº</span>';
                                children.classList.remove('hidden');
                                console.log('Expanded project node');
                            }

                            // Find and highlight the target file within this project
                            const fileElements = children.querySelectorAll('[data-file-name]');
                            let targetFileElement = null;

                            for (const fileElement of fileElements) {
                                console.log('Checking file:', fileElement.dataset.fileName);
                                if (fileElement.dataset.fileName === targetFile.name) {
                                    targetFileElement = fileElement.closest('.claude-file-item');
                                    break;
                                }
                            }

                            if (targetFileElement) {
                                console.log('Found target file element');

                                // Add selection state to the file
                                fileBrowser.shadowRoot.querySelectorAll('.claude-file-item').forEach(item => {
                                    if (item.classList.contains('claude-active-file')) {
                                        // Reset styles by removing the class
                                        item.classList.remove('claude-active-file');
                                        item.style.backgroundColor = '';
                                        item.style.border = '';
                                    }
                                });

                                targetFileElement.classList.add('claude-active-file');

                                // Add highlight effect
                                targetFileElement.style.backgroundColor = 'rgba(59, 130, 246, 0.1)';
                                targetFileElement.style.border = '1px solid rgba(59, 130, 246, 0.3)';

                                // Scroll to view
                                targetFileElement.scrollIntoView({
                                    behavior: 'smooth',
                                    block: 'center'
                                });

                                // Remove highlight after a delay but keep selection
                                setTimeout(() => {
                                    targetFileElement.style.backgroundColor = '';
                                    targetFileElement.style.border = '';
                                }, 3000);

                                console.log('Successfully highlighted target file');
                            } else {
                                console.warn('Target file element not found in children');
                                // Try global search as fallback
                                const allFileElements = fileBrowser.shadowRoot.querySelectorAll('[data-file-name]');
                                for (const fileElement of allFileElements) {
                                    if (fileElement.dataset.fileName === targetFile.name) {
                                        const parentFileItem = fileElement.closest('.claude-file-item');
                                        if (parentFileItem) {
                                            parentFileItem.classList.add('claude-active-file');
                                            parentFileItem.style.backgroundColor = 'rgba(59, 130, 246, 0.1)';
                                            parentFileItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                            setTimeout(() => {
                                                parentFileItem.style.backgroundColor = '';
                                            }, 3000);
                                            console.log('Found file via global search');
                                        }
                                        break;
                                    }
                                }
                            }
                        } else {
                            console.error('Toggle or children not found in project node');
                        }
                    } else {
                        console.error('Target project node not found');
                    }
                } catch (error) {
                    console.error('Error expanding to file:', error);
                }
            }

            // Search functionality methods
            updateModalSearchOptions() {
                const caseSensitive = this.shadowRoot.getElementById('modalCaseSensitiveCheck').checked;
                const useRegex = this.shadowRoot.getElementById('modalUseRegexCheck').checked;
                const includeFilenames = this.shadowRoot.getElementById('modalIncludeFilenamesCheck').checked;
                const searchScope = this.shadowRoot.querySelector('input[name="modalSearchScope"]:checked').value;

                window.searchManager.setSearchOptions({
                    caseSensitive,
                    useRegex,
                    includeFilenames,
                    searchScope
                });
            }

            async handleModalSearch() {
                const searchInput = this.shadowRoot.getElementById('modalSearchInput');
                const searchBtn = this.shadowRoot.getElementById('modalSearchBtn');
                const searchBtnText = this.shadowRoot.getElementById('modalSearchBtnText');
                const searchTerm = searchInput.value.trim();

                if (!searchTerm) {
                    return;
                }

                // Update UI to show searching state
                searchBtn.disabled = true;
                searchBtnText.textContent = this.languageManager.get('searching');

                try {
                    // Update search options before searching
                    this.updateModalSearchOptions();

                    // Perform search
                    const results = await window.searchManager.search(searchTerm);

                    // Dispatch search updated event
                    document.dispatchEvent(new CustomEvent('searchUpdated', {
                        detail: { results, searchTerm }
                    }));
                } catch (error) {
                    console.error('Search failed:', error);
                } finally {
                    // Restore UI state
                    searchBtn.disabled = false;
                    searchBtnText.textContent = this.languageManager.get('search');
                }
            }

            // Modal styles
            getModalStyles() {
                return `
                .search-modal {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    z-index: 1000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }

                .search-modal-overlay {
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.5);
                    backdrop-filter: blur(4px);
                }

                .search-modal-content {
                    position: relative;
                    width: 90%;
                    max-width: 1200px;
                    height: 85vh;
                    max-height: 85vh;
                    background-color: var(--bg-primary);
                    border-radius: 12px;
                    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
                    overflow: hidden;
                    border: 1px solid var(--border-primary);
                    display: flex;
                    flex-direction: column;
                }

                .search-modal-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 1rem 1.5rem;
                    border-bottom: 1px solid var(--border-primary);
                    background-color: var(--bg-secondary);
                    flex-shrink: 0;
                }

                .search-modal-body {
                    padding: 0;
                    overflow: hidden;
                    flex: 1;
                    display: flex;
                    flex-direction: column;
                }

                .search-modal-layout {
                    display: flex;
                    height: 100%;
                    overflow: hidden;
                }

                .search-left-panel {
                    width: 350px;
                    min-width: 350px;
                    flex-shrink: 0;
                    border-right: 1px solid var(--border-primary);
                    background-color: var(--bg-secondary);
                    overflow-y: auto;
                }

                .search-controls-container {
                    padding: 1.5rem;
                }

                .search-right-panel {
                    flex: 1;
                    overflow: hidden;
                    background-color: var(--bg-primary);
                }

                .space-y-3 > * + * {
                    margin-top: 0.75rem;
                }

                .space-y-2 > * + * {
                    margin-top: 0.5rem;
                }

                .search-modal-close:hover {
                    color: var(--text-primary);
                    background-color: var(--bg-tertiary);
                    border-radius: 0.375rem;
                }

                .search-modal-close:focus {
                    outline: 2px solid var(--button-primary);
                    outline-offset: 2px;
                }

                @media (max-width: 768px) {
                    .search-modal-content {
                        width: 95%;
                        height: 90vh;
                        max-height: 90vh;
                        margin: 1rem;
                    }

                    .search-modal-layout {
                        flex-direction: column;
                    }

                    .search-left-panel {
                        width: 100%;
                        min-width: unset;
                        border-right: none;
                        border-bottom: 1px solid var(--border-primary);
                        max-height: 50vh;
                    }

                    .search-right-panel {
                        flex: 1;
                        min-height: 0;
                    }

                    .search-modal-header {
                        padding: 0.75rem 1rem;
                    }

                    .search-controls-container {
                        padding: 1rem;
                    }
                }
                `;
            }

        // Modal functionality
            openSearchModal() {
                const modal = this.shadowRoot.getElementById('searchModal');
                modal.style.display = 'flex';
                // Focus on input after modal opens
                setTimeout(() => {
                    const input = this.shadowRoot.getElementById('modalSearchInput');
                    if (input) {
                        input.focus();
                    }
                }, 100);
            }

            closeSearchModal() {
                const modal = this.shadowRoot.getElementById('searchModal');
                modal.style.display = 'none';
            }

            handleClearSearch() {
                const searchInput = this.shadowRoot.getElementById('modalSearchInput');
                if (searchInput) {
                    searchInput.value = '';
                }

                // Clear search results
                window.searchManager.clearSearch();

                // Dispatch search updated event
                document.dispatchEvent(new CustomEvent('searchUpdated', {
                    detail: { results: [], searchTerm: '' }
                }));
            }

            updateThemeVariables(colors) {
                const style = document.createElement('style');
                style.textContent = `
                    :host {
                        --bg-primary: ${colors.bg.primary};
                        --bg-secondary: ${colors.bg.secondary};
                        --bg-tertiary: ${colors.bg.tertiary};
                        --bg-quaternary: ${colors.bg.quaternary};

                        --text-primary: ${colors.text.primary};
                        --text-secondary: ${colors.text.secondary};
                        --text-tertiary: ${colors.text.tertiary};
                        --text-quaternary: ${colors.text.quaternary};
                        --text-inverse: ${colors.text.inverse};

                        --border-primary: ${colors.border.primary};
                        --border-secondary: ${colors.border.secondary};
                        --border-tertiary: ${colors.border.tertiary};

                        --button-primary: ${colors.button.primary};
                        --button-primary-hover: ${colors.button.primaryHover};
                        --button-secondary: ${colors.button.secondary};
                        --button-secondary-hover: ${colors.button.secondaryHover};

                        --shadow-color: ${colors.bg.primary === '#ffffff' ? 'rgba(0, 0, 0, 0.1)' : 'rgba(0, 0, 0, 0.3)'};
                    }
                `;

                // Remove old theme style if exists
                const oldStyle = this.shadowRoot.getElementById('theme-style');
                if (oldStyle) {
                    oldStyle.remove();
                }

                style.id = 'theme-style';
                this.shadowRoot.appendChild(style);
            }

            updateUI() {
                // Update page title
                document.title = this.languageManager.get('appTitle');

                // Update main app UI elements
                this.shadowRoot.getElementById('projectFolderTitle').textContent = this.languageManager.get('projectFolder');
                this.shadowRoot.getElementById('folderPath').placeholder = this.languageManager.get('selectFolderPlaceholder');
                this.shadowRoot.getElementById('browseBtnText').textContent = this.languageManager.get('selectButton');
                this.shadowRoot.getElementById('refreshBtnText').textContent = this.languageManager.get('refreshButton');
                this.shadowRoot.getElementById('expandAllBtnText').textContent = this.languageManager.get('expandAllButton');
                this.shadowRoot.getElementById('collapseAllBtnText').textContent = this.languageManager.get('collapseAllButton');
                this.shadowRoot.getElementById('resetBtnText').textContent = this.languageManager.get('resetButton');

                // Update browser support info
                const supportInfo = this.shadowRoot.querySelector('.mt-2 p');
                if (supportInfo) {
                    supportInfo.innerHTML = `<span class="mr-1">‚ÑπÔ∏è</span>${this.languageManager.get('browserSupportInfo')}`;
                }

                // Update language toggle button
                const languageToggle = this.shadowRoot.getElementById('languageToggle');
                languageToggle.textContent = this.languageManager.getCurrentLanguage() === 'zh-CN' ? 'üåê ‰∏≠Êñá' : 'üåê English';

                // Update other components
                const fileBrowser = this.shadowRoot.querySelector('file-browser');
                if (fileBrowser) {
                    fileBrowser.updateLanguage();
                }

                const messageViewer = this.shadowRoot.querySelector('message-viewer');
                if (messageViewer) {
                    messageViewer.updateLanguage();
                }
            }

            showBrowserNotSupported() {
                const browseBtn = this.shadowRoot.getElementById('browseBtn');
                const browseBtnIcon = browseBtn.querySelector('.mr-1');
                const browseBtnText = this.shadowRoot.getElementById('browseBtnText');

                browseBtn.disabled = true;
                browseBtnIcon.textContent = '‚ö†Ô∏è';
                browseBtnText.textContent = this.languageManager.get('browserNotSupportedButton');
                alert(this.languageManager.get('browserNotSupported'));
            }
        }



        // Theme management component
        class ThemeManager {
            constructor() {
                this.currentTheme = localStorage.getItem('claude-viewer-theme') || 'light';
                this.themes = {
                    light: {
                        name: 'Light',
                        icon: '‚òÄÔ∏è',
                        colors: {
                            bg: {
                                primary: '#ffffff',
                                secondary: '#f9fafb',
                                tertiary: '#f3f4f6',
                                quaternary: '#e5e7eb'
                            },
                            text: {
                                primary: '#111827',
                                secondary: '#374151',
                                tertiary: '#6b7280',
                                quaternary: '#9ca3af',
                                inverse: '#ffffff'
                            },
                            border: {
                                primary: '#e5e7eb',
                                secondary: '#d1d5db',
                                tertiary: '#9ca3af'
                            },
                            button: {
                                primary: '#3b82f6',
                                primaryHover: '#2563eb',
                                secondary: '#f3f4f6',
                                secondaryHover: '#e5e7eb'
                            }
                        }
                    },
                    dark: {
                        name: 'Dark',
                        icon: 'üåô',
                        colors: {
                            bg: {
                                primary: '#1f2937',
                                secondary: '#111827',
                                tertiary: '#374151',
                                quaternary: '#4b5563'
                            },
                            text: {
                                primary: '#f9fafb',
                                secondary: '#e5e7eb',
                                tertiary: '#d1d5db',
                                quaternary: '#9ca3af',
                                inverse: '#111827'
                            },
                            border: {
                                primary: '#374151',
                                secondary: '#4b5563',
                                tertiary: '#6b7280'
                            },
                            button: {
                                primary: '#3b82f6',
                                primaryHover: '#60a5fa',
                                secondary: '#374151',
                                secondaryHover: '#4b5563'
                            }
                        }
                    }
                };
            }

            getCurrentTheme() {
                return this.currentTheme;
            }

            setTheme(theme) {
                if (this.themes[theme]) {
                    this.currentTheme = theme;
                    localStorage.setItem('claude-viewer-theme', theme);
                    document.documentElement.setAttribute('data-theme', theme);

                    // Dispatch theme change event
                    document.dispatchEvent(new CustomEvent('themeChanged', {
                        detail: { theme, colors: this.themes[theme].colors }
                    }));
                }
            }

            toggleTheme() {
                const newTheme = this.currentTheme === 'light' ? 'dark' : 'light';
                this.setTheme(newTheme);
                return newTheme;
            }

            getColors() {
                return this.themes[this.currentTheme].colors;
            }

            getThemeInfo() {
                return this.themes[this.currentTheme];
            }

            // Generate dynamic CSS variables based on current theme
            generateThemeCSS() {
                const colors = this.getColors();
                return `
                    :root {
                        --bg-primary: ${colors.bg.primary};
                        --bg-secondary: ${colors.bg.secondary};
                        --bg-tertiary: ${colors.bg.tertiary};
                        --bg-quaternary: ${colors.bg.quaternary};

                        --text-primary: ${colors.text.primary};
                        --text-secondary: ${colors.text.secondary};
                        --text-tertiary: ${colors.text.tertiary};
                        --text-quaternary: ${colors.text.quaternary};
                        --text-inverse: ${colors.text.inverse};

                        --border-primary: ${colors.border.primary};
                        --border-secondary: ${colors.border.secondary};
                        --border-tertiary: ${colors.border.tertiary};

                        --button-primary: ${colors.button.primary};
                        --button-primary-hover: ${colors.button.primaryHover};
                        --button-secondary: ${colors.button.secondary};
                        --button-secondary-hover: ${colors.button.secondaryHover};

                        --shadow-color: rgba(0, 0, 0, 0.1);
                        --transition-duration: 300ms;
                    }

                    [data-theme="dark"] {
                        --shadow-color: rgba(0, 0, 0, 0.3);
                    }

                    /* Smooth transitions for theme switching */
                    * {
                        transition: background-color var(--transition-duration) ease,
                                    color var(--transition-duration) ease,
                                    border-color var(--transition-duration) ease,
                                    box-shadow var(--transition-duration) ease;
                    }

                    /* Prevent transitions on initial load */
                    .no-transition * {
                        transition: none !important;
                    }
                `;
            }
        }

        // Central style management component
        class StyleManager {
            constructor() {
                this.themeManager = new ThemeManager();
                this.styles = {
                    app: this.generateAppStyles(),
                    fileBrowser: this.generateFileBrowserStyles(),
                    messageViewer: this.generateMessageViewerStyles(),
                };
            }

            generateTailwindStyles() {
                return `
                /* Theme CSS Variables */
                ${this.themeManager.generateThemeCSS()}

                /* Tailwind CSS styles */
                * { box-sizing: border-box; }

                /* Layout */
                .grid { display: grid; }
                .flex { display: flex; }
                .flex-col { flex-direction: column; }
                .flex-row { flex-direction: row; }
                .flex-1 { flex: 1 1 0%; }
                .flex-wrap { flex-wrap: wrap; }
                .items-center { align-items: center; }
                .items-start { align-items: flex-start; }
                .justify-center { justify-content: center; }
                .justify-between { justify-content: space-between; }
                .justify-end { justify-content: flex-end; }

                /* Spacing */
                .gap-2 { gap: 0.5rem; }
                .gap-4 { gap: 1rem; }
                .gap-6 { gap: 1.5rem; }
                .space-x-2 > * + * { margin-left: 0.5rem; }
                .space-y-2 > * + * { margin-top: 0.5rem; }
                .space-y-3 > * + * { margin-top: 0.75rem; }
                .space-y-4 > * + * { margin-top: 1rem; }

                /* Sizing */
                .w-full { width: 100%; }
                .w-2\/5 { width: 40%; }
                .w-3\/5 { width: 60%; }
                .w-4 { width: 1rem; }
                .w-8 { width: 2rem; }
                .h-full { height: 100%; }
                .h-8 { height: 2rem; }
                .h-32 { height: 8rem; }
                .h-48 { height: 12rem; }
                .min-h-screen { min-height: 100vh; }
                .min-w-max { min-width: max-content; }

                /* Padding */
                .p-2 { padding: 0.5rem; }
                .p-3 { padding: 0.75rem; }
                .p-4 { padding: 1rem; }
                .p-6 { padding: 1.5rem; }
                .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
                .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
                .px-4 { padding-left: 1rem; padding-right: 1rem; }
                .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
                .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
                .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }

                /* Margin */
                .m-0 { margin: 0; }
                .m-4 { margin: 1rem; }
                .mx-auto { margin-left: auto; margin-right: auto; }
                .mb-1 { margin-bottom: 0.25rem; }
                .mb-2 { margin-bottom: 0.5rem; }
                .mb-3 { margin-bottom: 0.75rem; }
                .mb-4 { margin-bottom: 1rem; }
                .mb-6 { margin-bottom: 1.5rem; }
                .mb-8 { margin-bottom: 2rem; }
                .mr-1 { margin-right: 0.25rem; }
                .mr-2 { margin-right: 0.5rem; }
                .ml-1 { margin-left: 0.25rem; }
                .ml-2 { margin-left: 0.5rem; }
                .ml-4 { margin-left: 1rem; }
                .ml-6 { margin-left: 1.5rem; }
                .ml-auto { margin-left: auto; }
                .mt-1 { margin-top: 0.25rem; }
                .mt-2 { margin-top: 0.5rem; }
                .mt-4 { margin-top: 1rem; }

                /* Typography */
                .text-xs { font-size: 0.75rem; line-height: 1rem; }
                .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
                .text-base { font-size: 1rem; line-height: 1.5rem; }
                .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
                .text-xl { font-size: 1.25rem; line-height: 1.75rem; }
                .text-2xl { font-size: 1.5rem; line-height: 2rem; }
                .text-3xl { font-size: 1.875rem; line-height: 2.25rem; }
                .text-4xl { font-size: 2.25rem; line-height: 2.5rem; }
                .text-5xl { font-size: 3rem; line-height: 1; }

                .font-medium { font-weight: 500; }
                .font-semibold { font-weight: 600; }
                .font-bold { font-weight: 700; }

                .text-center { text-align: center; }
                .text-left { text-align: left; }
                .text-right { text-align: right; }

                /* Colors - Text */
                .text-white { color: white; }
                .text-gray-400 { color: #9ca3af; }
                .text-gray-500 { color: #6b7280; }
                .text-gray-600 { color: #4b5563; }
                .text-gray-700 { color: #374151; }
                .text-gray-800 { color: #1f2937; }
                .text-gray-900 { color: #111827; }
                .text-blue-500 { color: #3b82f6; }
                .text-blue-600 { color: #2563eb; }
                .text-blue-700 { color: #1d4ed8; }
                .text-blue-800 { color: #1e40af; }
                .text-green-500 { color: #10b981; }
                .text-green-600 { color: #059669; }
                .text-red-500 { color: #ef4444; }
                .text-red-600 { color: #dc2626; }
                .text-yellow-500 { color: #eab308; }
                .text-yellow-600 { color: #ca8a04; }
                .text-purple-500 { color: #8b5cf6; }
                .text-purple-600 { color: #7c3aed; }
                .text-pink-500 { color: #ec4899; }
                .text-indigo-500 { color: #6366f1; }
                .text-orange-500 { color: #f97316; }
                .text-teal-500 { color: #14b8a6; }
                .text-cyan-500 { color: #06b6d4; }
                .text-lime-500 { color: #84cc16; }
                .text-amber-500 { color: #f59e0b; }
                .text-emerald-500 { color: #10b981; }
                .text-violet-500 { color: #8b5cf6; }
                .text-fuchsia-500 { color: #d946ef; }
                .text-rose-500 { color: #f43f5e; }
                .text-sky-500 { color: #0ea5e9; }

                /* Colors - Background */
                .bg-white { background-color: white; }
                .bg-gray-50 { background-color: #f9fafb; }
                .bg-gray-100 { background-color: #f3f4f6; }
                .bg-gray-200 { background-color: #e5e7eb; }
                .bg-gray-800 { background-color: #1f2937; }
                .bg-blue-50 { background-color: #eff6ff; }
                .bg-blue-100 { background-color: #dbeafe; }
                .bg-blue-500 { background-color: #3b82f6; }
                .bg-blue-600 { background-color: #2563eb; }
                .bg-green-50 { background-color: #f0fdf4; }
                .bg-green-100 { background-color: #dcfce7; }
                .bg-green-500 { background-color: #10b981; }
                .bg-red-50 { background-color: #fef2f2; }
                .bg-red-100 { background-color: #fee2e2; }
                .bg-red-500 { background-color: #ef4444; }
                .bg-yellow-50 { background-color: #fefce8; }
                .bg-yellow-100 { background-color: #fef3c7; }
                .bg-purple-50 { background-color: #faf5ff; }
                .bg-purple-100 { background-color: #f3e8ff; }
                .bg-pink-50 { background-color: #fdf2f8; }
                .bg-pink-100 { background-color: #fce7f3; }
                .bg-indigo-50 { background-color: #eef2ff; }
                .bg-indigo-100 { background-color: #e0e7ff; }
                .bg-orange-50 { background-color: #fff7ed; }
                .bg-orange-100 { background-color: #ffedd5; }
                .bg-teal-50 { background-color: #f0fdfa; }
                .bg-teal-100 { background-color: #ccfbf1; }
                .bg-cyan-50 { background-color: #ecfeff; }
                .bg-cyan-100 { background-color: #cffafe; }
                .bg-lime-50 { background-color: #f7fee7; }
                .bg-lime-100 { background-color: #ecfccb; }
                .bg-amber-50 { background-color: #fffbeb; }
                .bg-amber-100 { background-color: #fef3c7; }
                .bg-emerald-50 { background-color: #ecfdf5; }
                .bg-emerald-100 { background-color: #d1fae5; }
                .bg-violet-50 { background-color: #f5f3ff; }
                .bg-violet-100 { background-color: #ede9fe; }
                .bg-fuchsia-50 { background-color: #fdf4ff; }
                .bg-fuchsia-100 { background-color: #fae8ff; }
                .bg-rose-50 { background-color: #fff1f2; }
                .bg-rose-100 { background-color: #ffe4e6; }
                .bg-sky-50 { background-color: #f0f9ff; }
                .bg-sky-100 { background-color: #e0f2fe; }

                /* Borders */
                .border { border-width: 1px; }
                .border-0 { border-width: 0; }
                .border-2 { border-width: 2px; }
                .border-t { border-top-width: 1px; }
                .border-b { border-bottom-width: 1px; }
                .border-l-4 { border-left-width: 4px; }

                /* Button borders - removed */
                .border-transparent { border-color: transparent; }
                .border-gray-200 { border-color: #e5e7eb; }
                .border-gray-300 { border-color: #d1d5db; }
                .border-blue-300 { border-color: #93c5fd; }
                .border-blue-500 { border-color: #3b82f6; }
                .border-green-300 { border-color: #86efac; }
                .border-green-500 { border-color: #10b981; }
                .border-red-300 { border-color: #fca5a5; }
                .border-yellow-300 { border-color: #fde047; }
                .border-yellow-500 { border-color: #eab308; }
                .border-purple-300 { border-color: #d8b4fe; }
                .border-purple-500 { border-color: #8b5cf6; }

                .rounded { border-radius: 0.25rem; }
                .rounded-lg { border-radius: 0.5rem; }
                .rounded-xl { border-radius: 0.75rem; }
                .rounded-full { border-radius: 9999px; }

                /* Effects */
                .shadow { box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); }
                .shadow-md { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
                .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }

                /* Interactivity */
                .cursor-pointer { cursor: pointer; }
                .cursor-not-allowed { cursor: not-allowed; }

                .opacity-50 { opacity: 0.5; }
                .opacity-100 { opacity: 1; }

                .hidden { display: none; }
                .block { display: block; }
                .inline-block { display: inline-block; }

                .overflow-hidden { overflow: hidden; }
                .overflow-y-auto { overflow-y: auto; }
                .overflow-x-auto { overflow-x: auto; }

                .truncate { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
                .whitespace-nowrap { white-space: nowrap; }
                .whitespace-pre { white-space: pre; }
                .whitespace-pre-wrap { white-space: pre-wrap; }
                .break-words { overflow-wrap: break-word; }

                .resize-none { resize: none; }
                .outline-none { outline: 2px solid transparent; outline-offset: 2px; }

                /* Transitions */
                .transition { transition-property: color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
                .transition-all { transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
                .transition-colors { transition-property: color, background-color, border-color, text-decoration-color, fill, stroke; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
                .duration-200 { transition-duration: 200ms; }
                .duration-300 { transition-duration: 300ms; }
                .ease-in-out { transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); }
                .ease-out { transition-timing-function: cubic-bezier(0, 0, 0.2, 1); }

                /* Transform */
                .transform { transform: translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y)); }
                .translate-y-2 { --tw-translate-y: 0.5rem; }
                .-translate-y-2 { --tw-translate-y: -0.5rem; }

                /* Hover states */
                .hover\\:bg-blue-600:hover { background-color: #2563eb; }
                .hover\\:bg-green-600:hover { background-color: #059669; }
                .hover\\:bg-red-600:hover { background-color: #dc2626; }
                .hover\\:bg-gray-50:hover { background-color: #f9fafb; }
                .hover\\:bg-gray-100:hover { background-color: #f3f4f6; }
                .hover\\:bg-gray-200:hover { background-color: #e5e7eb; }
                .hover\\:border-gray-300:hover { border-color: #d1d5db; }
                .hover\\:border-blue-300:hover { border-color: #93c5fd; }
                .hover\\:text-gray-900:hover { color: #111827; }
                .hover\\:text-white:hover { color: white; }
                .hover\\:shadow-lg:hover { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
                .hover\\:scale-105:hover { transform: scale(1.05); }

                /* Focus states */
                .focus\\:ring-2:focus { --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color); --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color); box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000); }
                .focus\\:ring-blue-500:focus { --tw-ring-opacity: 1; --tw-ring-color: rgb(59 130 246 / var(--tw-ring-opacity)); }
                .focus\\:outline-none:focus { outline: 2px solid transparent; outline-offset: 2px; }

                /* Disabled states */
                .disabled\\:opacity-50:disabled { opacity: 0.5; }
                .disabled\\:cursor-not-allowed:disabled { cursor: not-allowed; }

                /* Group states */
                .group:hover .group-hover\\:opacity-100 { opacity: 1; }
                .group:hover .group-hover\\:visible { visibility: visible; }

                /* Accessibility */
                .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }

                /* Grid */
                .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
                .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }

                /* Responsive breakpoints */
                @media (min-width: 768px) {
                    .md\\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
                }

                @media (min-width: 1024px) {
                    .lg\\:flex-row { flex-direction: row; }
                    .lg\\:w-2\\/5 { width: 40%; }
                    .lg\\:w-3\\/5 { width: 60%; }
                }
            `;
            }

            generateAppStyles() {
                return `
            html, body {
                background-color: var(--bg-secondary);
                color: var(--text-primary);
                margin: 0;
                padding: 0;
                height: 100%;
                width: 100%;
                overflow: hidden;
                transition: background-color var(--transition-duration) ease,
                           color var(--transition-duration) ease;
            }

            .claude-app-container {
                height: 100vh;
                width: 100vw;
                background-color: var(--bg-secondary);
                color: var(--text-primary);
                padding: 1rem;
                overflow: hidden;
            }

            .claude-left-panel {
                height: calc(100vh - 2rem);
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }

            .claude-right-panel {
                height: calc(100vh - 2rem);
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }

            .claude-right-panel::-webkit-scrollbar {
                width: 12px;
            }

            .claude-right-panel::-webkit-scrollbar-track {
                background: var(--bg-secondary);
                border-radius: 4px;
            }

            .claude-right-panel::-webkit-scrollbar-thumb {
                background: var(--border-tertiary);
                border-radius: 4px;
            }

            .claude-right-panel::-webkit-scrollbar-thumb:hover {
                background: #94a3b8;
            }

            /* Responsive adjustments */
            @media (max-width: 768px) {
                .claude-app-container {
                    padding: 0.5rem;
                }

                .claude-left-panel,
                .claude-right-panel {
                    height: calc(100vh - 1rem);
                }
            }

            @media (max-width: 640px) {
                .claude-app-container {
                    padding: 0.25rem;
                }

                .claude-left-panel,
                .claude-right-panel {
                    height: calc(100vh - 0.5rem);
                }
            }

            /* Hover styles for buttons */
            .hover-scale:hover {
                transform: scale(1.02);
                box-shadow: var(--shadow-color) 0 4px 6px -1px, var(--shadow-color) 0 2px 4px -1px;
            }

            button[style*="background-color: var(--button-secondary)"]:hover {
                background-color: var(--button-secondary-hover) !important;
            }

            button[style*="background-color: var(--button-primary)"]:hover {
                background-color: var(--button-primary-hover) !important;
            }

            button[style*="background-color: #dc2626"]:hover {
                background-color: #b91c1c !important;
            }

            /* Ensure message viewer has proper height */
            message-viewer {
                display: block;
                height: 100%;
                flex: 1;
            }

            #conversationDetail {
                display: flex;
                flex-direction: column;
            }

            #initialState {
                display: flex;
                flex-direction: column;
            }
        `;
            }

            generateFileBrowserStyles() {
                return `
            .claude-file-browser-container {
                background-color: var(--bg-primary);
                border: 1px solid var(--border-primary);
                border-radius: 0.75rem;
                box-shadow: var(--shadow-color) 0 4px 6px -1px, var(--shadow-color) 0 2px 4px -1px;
                flex: 1;
                display: flex;
                flex-direction: column;
                min-height: calc(100vh - 17rem);
                overflow-y: auto; 
                scrollbar-color: rgba(156, 163, 175, 0.3) transparent;
                height: 100%;
                max-height: calc(100vh - 17rem);
            }

            .claude-file-browser-container::-webkit-scrollbar {
                width: 14px;
            }

            .claude-file-browser-container::-webkit-scrollbar-track {
                background: transparent;
                border-radius: 4px;
            }

            .claude-file-browser-container::-webkit-scrollbar-thumb {
                background: rgba(156, 163, 175, 0.3);
                border-radius: 4px;
                transition: background-color 0.2s ease;
            }

            .claude-file-browser-container::-webkit-scrollbar-thumb:hover {
                background: rgba(156, 163, 175, 0.5);
            }

            [data-theme="dark"] .claude-file-browser-container::-webkit-scrollbar-thumb {
                background: rgba(107, 114, 128, 0.4);
            }

            [data-theme="dark"] .claude-file-browser-container::-webkit-scrollbar-thumb:hover {
                background: rgba(107, 114, 128, 0.6);
            }

            .claude-file-tree {
                overflow-y: auto;
                overflow-x: hidden;
                flex: 1;
                min-height: 0;
                max-height: 100%;
                background-color: var(--bg-primary);
                border-radius: 0.75rem;
                padding: 0.75rem; 
                scrollbar-color: rgba(156, 163, 175, 0.3) transparent;
                height: 100%;
            }

            .claude-file-tree::-webkit-scrollbar {
                width: 12px;
            }

            .claude-file-tree::-webkit-scrollbar-track {
                background: transparent;
                border-radius: 3px;
            }

            .claude-file-tree::-webkit-scrollbar-thumb {
                background: rgba(156, 163, 175, 0.3);
                border-radius: 3px;
                transition: background-color 0.2s ease;
            }

            .claude-file-tree::-webkit-scrollbar-thumb:hover {
                background: rgba(156, 163, 175, 0.5);
            }

            [data-theme="dark"] .claude-file-tree::-webkit-scrollbar-thumb {
                background: rgba(107, 114, 128, 0.4);
            }

            [data-theme="dark"] .claude-file-tree::-webkit-scrollbar-thumb:hover {
                background: rgba(107, 114, 128, 0.6);
            }

      
            .claude-tree-node {
                position: relative;
            }

            .claude-tree-children {
                margin-left: 1.5rem;
            }

            .claude-tree-toggle {
                width: 16px;
                height: 16px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                margin-right: 4px;
                border-radius: 2px;
                transition: all 0.2s;
                color: var(--text-secondary);
            }

            .claude-tree-toggle:hover {
                background-color: var(--bg-tertiary);
                color: var(--text-primary);
            }

            .claude-file-item {
                transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
                color: var(--text-primary);
                border-radius: 0.5rem;
                padding: 0.5rem 0.625rem;
                margin: 0.125rem 0;
                border: 1px solid transparent;
                position: relative;
                cursor: pointer;
            }

            .claude-file-item:hover {
                background-color: var(--bg-tertiary);
                border-color: rgba(59, 130, 246, 0.1);
                transform: translateX(1px);
            }

            .claude-file-item:active {
                transform: translateX(0) scale(0.98);
            }

            /* Improve folder icon visibility */
            .claude-file-item .folder-icon {
                transition: all 0.25s ease;
            }

            .claude-active-file .folder-icon {
                color: #ffffff !important;
                filter: drop-shadow(0 1px 1px rgba(0, 0, 0, 0.2));
            }

            /* Ensure text readability in active state */
            .claude-active-file {
                color: #ffffff !important;
            }

            .claude-active-file > div:first-child {
                color: #ffffff !important;
            }

            .claude-active-file .file-icon,
            .claude-active-file .folder-icon {
                color: #ffffff !important;
                filter: drop-shadow(0 1px 1px rgba(0, 0, 0, 0.2));
            }

            .claude-active-file .font-medium {
                color: #ffffff !important;
                font-weight: 600 !important;
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            }

            .claude-active-file .claude-file-preview {
                color: rgba(255, 255, 255, 0.9) !important;
                font-weight: 400 !important;
            }

            /* For project elements */
            .claude-file-item.claude-active-file .text-sm {
                color: #ffffff !important;
                font-weight: 500 !important;
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            }

            /* Force override inline styles for project names */
            .claude-file-item.claude-active-file .text-sm[style*="color: var(--text-primary)"] {
                color: #ffffff !important;
            }

            [data-theme="light"] .claude-file-item.claude-active-file .text-sm[style*="color: var(--text-primary)"] {
                color: #ffffff !important;
            }

            [data-theme="dark"] .claude-file-item.claude-active-file .text-sm[style*="color: var(--text-primary)"] {
                color: #ffffff !important;
            }

            /* Override file date inline styles */
            .claude-active-file .font-medium[style*="color: var(--text-secondary)"] {
                color: #ffffff !important;
            }

            /* Global override for any text inside active file items */
            .claude-active-file * {
                color: #ffffff !important;
            }

            /* But restore preview text opacity */
            .claude-active-file .claude-file-preview {
                color: rgba(255, 255, 255, 0.9) !important;
            }

            /* Make sure icons are visible */
            .claude-active-file .file-icon,
            .claude-active-file .folder-icon {
                color: #ffffff !important;
                filter: brightness(1.2) drop-shadow(0 1px 1px rgba(0, 0, 0, 0.3));
            }

            /* Responsive adjustments */
            @media (max-width: 768px) {
                .claude-file-item {
                    padding: 0.4375rem 0.5rem;
                    margin: 0.0625rem 0;
                }

                .claude-active-file::before {
                    left: -6px;
                    width: 3px;
                    height: 16px;
                }

                .claude-active-file {
                    transform: translateX(1px);
                }

                .claude-active-file:hover {
                    transform: translateX(2px);
                }
            }

            /* Focus styles for accessibility */
            .claude-file-item:focus-visible {
                outline: 2px solid #3b82f6;
                outline-offset: 2px;
                border-radius: 0.5rem;
            }

            [data-theme="dark"] .claude-file-item:focus-visible {
                outline-color: #60a5fa;
            }

            /* Add subtle animation for selection changes */
            @keyframes file-select {
                0% {
                    transform: translateX(0) scale(1);
                }
                50% {
                    transform: translateX(3px) scale(1.02);
                }
                100% {
                    transform: translateX(2px) scale(1);
                }
            }

            .claude-file-item.claude-active-file {
                animation: file-select 0.3s ease-out;
            }

            /* Improve contrast for light theme */
            [data-theme="light"] .claude-active-file {
                background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
                border-color: #1e40af;
                box-shadow: 0 3px 10px rgba(37, 99, 235, 0.35), 0 1px 3px rgba(0, 0, 0, 0.12);
            }

            [data-theme="light"] .claude-active-file::before {
                background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
                box-shadow: 0 2px 6px rgba(30, 64, 175, 0.4);
            }

            [data-theme="light"] .claude-active-file:hover {
                background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
                box-shadow: 0 5px 15px rgba(30, 64, 175, 0.4), 0 2px 4px rgba(0, 0, 0, 0.15);
            }

            .claude-active-file {
                background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                color: #ffffff;
                border: 1px solid #2563eb;
                box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3), 0 1px 3px rgba(0, 0, 0, 0.1);
                position: relative;
                font-weight: 500;
                transform: translateX(2px);
            }

            .claude-active-file::before {
                content: '';
                position: absolute;
                left: -8px;
                top: 50%;
                transform: translateY(-50%);
                width: 4px;
                height: 20px;
                background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
                border-radius: 0 2px 2px 0;
                box-shadow: 0 2px 4px rgba(59, 130, 246, 0.4);
            }

            .claude-active-file:hover {
                background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
                box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4), 0 2px 4px rgba(0, 0, 0, 0.15);
                transform: translateX(3px);
            }

            [data-theme="dark"] .claude-active-file {
                background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                border-color: #3b82f6;
                box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4), 0 1px 3px rgba(0, 0, 0, 0.3);
            }

            [data-theme="dark"] .claude-active-file::before {
                background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
                box-shadow: 0 2px 4px rgba(96, 165, 250, 0.5);
            }

            [data-theme="dark"] .claude-active-file:hover {
                background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
                box-shadow: 0 4px 12px rgba(37, 99, 235, 0.5), 0 2px 4px rgba(0, 0, 0, 0.4);
            }

            .claude-file-preview {
                max-height: 3.6rem;
                overflow: hidden;
                display: -webkit-box;
                -webkit-box-orient: vertical;
                -webkit-line-clamp: 3;
                line-clamp: 3;
                color: var(--text-tertiary);
                font-size: 0.75rem;
                line-height: 1.2rem;
            }

            .claude-loading-spinner {
                border: 3px solid var(--bg-tertiary);
                border-top: 3px solid var(--button-primary);
                border-radius: 50%;
                width: 30px;
                height: 30px;
                animation: claude-spin 1s linear infinite;
                margin: 0 auto;
            }

            .loading-spinner {
                border: 3px solid var(--bg-tertiary);
                border-top: 3px solid var(--button-primary);
                border-radius: 50%;
                width: 30px;
                height: 30px;
                animation: claude-spin 1s linear infinite;
                margin: 0 auto;
            }

            .empty-state {
                text-align: center;
                color: var(--text-tertiary);
                padding: 2rem 1rem;
            }

            .file-icon {
                color: var(--text-secondary);
                margin-right: 0.5rem;
            }

            .folder-icon {
                color: var(--button-primary);
                margin-right: 0.5rem;
            }

            @keyframes claude-spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
            }

            generateMessageViewerStyles() {
                return `
            .message-user {
                background-color: var(--bg-tertiary);
                border-left: 4px solid #3b82f6;
                max-height: 400px;
                overflow-y: auto;
                width: 100%;
                color: var(--text-primary);
                padding: 1rem;
                border-radius: 0.5rem;
                margin-bottom: 0.75rem;
            }

            .message-assistant {
                background-color: var(--bg-secondary);
                border-left: 4px solid #10b981;
                max-height: 400px;
                overflow-y: auto;
                width: 100%;
                color: var(--text-primary);
                padding: 1rem;
                border-radius: 0.5rem;
                margin-bottom: 0.75rem;
            }

            .message-system {
                background-color: #fef3c7;
                border-left: 4px solid #f59e0b;
                max-height: 400px;
                overflow-y: auto;
                width: 100%;
                color: #78350f;
                padding: 1rem;
                border-radius: 0.5rem;
                margin-bottom: 0.75rem;
            }

            [data-theme="dark"] .message-system {
                background-color: #451a03;
                color: #fed7aa;
            }

            [data-theme="dark"] .message-system span[style*="color: #f59e0b"] {
                color: #fbbf24 !important;
            }

            .message-summary {
                background-color: #fefce8;
                border-left: 4px solid #eab308;
                max-height: 400px;
                overflow-y: auto;
                width: 100%;
                color: #713f12;
                padding: 1rem;
                border-radius: 0.5rem;
                margin-bottom: 0.75rem;
            }

            [data-theme="dark"] .message-summary {
                background-color: #422006;
                color: #fef3c7;
            }

            .message-tool {
                background-color: #f5f3ff;
                border-left: 4px solid #8b5cf6;
                max-height: 400px;
                overflow-y: auto;
                width: 100%;
                color: #581c87;
                padding: 1rem;
                border-radius: 0.5rem;
                margin-bottom: 0.75rem;
            }

            [data-theme="dark"] .message-tool {
                background-color: #2e1065;
                color: #e9d5ff;
            }

            /* Model name styling for different themes */
            [data-theme="dark"] .message-assistant span[style*="background-color: #e9d5ff"] {
                background-color: #581c87 !important;
                color: #e9d5ff !important;
            }

            /* Subtype label styling for different themes */
            div[class*="mt-1 text-xs"][style*="color: var(--text-tertiary)"] {
                background-color: var(--bg-tertiary);
                padding: 2px 6px;
                border-radius: 4px;
                border: 1px solid var(--border-primary);
                display: inline-block;
            }

            /* Summary and system content styling for dark theme */
            [data-theme="dark"] .summary-content {
                background-color: #422006 !important;
                border-color: #92400e !important;
            }

            [data-theme="dark"] .summary-content .text-yellow-600 {
                color: #fbbf24 !important;
            }

            [data-theme="dark"] .system-content {
                background-color: #1e3a8a !important;
                border-color: #1e40af !important;
            }

            [data-theme="dark"] .system-content .text-blue-600 {
                color: #60a5fa !important;
            }

            /* Tool result styling for dark theme */
            [data-theme="dark"] .bg-green-50 {
                background-color: #14532d !important;
                border-color: #16a34a !important;
            }

            [data-theme="dark"] .text-green-600 {
                color: #4ade80 !important;
            }

            /* Command output styling */
            .command-output {
                background-color: #1f2937;
                color: #f9fafb;
                border: 1px solid #374151;
            }

            [data-theme="light"] .command-output {
                background-color: #f8fafc;
                color: #1f2937;
                border-color: #e2e8f0;
            }

            .conversation-card {
                transition: all 0.3s ease;
            }

            .conversation-card:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow-color) 0 4px 12px -2px;
            }

            .message-viewer-container {
                background-color: var(--bg-primary);
                border: 1px solid var(--border-primary);
                border-radius: 0.75rem;
                box-shadow: var(--shadow-color) 0 4px 6px -1px, var(--shadow-color) 0 2px 4px -1px;
                height: 100%;
                min-height: 0;
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }

            #conversationContent {
                flex: 1;
                overflow-y: auto;
                overflow-x: hidden;
                padding-right: 0.5rem;
            }

            #conversationContent::-webkit-scrollbar {
                width: 8px;
            }

            #conversationContent::-webkit-scrollbar-track {
                background: var(--bg-secondary);
                border-radius: 4px;
            }

            #conversationContent::-webkit-scrollbar-thumb {
                background: var(--border-tertiary);
                border-radius: 4px;
            }

            #conversationContent::-webkit-scrollbar-thumb:hover {
                background: #94a3b8;
            }

            .code-block {
                font-family: 'Courier New', monospace;
            }

            .json-code {
                background-color: #1f2937;
                color: #f9fafb;
                padding: 1rem;
                border-radius: 0.5rem;
                overflow-x: auto;
                font-family: 'Courier New', monospace;
                font-size: 0.875rem;
                line-height: 1.25;
                border: 1px solid var(--border-primary);
            }

            [data-theme="light"] .json-code {
                background-color: #f8fafc;
                color: #1f2937;
                border: 1px solid #e2e8f0;
            }

            .json-key {
                color: #8b5cf6;
                font-weight: 600;
            }

            [data-theme="light"] .json-key {
                color: #7c3aed;
            }

            .json-string {
                color: #10b981;
            }

            [data-theme="light"] .json-string {
                color: #059669;
            }

            .json-number {
                color: #3b82f6;
            }

            [data-theme="light"] .json-number {
                color: #2563eb;
            }

            .json-boolean {
                color: #f59e0b;
            }

            [data-theme="light"] .json-boolean {
                color: #d97706;
            }

            .json-null {
                color: #ef4444;
            }

            [data-theme="light"] .json-null {
                color: #dc2626;
            }

            .tool-call {
                background-color: var(--bg-tertiary);
                border: 1px solid var(--border-primary);
                border-radius: 0.375rem;
                padding: 0.75rem;
                color: var(--text-primary);
                margin-top: 0.5rem;
            }

            .tool-name {
                font-weight: 600;
                color: #8b5cf6;
                margin-bottom: 0.25rem;
            }

            [data-theme="light"] .tool-name {
                color: #7c3aed;
            }

            .tool-description {
                color: var(--text-secondary);
                font-size: 0.875rem;
            }

            .todo-list {
                max-height: 40vh;
                overflow-y: auto;
                scrollbar-color: var(--border-tertiary) var(--bg-primary);
            }

            .todo-list::-webkit-scrollbar {
                width: 12px;
            }

            .todo-list::-webkit-scrollbar-track {
                background: var(--bg-primary);
                border-radius: 4px;
            }

            .todo-list::-webkit-scrollbar-thumb {
                background: var(--border-tertiary);
                border-radius: 4px;
            }

            .todo-list::-webkit-scrollbar-thumb:hover {
                background: var(--border-secondary);
            }

            .fade-in {
                animation: fadeIn 0.5s;
            }

            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }

            /* Scrollbar styles */
            .scroll-container {
                overflow-y: auto; 
                scrollbar-color: var(--border-tertiary) var(--bg-primary);
            }

            .scroll-container::-webkit-scrollbar {
                width: 14px;
            }

            .scroll-container::-webkit-scrollbar-track {
                background: var(--bg-primary);
                border-radius: 4px;
            }

            .scroll-container::-webkit-scrollbar-thumb {
                background: var(--border-tertiary);
                border-radius: 4px;
            }

            .scroll-container::-webkit-scrollbar-thumb:hover {
                background: var(--border-secondary);
            }

            .empty-state {
                text-align: center;
                color: var(--text-tertiary);
                padding: 3rem 2rem;
            }

            .message-header {
                color: var(--text-secondary);
                font-size: 0.875rem;
                margin-bottom: 0.5rem;
            }

            .message-content {
                line-height: 1.6;
            }

            /* Message content specific colors for different message types */
            .message-summary .message-content {
                color: #713f12;
            }

            [data-theme="dark"] .message-summary .message-content {
                color: #fef3c7;
            }

            .message-system .message-content {
                color: #78350f;
            }

            [data-theme="dark"] .message-system .message-content {
                color: #fed7aa;
            }

            /* Default content color for other message types */
            .message-user .message-content,
            .message-assistant .message-content,
            .message-tool .message-content {
                color: var(--text-primary);
            }

            /* Content colors for nested content items */
            .summary-content-text {
                color: #713f12;
            }

            [data-theme="dark"] .summary-content-text {
                color: #fef3c7;
            }

            .system-content-text {
                color: #1e40af;
            }

            [data-theme="dark"] .system-content-text {
                color: #dbeafe;
            }

            /* Message content scrollbar styling */
            .message-user::-webkit-scrollbar,
            .message-assistant::-webkit-scrollbar,
            .message-system::-webkit-scrollbar,
            .message-summary::-webkit-scrollbar {
                width: 10px;
            }

            .message-user::-webkit-scrollbar-track,
            .message-assistant::-webkit-scrollbar-track,
            .message-system::-webkit-scrollbar-track,
            .message-summary::-webkit-scrollbar-track {
                background: rgba(0, 0, 0, 0.05);
                border-radius: 3px;
            }

            .message-user::-webkit-scrollbar-thumb,
            .message-assistant::-webkit-scrollbar-thumb,
            .message-system::-webkit-scrollbar-thumb,
            .message-summary::-webkit-scrollbar-thumb {
                background: rgba(0, 0, 0, 0.2);
                border-radius: 3px;
            }

            .message-user::-webkit-scrollbar-thumb:hover,
            .message-assistant::-webkit-scrollbar-thumb:hover,
            .message-system::-webkit-scrollbar-thumb:hover,
            .message-summary::-webkit-scrollbar-thumb:hover {
                background: rgba(0, 0, 0, 0.3);
            }
        `;
            }

            generateDiffModalStyles() {
                return `
            .diff-modal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            }

            /* Basic utility styles */
            .text-lg {
                font-size: 1.125rem;
                line-height: 1.75rem;
                font-weight: 600;
            }

            .font-semibold {
                font-weight: 600;
            }

            .flex {
                display: flex;
            }

            .items-center {
                align-items: center;
            }

            .justify-between {
                justify-content: space-between;
            }

            .flex-col {
                flex-direction: column;
            }

            .flex-1 {
                flex: 1;
            }

            .ml-2 {
                margin-left: 0.5rem;
            }

            .mr-1 {
                margin-right: 0.25rem;
            }

            .text-xs {
                font-size: 0.75rem;
                line-height: 1rem;
            }

            .diff-modal-content {
                background-color: #ffffff;
                border-radius: 0.5rem;
                width: 95%;
                max-width: 1400px;
                height: 90vh;
                overflow: hidden;
                display: flex;
                flex-direction: column;
                border: 1px solid #e5e7eb;
                box-shadow: rgba(0, 0, 0, 0.1) 0 25px 50px -12px;
            }

            [data-theme="dark"] .diff-modal-content {
                background-color: #1f2937;
                border-color: #374151;
                box-shadow: rgba(0, 0, 0, 0.3) 0 25px 50px -12px;
            }

            .diff-modal-header {
                padding: 1rem;
                border-bottom: 1px solid #e5e7eb;
                display: flex;
                justify-content: space-between;
                align-items: center;
                background-color: #f9fafb;
                position: relative;
                z-index: 10;
            }

            .diff-modal-header h3 {
                color: #1e293b !important;
                font-size: 1.125rem !important;
                font-weight: 600 !important;
                z-index: 11;
                position: relative;
            }

            [data-theme="dark"] .diff-modal-header h3 {
                color: #f1f5f9 !important;
            }

            [data-theme="dark"] .diff-modal-header {
                border-bottom-color: #374151;
                background-color: #111827;
            }

            .diff-modal-body {
                flex: 1;
                overflow: hidden;
                display: flex;
                min-height: 0;
            }

            .diff-panel {
                flex: 1;
                padding: 1rem;
                border-right: 1px solid #e5e7eb;
                display: flex;
                flex-direction: column;
                background-color: #ffffff;
            }

            [data-theme="dark"] .diff-panel {
                border-right-color: #374151;
                background-color: #1f2937;
            }

            .diff-panel:last-child {
                border-right: none;
            }

            .diff-panel-header {
                font-weight: 600;
                margin-bottom: 0.5rem;
                color: #111827;
            }

            [data-theme="dark"] .diff-panel-header {
                color: #f9fafb;
            }

            .diff-textarea {
                flex: 1;
                border: 1px solid #e5e7eb;
                border-radius: 0.375rem;
                padding: 0.75rem;
                font-family: 'Courier New', monospace;
                font-size: 0.875rem;
                resize: none;
                background-color: #f9fafb;
                color: #111827;
                overflow: auto;
                white-space: pre;
            }

            [data-theme="dark"] .diff-textarea {
                border-color: #374151;
                background-color: #111827;
                color: #f9fafb;
            }

            .diff-textarea:focus {
                outline: none;
                border-color: #3b82f6;
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            }

            [data-theme="dark"] .diff-textarea:focus {
                border-color: #60a5fa;
                box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
            }

            .diff-button {
                background: linear-gradient(145deg, #6366f1 0%, #8b5cf6 100%);
                color: #ffffff;
                border: 1px solid rgba(255, 255, 255, 0.1);
                padding: 0.375rem 0.875rem;
                border-radius: 0.625rem;
                cursor: pointer;
                font-size: 0.75rem;
                font-weight: 600;
                transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
                position: relative;
                overflow: hidden;
                box-shadow: 0 1px 3px rgba(99, 102, 241, 0.3), 0 1px 2px rgba(0, 0, 0, 0.1);
                letter-spacing: 0.015em;
                z-index: 1;
                display: inline-flex;
                align-items: center;
                gap: 0.25rem;
                min-height: 2rem;
                backdrop-filter: blur(8px);
                -webkit-backdrop-filter: blur(8px);
            }

            .diff-button::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);
                transition: left 0.4s ease;
            }

            .diff-button::after {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                width: 0;
                height: 0;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.08);
                transform: translate(-50%, -50%);
                transition: width 0.5s ease, height 0.5s ease;
            }

            .diff-button .icon {
                font-size: 0.875rem;
                filter: drop-shadow(0 1px 1px rgba(0, 0, 0, 0.1));
            }

            .diff-button .badge {
                background: rgba(255, 255, 255, 0.2);
                color: #ffffff;
                font-size: 0.625rem;
                padding: 0.125rem 0.375rem;
                border-radius: 0.25rem;
                margin-left: 0.25rem;
                font-weight: 700;
            }

            [data-theme="dark"] .diff-button {
                background: linear-gradient(145deg, #4f46e5 0%, #7c3aed 100%);
                border-color: rgba(255, 255, 255, 0.08);
                box-shadow: 0 1px 3px rgba(79, 70, 229, 0.4), 0 1px 2px rgba(0, 0, 0, 0.2);
            }

            .diff-button:hover {
                background: linear-gradient(145deg, #6366f1 0%, #8b5cf6 100%);
                transform: translateY(-1px) scale(1.01);
                box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4), 0 2px 4px rgba(0, 0, 0, 0.1);
                border-color: rgba(255, 255, 255, 0.15);
            }

            .diff-button:hover::before {
                left: 100%;
            }

            .diff-button:active {
                transform: translateY(0) scale(0.99);
                box-shadow: 0 1px 3px rgba(99, 102, 241, 0.3), 0 1px 2px rgba(0, 0, 0, 0.1);
            }

            .diff-button:active::after {
                width: 200px;
                height: 200px;
            }

            [data-theme="dark"] .diff-button:hover {
                background: linear-gradient(145deg, #6366f1 0%, #8b5cf6 100%);
                box-shadow: 0 4px 12px rgba(99, 102, 241, 0.5), 0 2px 4px rgba(0, 0, 0, 0.3);
            }

            .diff-button:focus-visible {
                outline: 2px solid #6366f1;
                outline-offset: 2px;
            }

            [data-theme="dark"] .diff-button:focus-visible {
                outline-color: #8b5cf6;
            }

            .diff-button-secondary {
                background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
                color: #475569;
                border: 1px solid #cbd5e1;
                padding: 0.625rem 1.25rem;
                border-radius: 0.75rem;
                cursor: pointer;
                font-size: 0.8125rem;
                font-weight: 500;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                position: relative;
                overflow: hidden;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                z-index: 1;
            }

            .diff-button-secondary::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
                transition: left 0.5s ease;
            }

            [data-theme="dark"] .diff-button-secondary {
                background: linear-gradient(135deg, #334155 0%, #1e293b 100%);
                color: #cbd5e1;
                border-color: #475569;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            }

            .diff-button-secondary:hover {
                background: linear-gradient(135deg, #f1f5f9 0%, #cbd5e1 100%);
                color: #334155;
                transform: translateY(-2px) scale(1.02);
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
                border-color: #94a3b8;
            }

            .diff-button-secondary:hover::before {
                left: 100%;
            }

            .diff-button-secondary:active {
                transform: translateY(0) scale(0.98);
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            }

            [data-theme="dark"] .diff-button-secondary:hover {
                background: linear-gradient(135deg, #475569 0%, #334155 100%);
                color: #e2e8f0;
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
                border-color: #64748b;
            }

            /* Diff comparison styles */
            .diff-comparison {
                flex: 1;
                padding: 1.5rem;
                background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
                border-radius: 1rem;
                border: 1px solid #e2e8f0;
                overflow-y: auto;
                font-family: 'JetBrains Mono', 'Fira Code', 'Courier New', monospace;
                font-size: 0.8125rem;
                line-height: 1.6;
                color: #1e293b;
                box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);
                position: relative;
            }

            [data-theme="dark"] .diff-comparison {
                background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
                border-color: #334155;
                color: #e2e8f0;
                box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
            }

            .diff-comparison-header {
                font-weight: 600;
                margin-bottom: 1rem;
                color: #1e293b;
                font-size: 0.875rem;
                text-transform: uppercase;
                letter-spacing: 0.025em;
                padding-bottom: 0.5rem;
                border-bottom: 2px solid #e2e8f0;
            }

            [data-theme="dark"] .diff-comparison-header {
                color: #f1f5f9;
                border-bottom-color: #334155;
            }

            .diff-line {
                margin-bottom: 0.125rem;
                font-family: 'JetBrains Mono', 'Fira Code', 'Courier New', monospace;
                font-size: 0.8125rem;
                line-height: 1.7;
                padding: 0.25rem 0.5rem;
                border-radius: 0.375rem;
                transition: all 0.2s ease;
                position: relative;
            }

            .diff-line:hover {
                background-color: rgba(0, 0, 0, 0.02);
                transform: translateX(2px);
            }

            [data-theme="dark"] .diff-line:hover {
                background-color: rgba(255, 255, 255, 0.02);
            }

            .diff-added {
                background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
                color: #166534;
                padding: 0.5rem 0.75rem;
                border-radius: 0.5rem;
                border-left: 4px solid #22c55e;
                position: relative;
                box-shadow: 0 2px 4px rgba(34, 197, 94, 0.1);
            }

            .diff-added::before {
                content: '+';
                position: absolute;
                left: -1rem;
                top: 50%;
                transform: translateY(-50%);
                color: #22c55e;
                font-weight: bold;
                font-size: 1rem;
            }

            [data-theme="dark"] .diff-added {
                background: linear-gradient(135deg, #14532d 0%, #166534 100%);
                color: #86efac;
                border-left-color: #4ade80;
                box-shadow: 0 2px 4px rgba(74, 222, 128, 0.1);
            }

            [data-theme="dark"] .diff-added::before {
                color: #4ade80;
            }

            .diff-removed {
                background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
                color: #991b1b;
                padding: 0.5rem 0.75rem;
                border-radius: 0.5rem;
                border-left: 4px solid #ef4444;
                position: relative;
                box-shadow: 0 2px 4px rgba(239, 68, 68, 0.1);
            }

            .diff-removed::before {
                content: '-';
                position: absolute;
                left: -1rem;
                top: 50%;
                transform: translateY(-50%);
                color: #ef4444;
                font-weight: bold;
                font-size: 1rem;
            }

            [data-theme="dark"] .diff-removed {
                background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%);
                color: #fca5a5;
                border-left-color: #f87171;
                box-shadow: 0 2px 4px rgba(248, 113, 113, 0.1);
            }

            [data-theme="dark"] .diff-removed::before {
                color: #f87171;
            }

            .diff-unchanged {
                color: #64748b;
                padding: 0.25rem 0.75rem;
                transition: all 0.2s ease;
            }

            .diff-unchanged:hover {
                color: #475569;
                background-color: rgba(0, 0, 0, 0.02);
            }

            [data-theme="dark"] .diff-unchanged {
                color: #94a3b8;
            }

            [data-theme="dark"] .diff-unchanged:hover {
                color: #cbd5e1;
                background-color: rgba(255, 255, 255, 0.02);
            }

            /* Enhanced scrollbar styles */
            .diff-comparison::-webkit-scrollbar {
                width: 10px;
            }

            .diff-comparison::-webkit-scrollbar-track {
                background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
                border-radius: 5px;
                border: 1px solid #cbd5e1;
            }

            [data-theme="dark"] .diff-comparison::-webkit-scrollbar-track {
                background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
                border-color: #475569;
            }

            .diff-comparison::-webkit-scrollbar-thumb {
                background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
                border-radius: 5px;
                border: 1px solid #94a3b8;
            }

            [data-theme="dark"] .diff-comparison::-webkit-scrollbar-thumb {
                background: linear-gradient(135deg, #475569 0%, #64748b 100%);
                border-color: #64748b;
            }

            .diff-comparison::-webkit-scrollbar-thumb:hover {
                background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            }

            [data-theme="dark"] .diff-comparison::-webkit-scrollbar-thumb:hover {
                background: linear-gradient(135deg, #64748b 0%, #94a3b8 100%);
            }

            /* Diff tabs styles */
            .diff-edit-tabs {
                display: flex;
                background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
                border-bottom: 2px solid #e2e8f0;
                padding: 0.5rem;
                gap: 0.25rem;
                overflow-x: auto;
                scrollbar-width: thin;
                scrollbar-color: #cbd5e1 transparent;
            }

            .diff-edit-tabs::-webkit-scrollbar {
                height: 4px;
            }

            .diff-edit-tabs::-webkit-scrollbar-track {
                background: transparent;
            }

            .diff-edit-tabs::-webkit-scrollbar-thumb {
                background: #cbd5e1;
                border-radius: 2px;
            }

            [data-theme="dark"] .diff-edit-tabs {
                background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
                border-bottom-color: #334155;
            }

            [data-theme="dark"] .diff-edit-tabs::-webkit-scrollbar-thumb {
                background: #475569;
            }

            .diff-edit-tab {
                background: transparent;
                border: none;
                padding: 0.75rem 1.25rem;
                cursor: pointer;
                border-radius: 0.75rem;
                color: #64748b;
                font-size: 0.8125rem;
                font-weight: 500;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                white-space: nowrap;
                position: relative;
                overflow: hidden;
                z-index: 1;
            }

            .diff-edit-tab::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                opacity: 0;
                transition: opacity 0.3s ease;
                border-radius: 0.75rem;
                z-index: -1;
            }

            .diff-edit-tab:hover {
                color: #334155;
                background: rgba(255, 255, 255, 0.5);
                transform: translateY(-1px);
            }

            .diff-edit-tab:hover::before {
                opacity: 0.1;
            }

            .diff-edit-tab.active {
                color: #ffffff;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
                transform: translateY(-1px);
            }

            .diff-edit-tab.active::before {
                opacity: 1;
                z-index: -1;
            }

            [data-theme="dark"] .diff-edit-tab {
                color: #94a3b8;
            }

            [data-theme="dark"] .diff-edit-tab:hover {
                color: #cbd5e1;
                background: rgba(255, 255, 255, 0.05);
            }

            [data-theme="dark"] .diff-edit-tab.active {
                background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
                box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
            }

            /* Ensure text visibility in all states */
            .diff-edit-tab,
            .diff-content-tab,
            .diff-button,
            .diff-button-secondary {
                text-shadow: none !important;
            }

            /* Additional button spacing optimizations */
            .diff-button + .diff-button {
                margin-left: 0.5rem;
            }

            .diff-button {
                margin-left: 0.5rem;
                vertical-align: middle;
            }

            /* Mobile optimization for diff buttons */
            @media (max-width: 768px) {
                .diff-button {
                    padding: 0.3125rem 0.75rem;
                    font-size: 0.7rem;
                    min-height: 1.875rem;
                }

                .diff-button .icon {
                    font-size: 0.75rem;
                }

                .diff-button .badge {
                    font-size: 0.5625rem;
                    padding: 0.09375rem 0.3125rem;
                }
            }

            /* Ensure button content is properly aligned */
            .diff-button > span:not(.icon):not(.badge) {
                line-height: 1.2;
            }

            /* Animation optimization for performance */
            .diff-button {
                will-change: transform, box-shadow;
            }

            .diff-button:hover {
                will-change: transform, box-shadow, background;
            }

            /* Force override conflicting styles */
            button.diff-button {
                background: linear-gradient(145deg, #6366f1 0%, #8b5cf6 100%) !important;
                color: #ffffff !important;
                border: 1px solid rgba(255, 255, 255, 0.1) !important;
                padding: 0.375rem 0.875rem !important;
                border-radius: 0.625rem !important;
                cursor: pointer !important;
                font-size: 0.75rem !important;
                font-weight: 600 !important;
                transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1) !important;
                position: relative !important;
                overflow: hidden !important;
                box-shadow: 0 1px 3px rgba(99, 102, 241, 0.3), 0 1px 2px rgba(0, 0, 0, 0.1) !important;
                letter-spacing: 0.015em !important;
                z-index: 1 !important;
                display: inline-flex !important;
                align-items: center !important;
                gap: 0.25rem !important;
                min-height: 2rem !important;
                backdrop-filter: blur(8px) !important;
                -webkit-backdrop-filter: blur(8px) !important;
                text-shadow: none !important;
                text-transform: none !important;
                margin-left: 0.5rem !important;
                vertical-align: middle !important;
            }

            button.diff-button:hover {
                background: linear-gradient(145deg, #6366f1 0%, #8b5cf6 100%) !important;
                transform: translateY(-1px) scale(1.01) !important;
                box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4), 0 2px 4px rgba(0, 0, 0, 0.1) !important;
                border-color: rgba(255, 255, 255, 0.15) !important;
            }

            button.diff-button:active {
                transform: translateY(0) scale(0.99) !important;
                box-shadow: 0 1px 3px rgba(99, 102, 241, 0.3), 0 1px 2px rgba(0, 0, 0, 0.1) !important;
            }

            /* Dark theme overrides */
            [data-theme="dark"] button.diff-button {
                background: linear-gradient(145deg, #4f46e5 0%, #7c3aed 100%) !important;
                border-color: rgba(255, 255, 255, 0.08) !important;
                box-shadow: 0 1px 3px rgba(79, 70, 229, 0.4), 0 1px 2px rgba(0, 0, 0, 0.2) !important;
            }

            [data-theme="dark"] button.diff-button:hover {
                background: linear-gradient(145deg, #6366f1 0%, #8b5cf6 100%) !important;
                box-shadow: 0 4px 12px rgba(99, 102, 241, 0.5), 0 2px 4px rgba(0, 0, 0, 0.3) !important;
            }

            /* Icon and badge styling */
            button.diff-button .icon {
                font-size: 0.875rem !important;
                filter: drop-shadow(0 1px 1px rgba(0, 0, 0, 0.1)) !important;
            }

            button.diff-button .badge {
                background: rgba(255, 255, 255, 0.2) !important;
                color: #ffffff !important;
                font-size: 0.625rem !important;
                padding: 0.125rem 0.375rem !important;
                border-radius: 0.25rem !important;
                margin-left: 0.25rem !important;
                font-weight: 700 !important;
            }

            button.diff-button > span:not(.icon):not(.badge) {
                line-height: 1.2 !important;
            }

            /* Debug styles - highlight buttons for visibility */
            button.diff-button::before {
                content: '';
                position: absolute;
                top: -2px;
                left: -2px;
                right: -2px;
                bottom: -2px;
                border: 2px solid #ff6b6b;
                border-radius: 0.75rem;
                z-index: -1;
                opacity: 0.5;
                pointer-events: none;
            }

            /* Remove debug styles after confirming visibility */
            /* button.diff-button::before { display: none; } */

            .diff-edit-tab span,
            .diff-content-tab span {
                position: relative;
                z-index: 3;
                color: inherit;
                font-weight: inherit;
            }

        /* Ensure tab button text is visible in all states */
        .diff-edit-tab,
        .diff-content-tab {
            color: #64748b;
            position: relative;
        }

        .diff-edit-tab.active,
        .diff-content-tab.active {
            color: #ffffff !important;
        }

        [data-theme="dark"] .diff-edit-tab,
        [data-theme="dark"] .diff-content-tab {
            color: #94a3b8;
        }

        [data-theme="dark"] .diff-edit-tab.active,
        [data-theme="dark"] .diff-content-tab.active {
            color: #ffffff !important;
        }

        /* Additional fixes for text visibility */
        .diff-content-tab.active::after,
        .diff-edit-tab.active::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 0;
            border-radius: inherit;
        }

        .diff-content-tab,
        .diff-edit-tab {
            z-index: 1;
        }

        .diff-content-tab *,
        .diff-edit-tab * {
            color: inherit !important;
            position: relative;
            z-index: 1;
        }

        .diff-content-tab.active *,
        .diff-edit-tab.active * {
            color: #ffffff !important;
        }

        /* Force text color for active tabs */
        .diff-content-tab.active,
        .diff-edit-tab.active {
            color: #ffffff !important;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5) !important;
        }

        [data-theme="dark"] .diff-content-tab.active,
        [data-theme="dark"] .diff-edit-tab.active {
            color: #ffffff !important;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8) !important;
        }

        /* Override any inherited text styles */
        .diff-content-tab.active span,
        .diff-edit-tab.active span {
            color: #ffffff !important;
        }

            .diff-content-tabs {
                display: flex;
                background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
                border-bottom: 2px solid #e2e8f0;
                margin: 1rem;
                margin-bottom: 0.5rem;
                border-radius: 0.75rem;
                padding: 0.25rem;
                gap: 0.25rem;
            }

            [data-theme="dark"] .diff-content-tabs {
                background: linear-gradient(135deg, #334155 0%, #1e293b 100%);
                border-bottom-color: #475569;
            }

            .diff-content-tab {
                background: transparent;
                border: none;
                padding: 0.625rem 1.25rem;
                cursor: pointer;
                border-radius: 0.625rem;
                color: #64748b;
                font-size: 0.8125rem;
                font-weight: 500;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                position: relative;
                overflow: hidden;
                z-index: 1;
            }

            .diff-content-tab::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                opacity: 0;
                transition: opacity 0.3s ease;
                border-radius: 0.625rem;
                z-index: -1;
            }

            .diff-content-tab:hover {
                color: #334155;
                background: rgba(255, 255, 255, 0.6);
                transform: translateY(-1px);
            }

            .diff-content-tab:hover::before {
                opacity: 0.1;
            }

            .diff-content-tab.active {
                color: #ffffff !important;
                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                box-shadow: 0 3px 8px rgba(16, 185, 129, 0.3);
                transform: translateY(-1px);
                font-weight: 600;
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            }

            .diff-content-tab.active::before {
                opacity: 1;
                z-index: -1;
            }

            [data-theme="dark"] .diff-content-tab {
                color: #94a3b8;
            }

            [data-theme="dark"] .diff-content-tab:hover {
                color: #cbd5e1;
                background: rgba(255, 255, 255, 0.05);
            }

            [data-theme="dark"] .diff-content-tab.active {
                background: linear-gradient(135deg, #059669 0%, #047857 100%);
                box-shadow: 0 3px 8px rgba(5, 150, 105, 0.4);
                color: #ffffff !important;
                font-weight: 600;
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            }

            .diff-content-area {
                flex: 1;
                display: flex;
                overflow: hidden;
            }

            .diff-panel {
                display: none;
            }

            .diff-panel.active {
                display: flex;
            }

            /* Ensure proper scrolling for diff content */
            .diff-comparison::-webkit-scrollbar {
                width: 8px;
            }

            .diff-comparison::-webkit-scrollbar-track {
                background: #f3f4f6;
                border-radius: 4px;
            }

            [data-theme="dark"] .diff-comparison::-webkit-scrollbar-track {
                background: #374151;
            }

            .diff-comparison::-webkit-scrollbar-thumb {
                background: #9ca3af;
                border-radius: 4px;
            }

            [data-theme="dark"] .diff-comparison::-webkit-scrollbar-thumb {
                background: #6b7280;
            }

            .diff-comparison::-webkit-scrollbar-thumb:hover {
                background: #6b7280;
            }

            [data-theme="dark"] .diff-comparison::-webkit-scrollbar-thumb:hover {
                background: #9ca3af;
            }

            /* Textarea styling improvements */
            .diff-textarea {
                outline: none;
                resize: none;
                font-family: 'Courier New', monospace;
                white-space: pre;
                word-wrap: normal;
                overflow-wrap: normal;
                -webkit-overflow-scrolling: touch;
            }

            .diff-textarea::-webkit-scrollbar {
                width: 8px;
            }

            .diff-textarea::-webkit-scrollbar-track {
                background: var(--bg-tertiary);
                border-radius: 4px;
            }

            .diff-textarea::-webkit-scrollbar-thumb {
                background: var(--border-tertiary);
                border-radius: 4px;
            }

            .diff-textarea::-webkit-scrollbar-thumb:hover {
                background: var(--border-secondary);
            }
        `;
            }

            // Get specific style groups
            getStyles(component) {
                return this.styles[component] || '';
            }

            getAppStyles() {
                return this.styles.app;
            }

            getFileBrowserStyles() {
                return this.styles.fileBrowser;
            }

            getMessageViewerStyles() {
                return this.styles.messageViewer;
            }

            getSessionNavigatorStyles() {
                return this.styles.sessionNavigator;
            }

            getDiffModalStyles() {
                return this.generateDiffModalStyles();
            }

            // Theme management methods
            getThemeManager() {
                return this.themeManager;
            }

            getCurrentTheme() {
                return this.themeManager.getCurrentTheme();
            }

            setTheme(theme) {
                this.themeManager.setTheme(theme);
            }

            toggleTheme() {
                return this.themeManager.toggleTheme();
            }

            // Initialize theme on app startup
            initializeTheme() {
                const theme = this.themeManager.getCurrentTheme();
                document.documentElement.setAttribute('data-theme', theme);
            }
        }


        // Central data management component
        class DataManager {
            constructor() {
                this.directoryHandle = null;
                this.projectData = {
                    projects: {},
                    sessions: {},
                    currentSessionIndex: 0,
                    currentFileSessions: [],
                    currentFile: null
                };
                this.editDataMap = new Map();
                this.DB_NAME = 'ClaudeCodeHistoryViewer';
                this.DB_VERSION = 1;
                this.STORE_NAME = 'directoryHandles';
                this.languageManager = window.languageManager;
            }

            // Directory handle management
            async setDirectoryHandle(handle) {
                this.directoryHandle = handle;
                await this.saveDirectoryHandle(handle);
            }

            getDirectoryHandle() {
                return this.directoryHandle;
            }

            // Project data management
            getProjectData() {
                return this.projectData;
            }

            setProjectData(data) {
                this.projectData = { ...this.projectData, ...data };
            }

            // Session management
            getCurrentSession() {
                const sessionId = this.projectData.currentFileSessions[this.projectData.currentSessionIndex];
                return this.projectData.sessions[sessionId];
            }

            setCurrentSessionIndex(index) {
                this.projectData.currentSessionIndex = index;
            }

            // Edit data management
            getEditData(id) {
                return this.editDataMap.get(id);
            }

            setEditData(id, data) {
                this.editDataMap.set(id, data);
            }

            // IndexedDB operations
            async openDatabase() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.DB_NAME, this.DB_VERSION);

                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);

                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(this.STORE_NAME)) {
                            db.createObjectStore(this.STORE_NAME, { keyPath: 'id' });
                        }
                    };
                });
            }

            async saveDirectoryHandle(handle) {
                try {
                    const db = await this.openDatabase();
                    const transaction = db.transaction([this.STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(this.STORE_NAME);

                    const directoryData = {
                        id: 'last_directory',
                        name: handle.name,
                        handle: handle,
                        timestamp: Date.now()
                    };

                    await store.put(directoryData);
                    return true;
                } catch (error) {
                    console.error('saveDirectoryHandle error:', error);
                    return false;
                }
            }

            async getLastDirectoryHandle() {
                try {
                    const db = await this.openDatabase();
                    const transaction = db.transaction([this.STORE_NAME], 'readonly');
                    const store = transaction.objectStore(this.STORE_NAME);

                    return new Promise((resolve, reject) => {
                        const request = store.get('last_directory');
                        request.onsuccess = () => resolve(request.result);
                        request.onerror = () => reject(request.error);
                    });
                } catch (error) {
                    console.error('getLastDirectoryHandle error:', error);
                    return null;
                }
            }

            async reset() {
                try {
                    // Clear IndexedDB
                    const db = await this.openDatabase();
                    const transaction = db.transaction([this.STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(this.STORE_NAME);
                    await store.delete('last_directory');

                    // Reset data
                    this.directoryHandle = null;
                    this.projectData = {
                        projects: {},
                        sessions: {},
                        currentSessionIndex: 0,
                        currentFileSessions: [],
                        currentFile: null
                    };
                    this.editDataMap.clear();

                    console.log('DataManager reset');
                } catch (error) {
                    console.error('DataManager reset error:', error);
                    throw error;
                }
            }

            // Project loading operations
            async loadProject() {
                if (!this.directoryHandle) {
                    throw new Error('Ê≤°ÊúâÈÄâÊã©ÁõÆÂΩï');
                }

                // Reset project data
                this.projectData = {
                    projects: {},
                    sessions: {},
                    currentSessionIndex: 0,
                    currentFileSessions: [],
                    currentFile: null
                };

                // Traverse directory
                await this.traverseDirectory(this.directoryHandle, '');
            }

            async traverseDirectory(handle, path) {
                const files = [];

                try {
                    for await (const entry of handle.values()) {
                        const entryPath = path ? `${path}/${entry.name}` : entry.name;

                        if (entry.kind === 'file') {
                            const fileObj = await entry.getFile();
                            const fileInfo = {
                                name: entry.name,
                                type: 'file',
                                path: entryPath,
                                handle: entry,
                                extension: entry.name.split('.').pop().toLowerCase(),
                                lastModified: fileObj.lastModified
                            };

                            files.push(fileInfo);

                            // Add JSONL files to project data
                            if (fileInfo.extension === 'jsonl' || fileInfo.extension === 'json' || fileInfo.extension === 'txt') {
                                if (!this.projectData.projects[path]) {
                                    this.projectData.projects[path] = {
                                        name: path || 'root',
                                        path: path,
                                        files: []
                                    };
                                }
                                this.projectData.projects[path].files.push(fileInfo);
                            }
                        } else if (entry.kind === 'directory') {
                            const dirInfo = {
                                name: entry.name,
                                type: 'folder',
                                path: entryPath,
                                handle: entry,
                                children: []
                            };

                            // Recursively traverse subdirectory
                            const subFiles = await this.traverseDirectory(entry, entryPath);
                            dirInfo.children = subFiles;
                            files.push(dirInfo);
                        }
                    }
                } catch (error) {
                    console.error('traverseDirectory error:', error);
                }

                return files;
            }

            // File parsing operations
            async parseJSONL(content, fileName) {
                const lines = content.split('\n').filter(line => line.trim());
                const currentFileSessions = [];
                const currentFileSessionsData = {};

                for (let i = 0; i < lines.length; i++) {
                    try {
                        // Skip lines that don't start with { or [ (likely not JSON)
                        const line = lines[i].trim();
                        if (!line.startsWith('{') && !line.startsWith('[')) {
                            continue;
                        }

                        const jsonData = JSON.parse(line);

                        // Extract basic info
                        let sessionId = jsonData.sessionId;
                        const timestamp = jsonData.timestamp;
                        const type = jsonData.type;
                        const uuid = jsonData.uuid;
                        const parentUuid = jsonData.parentUuid;

                        // Generate sessionId if not present
                        if (!sessionId) {
                            sessionId = fileName.replace(/\.[^/.]+$/, '');
                        }

                        // Initialize session data
                        if (!currentFileSessionsData[sessionId]) {
                            currentFileSessionsData[sessionId] = {
                                id: sessionId,
                                messages: [],
                                startTime: timestamp,
                                endTime: timestamp,
                                fileName: fileName
                            };
                            currentFileSessions.push(sessionId);
                        }

                        // Update session time range
                        if (timestamp < currentFileSessionsData[sessionId].startTime) {
                            currentFileSessionsData[sessionId].startTime = timestamp;
                        }
                        if (timestamp > currentFileSessionsData[sessionId].endTime) {
                            currentFileSessionsData[sessionId].endTime = timestamp;
                        }

                        // Create message object
                        const message = {
                            id: uuid,
                            sessionId: sessionId,
                            timestamp: timestamp,
                            type: type,
                            parentUuid: parentUuid,
                            rawData: jsonData
                        };

                        // Extract content based on type
                        if (type === 'user') {
                            message.role = 'user';
                            message.content = this.extractUserContent(jsonData);
                        } else if (type === 'assistant') {
                            message.role = 'assistant';
                            message.content = this.extractAssistantContent(jsonData);
                        } else if (type === 'summary') {
                            message.role = 'summary';
                            message.content = this.extractSummaryContent(jsonData);
                        } else if (type === 'system') {
                            message.role = 'system';
                            message.content = this.extractSystemContent(jsonData);
                        }

                        // Add to session
                        currentFileSessionsData[sessionId].messages.push(message);

                    } catch (error) {
                        // Silently skip malformed JSON lines (likely debug logs)
                        // Only log in development mode
                        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                            console.debug('Skipping non-JSON line ' + (i + 1) + ':', lines[i]?.substring(0, 50) + '...');
                        }
                    }
                }

                // Sort messages by time
                currentFileSessions.forEach(sessionId => {
                    if (currentFileSessionsData[sessionId] && currentFileSessionsData[sessionId].messages) {
                        currentFileSessionsData[sessionId].messages.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    }
                });

                // Update project data
                this.projectData.currentFileSessions = currentFileSessions;
                this.projectData.sessions = currentFileSessionsData;
            }

            // Content extraction methods
            extractUserContent(data) {
                if (!data) return this.languageManager.get('noContent');

                if (data.message && typeof data.message.content === 'string') {
                    let content = data.message.content;

                    // Handle local-command-stdout tags
                    if (content.includes('<local-command-stdout>')) {
                        const stdoutMatch = content.match(/<local-command-stdout>([\s\S]*?)<\/local-command-stdout>/);
                        if (stdoutMatch && stdoutMatch[1]) {
                            const cleanedStdout = this.removeANSICodes(stdoutMatch[1]);
                            content = content.replace(
                                /<local-command-stdout>[\s\S]*?<\/local-command-stdout>/,
                                `${this.languageManager.get('commandOutput')}:\n${cleanedStdout}`
                            );
                        }
                    }

                    return content;
                }

                if (data.message && Array.isArray(data.message.content)) {
                    return data.message.content.map(item => {
                        if (item.type === 'tool_result') {
                            let content = item.content || this.languageManager.get('noContent');
                            if (typeof content === 'string' && /<[^>]*>/.test(content)) {
                                content = content.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                            }
                            return `[${this.languageManager.get('toolResultLabel')}] ${content}`;
                        }
                        return item.content || JSON.stringify(item);
                    }).join('\n');
                }

                return JSON.stringify(data.message || data);
            }

            extractAssistantContent(data) {
                if (!data) return this.languageManager.get('noContent');

                if (data.message && data.message.content) {
                    if (Array.isArray(data.message.content)) {
                        return data.message.content.map(item => {
                            if (item.type === 'text') {
                                return item.text || this.languageManager.get('noTextContent');
                            } else if (item.type === 'tool_use') {
                                return `[${this.languageManager.get('toolCallLabel')}: ${item.name || this.languageManager.get('unknownTool')}] ${JSON.stringify(item.input || {})}`;
                            }
                            return JSON.stringify(item);
                        }).join('\n');
                    } else if (typeof data.message.content === 'string') {
                        return data.message.content;
                    }
                }

                return JSON.stringify(data.message || data);
            }

            extractSummaryContent(data) {
                if (!data) return this.languageManager.get('noContent');
                return data.summary || JSON.stringify(data);
            }

            extractSystemContent(data) {
                if (!data) return this.languageManager.get('noContent');
                return data.content || JSON.stringify(data);
            }

            removeANSICodes(text) {
                if (!text || typeof text !== 'string') return text;

                const ansiRegex = [
                    /\u001b\[[0-9;]*m/g,
                    /\u001b\[[0-9;]*[ABCDEFGHJKSTfmnsulh]/g,
                    /\u001b\[[0-9]*[JK]/g,
                    /\u001b\[[0-9]*[ABCD]/g,
                    /\u001b\[[0-9;]*[Hf]/g,
                    /\u001b\[[0-9]*[su]/g,
                    /\u001b\[\?[0-9;]*[hl]/g,
                    /\u001b\][0-9];.*?\u001b\\/g,
                    /\u001b\][0-9][0-9];.*?\u001b\\/g,
                    /\u001b\][0-9][0-9][0-9];.*?\u001b\\/g,
                    /\u001b\][0-9];.*?\u0007/g,
                    /\u001b\][0-9][0-9];.*?\u0007/g,
                    /\u001b\][0-9][0-9][0-9];.*?\u0007/g
                ];

                let cleanedText = text;
                ansiRegex.forEach(regex => {
                    cleanedText = cleanedText.replace(regex, '');
                });

                return cleanedText;
            }

            // Utility methods
            formatFileDate(timestamp) {
                const date = new Date(timestamp);
                const now = new Date();

                // Â∞ÜÊó•ÊúüÂΩíÈõ∂Âà∞ÂΩìÂ§© 00:00:00 Êù•ËÆ°ÁÆóÂ§©Êï∞Â∑Æ
                const dateDay = new Date(date.getFullYear(), date.getMonth(), date.getDate());
                const nowDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const diffTime = nowDay - dateDay;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays === 0) {
                    return this.languageManager.get('today') + ' ' + date.toLocaleTimeString({ hour: '2-digit', minute: '2-digit' });
                } else if (diffDays === 1) {
                    return this.languageManager.get('yesterday') + ' ' + date.toLocaleTimeString({ hour: '2-digit', minute: '2-digit' });
                } else if (diffDays >= 2 && diffDays <= 6) {
                    return `${diffDays}${this.languageManager.get('daysAgo')}` + ' ' + date.toLocaleTimeString({ hour: '2-digit', minute: '2-digit' });
                } else {
                    return date.toLocaleString();
                }
            }

            // Search all files method for DataManager to use
            async searchInAllFilesDirectly(searchTerm, searchOptions) {
                const results = [];

                if (!this.directoryHandle) {
                    console.warn('No directory handle available');
                    return results;
                }

                // Get all projects and files
                const allFiles = [];
                Object.values(this.projectData.projects).forEach(project => {
                    if (project.files && project.files.length > 0) {
                        allFiles.push(...project.files);
                    }
                });

                // Search through each file
                for (const file of allFiles) {
                    try {
                        const fileObj = await file.handle.getFile();
                        const content = await fileObj.text();
                        const fileName = fileObj.name;

                        // Find project for this file
                        let projectPath = null;
                        let projectName = null;
                        for (const [path, project] of Object.entries(this.projectData.projects)) {
                            if (project.files && project.files.some(f => f.name === fileName)) {
                                projectPath = path;
                                projectName = project.name || path;
                                break;
                            }
                        }

                        // Search in filename if enabled
                        if (searchOptions.includeFilenames) {
                            const filenameMatches = this.searchTextInContent(fileName, searchTerm, searchOptions);
                            if (filenameMatches.length > 0) {
                                results.push({
                                    type: 'filename',
                                    file: fileName,
                                    filePath: projectPath,
                                    projectName: projectName,
                                    lastModified: file.lastModified,
                                    matches: filenameMatches,
                                    sessionId: null,
                                    messageIndex: null,
                                    content: fileName
                                });
                            }
                        }

                        // Parse and search in file content
                        const sessions = await this.parseJSONLForSearch(content, fileName);
                        for (const session of sessions) {
                            if (!session.messages) continue;

                            for (let i = 0; i < session.messages.length; i++) {
                                const message = session.messages[i];
                                const messageContent = this.extractMessageContentForSearch(message);

                                if (messageContent && messageContent.length > 0) {
                                    const contentMatches = this.searchTextInContent(messageContent, searchTerm, searchOptions);
                                    if (contentMatches.length > 0) {
                                        results.push({
                                            type: 'content',
                                            file: fileName,
                                            filePath: projectPath,
                                            projectName: projectName,
                                            lastModified: file.lastModified,
                                            matches: contentMatches,
                                            sessionId: session.id,
                                            sessionTitle: session.title || this.languageManager.get('unknownSession'),
                                            messageIndex: i,
                                            messageType: message.type || message.role || this.languageManager.get('unknownType'),
                                            content: messageContent,
                                            timestamp: message.timestamp || session.startTime
                                        });
                                    }
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Error searching file:', file.name, error);
                    }
                }

                return results;
            }

            // Helper method to parse JSONL for searching (lightweight version)
            async parseJSONLForSearch(content, fileName) {
                const lines = content.split('\n').filter(line => line.trim());
                const sessions = [];

                for (let i = 0; i < lines.length; i++) {
                    try {
                        // Skip lines that don't start with { or [ (likely not JSON)
                        const line = lines[i].trim();
                        if (!line.startsWith('{') && !line.startsWith('[')) {
                            continue;
                        }

                        const jsonData = JSON.parse(line);

                        // Extract basic info
                        let sessionId = jsonData.sessionId;
                        const timestamp = jsonData.timestamp;
                        const type = jsonData.type;

                        // Generate sessionId if not present
                        if (!sessionId) {
                            sessionId = fileName.replace(/\.[^/.]+$/, '');
                        }

                        // Find or create session
                        let session = sessions.find(s => s.id === sessionId);
                        if (!session) {
                            session = {
                                id: sessionId,
                                messages: [],
                                startTime: timestamp,
                                endTime: timestamp
                            };
                            sessions.push(session);
                        }

                        // Update session time range
                        if (timestamp < session.startTime) {
                            session.startTime = timestamp;
                        }
                        if (timestamp > session.endTime) {
                            session.endTime = timestamp;
                        }

                        // Create message object
                        const message = {
                            timestamp: timestamp,
                            type: type,
                            rawData: jsonData
                        };

                        // Extract content based on type using DataManager methods
                        if (type === 'user') {
                            message.role = 'user';
                            message.content = this.extractUserContent(jsonData);
                        } else if (type === 'assistant') {
                            message.role = 'assistant';
                            message.content = this.extractAssistantContent(jsonData);
                        }

                        // Add to session
                        session.messages.push(message);

                    } catch (error) {
                        // Ignore parsing errors
                    }
                }

                // Sort messages by time
                sessions.forEach(session => {
                    if (session.messages) {
                        session.messages.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    }
                });

                return sessions;
            }

            // Helper method to extract message content for searching
            extractMessageContentForSearch(message) {
                const content = [];

                // Main content
                if (message.content) {
                    if (typeof message.content === 'string') {
                        content.push(message.content);
                    } else if (Array.isArray(message.content)) {
                        content.push(...message.content.map(item =>
                            typeof item === 'string' ? item : (item.text || '')
                        ));
                    }
                }

                // Try to extract content from other possible fields
                if (message.text) {
                    content.push(message.text);
                }

                if (message.input) {
                    if (typeof message.input === 'string') {
                        content.push(message.input);
                    } else if (typeof message.input === 'object') {
                        content.push(JSON.stringify(message.input));
                    }
                }

                // Tool calls and results
                if (message.tool_calls) {
                    message.tool_calls.forEach(toolCall => {
                        if (toolCall.function && toolCall.function.name) {
                            content.push(toolCall.function.name);
                            if (toolCall.function.arguments) {
                                content.push(toolCall.function.arguments);
                            }
                        }
                    });
                }

                if (message.function_call) {
                    if (message.function_call.name) {
                        content.push(message.function_call.name);
                    }
                    if (message.function_call.arguments) {
                        content.push(message.function_call.arguments);
                    }
                }

                if (message.result && typeof message.result === 'string') {
                    content.push(message.result);
                } else if (message.result && typeof message.result === 'object') {
                    content.push(JSON.stringify(message.result));
                }

                // Add message type/role as searchable content
                if (message.type) {
                    content.push(message.type);
                }
                if (message.role) {
                    content.push(message.role);
                }

                return content.join(' ');
            }

            // Helper method to search text with options
            searchTextInContent(text, searchTerm, searchOptions) {
                const matches = [];

                if (!text || !searchTerm) return matches;

                let searchRegex;
                try {
                    if (searchOptions.useRegex) {
                        searchRegex = new RegExp(searchTerm, searchOptions.caseSensitive ? 'g' : 'gi');
                    } else {
                        const pattern = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                        searchRegex = new RegExp(pattern, searchOptions.caseSensitive ? 'g' : 'gi');
                    }
                } catch (error) {
                    console.warn('Invalid search pattern:', error);
                    return matches;
                }

                let match;
                while ((match = searchRegex.exec(text)) !== null) {
                    matches.push({
                        text: match[0],
                        index: match.index,
                        length: match[0].length
                    });
                }

                return matches;
            }
        }


        // File browser component
        class FileBrowser extends HTMLElement {
            constructor() {
                super();
                this.dataManager = window.dataManager;
                this.styleManager = window.styleManager || new StyleManager();
                this.languageManager = window.languageManager;
                this.attachShadow({ mode: 'open' });
                this.projectData = null;
            }

            connectedCallback() {
                this.render();

                // Listen for theme changes
                document.addEventListener('themeChanged', (event) => {
                    this.handleThemeChanged(event.detail);
                });

                // Add search button event listener
                this.attachSearchButtonListener();
            }

            attachSearchButtonListener() {
                // Use setTimeout to ensure the DOM is fully rendered
                setTimeout(() => {
                    const searchBtn = this.shadowRoot.getElementById('fileBrowserSearchBtn');
                    if (searchBtn) {
                        searchBtn.addEventListener('click', () => {
                            // Dispatch event to parent app to open search modal
                            document.dispatchEvent(new CustomEvent('openSearchModal'));
                        });
                    }
                }, 100);
            }

            handleThemeChanged(themeDetails) {
                // Update CSS variables in shadow DOM
                const style = document.createElement('style');
                style.textContent = `
                    :host {
                        --bg-primary: ${themeDetails.colors.bg.primary};
                        --bg-secondary: ${themeDetails.colors.bg.secondary};
                        --bg-tertiary: ${themeDetails.colors.bg.tertiary};
                        --bg-quaternary: ${themeDetails.colors.bg.quaternary};

                        --text-primary: ${themeDetails.colors.text.primary};
                        --text-secondary: ${themeDetails.colors.text.secondary};
                        --text-tertiary: ${themeDetails.colors.text.tertiary};
                        --text-quaternary: ${themeDetails.colors.text.quaternary};
                        --text-inverse: ${themeDetails.colors.text.inverse};

                        --border-primary: ${themeDetails.colors.border.primary};
                        --border-secondary: ${themeDetails.colors.border.secondary};
                        --border-tertiary: ${themeDetails.colors.border.tertiary};

                        --button-primary: ${themeDetails.colors.button.primary};
                        --button-primary-hover: ${themeDetails.colors.button.primaryHover};
                        --button-secondary: ${themeDetails.colors.button.secondary};
                        --button-secondary-hover: ${themeDetails.colors.button.secondaryHover};

                        --shadow-color: ${themeDetails.colors.bg.primary === '#ffffff' ? 'rgba(0, 0, 0, 0.1)' : 'rgba(0, 0, 0, 0.3)'};
                    }
                `;

                // Remove old theme style if exists
                const oldStyle = this.shadowRoot.getElementById('theme-style');
                if (oldStyle) {
                    oldStyle.remove();
                }

                style.id = 'theme-style';
                this.shadowRoot.appendChild(style);
            }

            render() {
                this.shadowRoot.innerHTML = `
            <style>
                ${this.styleManager.generateTailwindStyles()}
                ${this.styleManager.getFileBrowserStyles()}
            </style>
            <div class="claude-file-browser-container p-4 hidden" id="projectStructure">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-lg font-semibold flex items-center" style="color: var(--text-primary);">
                        <span class="mr-2" style="color: var(--button-primary);">üìä</span>
                        <span id="projectStructureTitle">${this.languageManager.get('projectStructure')}</span>
                    </h2>
                    <button id="fileBrowserSearchBtn" class="px-3 py-2 rounded text-sm transition-colors border-0 flex items-center hover-scale" style="background-color: var(--button-primary); color: var(--text-inverse);">
                        <span class="mr-1">üîç</span>
                        <span>${this.languageManager.get('search')}</span>
                    </button>
                </div>
                <div id="fileTree" class="claude-file-tree">
                    <!-- File tree will be dynamically generated -->
                </div>
            </div>
        `;
            }

            updateProject(projectData) {
                this.projectData = projectData;
                this.show();
                this.generateFileTree();
                this.loadFilePreviews();
            }

            show() {
                this.shadowRoot.getElementById('projectStructure').classList.remove('hidden');
            }

            hide() {
                this.shadowRoot.getElementById('projectStructure').classList.add('hidden');
            }

            generateFileTree() {
                const fileTree = this.shadowRoot.getElementById('fileTree');
                fileTree.innerHTML = '';

                if (!this.projectData || !this.projectData.projects) {
                    fileTree.innerHTML = `<div class="empty-state">${this.languageManager.get('noProjectData')}</div>`;
                    return;
                }

                // Add project name
                const directoryHandle = this.dataManager.getDirectoryHandle();
                if (directoryHandle) {
                    const projectHeader = document.createElement('div');
                    projectHeader.className = 'text-sm font-medium mb-2 flex items-center';
                    projectHeader.style.cssText = 'color: var(--text-secondary);';
                    projectHeader.innerHTML = `<span class="folder-icon">üìÅ</span> ${directoryHandle.name}`;
                    fileTree.appendChild(projectHeader);
                }

                // Add file list
                const fileList = document.createElement('div');
                fileList.className = 'ml-2 space-y-1';

                // Organize file structure - show all projects
                Object.values(this.projectData.projects).forEach(project => {
                    // Sort files by time (newest first)
                    if (project.files && project.files.length > 0) {
                        project.files.sort((a, b) => b.lastModified - a.lastModified);
                    }
                    const projectElement = this.createProjectElement(project);
                    fileList.appendChild(projectElement);
                });

                fileTree.appendChild(fileList);
            }

            createProjectElement(project) {
                const element = document.createElement('div');
                element.className = 'claude-tree-node';
                element.setAttribute('data-path', project.path);
                element.setAttribute('data-project-name', project.name || 'unnamed');

                const projectHeader = document.createElement('div');
                projectHeader.className = 'flex items-center py-1 cursor-pointer';

                const toggle = document.createElement('span');
                toggle.className = 'claude-tree-toggle';
                toggle.innerHTML = '<span class="text-xs">‚ñ∂</span>';

                const icon = document.createElement('span');
                icon.className = 'folder-icon';
                icon.textContent = 'üìÅ';

                const name = document.createElement('span');
                name.className = 'text-sm';
                name.style.cssText = 'color: var(--text-primary);';
                name.textContent = project.name || this.languageManager.get('unnamedProject');

                projectHeader.appendChild(toggle);
                projectHeader.appendChild(icon);
                projectHeader.appendChild(name);

                const childrenContainer = document.createElement('div');
                childrenContainer.className = 'claude-tree-children hidden';

                // Add files in project
                if (project.files && project.files.length > 0) {
                    project.files.forEach(file => {
                        const fileElement = this.createFileElement(file);
                        childrenContainer.appendChild(fileElement);
                    });
                }

                // Click to expand/collapse project
                projectHeader.addEventListener('click', function (e) {
                    e.stopPropagation();
                    childrenContainer.classList.toggle('hidden');
                    if (childrenContainer.classList.contains('hidden')) {
                        toggle.innerHTML = '<span class="text-xs">‚ñ∂</span>';
                    } else {
                        toggle.innerHTML = '<span class="text-xs">‚ñº</span>';
                    }
                });

                element.appendChild(projectHeader);
                element.appendChild(childrenContainer);

                return element;
            }

            createFileElement(file) {
                const element = document.createElement('div');
                element.className = 'claude-file-item flex flex-col cursor-pointer ml-4 text-sm border-0';

                // File icon and date
                const fileHeader = document.createElement('div');
                fileHeader.className = 'flex items-center';

                // File icon
                const fileIcon = document.createElement('span');
                fileIcon.className = 'file-icon';
                fileIcon.textContent = 'üìÑ';

                // File date
                const fileDate = document.createElement('span');
                fileDate.className = 'font-medium';
                fileDate.style.cssText = 'color: var(--text-secondary);';
                fileDate.textContent = this.dataManager.formatFileDate(file.lastModified);

                fileHeader.appendChild(fileIcon);
                fileHeader.appendChild(fileDate);

                // File preview
                const filePreview = document.createElement('div');
                filePreview.className = 'claude-file-preview mt-1 ml-4';
                filePreview.textContent = this.languageManager.get('loadingPreview');
                filePreview.setAttribute('data-file-name', file.name);

                element.appendChild(fileHeader);
                element.appendChild(filePreview);

                // Click file to load content
                element.addEventListener('click', async () => {
                    // Remove previous selection
                    this.shadowRoot.querySelectorAll('.claude-file-item').forEach(item => {
                        if (item.classList.contains('claude-active-file')) {
                            this.resetTextColors(item);
                        }
                        item.classList.remove('claude-active-file');
                    });

                    // Add current selection
                    element.classList.add('claude-active-file');

                    // Force text color update to override inline styles
                    this.forceTextColorUpdate(element);

                    await this.loadFileContent(file);
                    console.log('File loaded:', file.name);
                });

                return element;
            }

            async loadFileContent(file) {
                try {
                    // Reset current file data
                    this.dataManager.projectData.currentFileSessions = [];
                    this.dataManager.projectData.currentSessionIndex = 0;

                    // Read file content
                    const fileObj = await file.handle.getFile();
                    const content = await fileObj.text();

                    // Parse JSONL file
                    await this.dataManager.parseJSONL(content, file.name);

                    // Show session or empty state
                    const mainApp = document.querySelector('claude-history-app');
                    let messageViewer = null;

                    if (mainApp) {
                        messageViewer = mainApp.getMessageViewer();
                    } else {
                        // Fallback: try to find message viewer in document
                        messageViewer = document.querySelector('message-viewer');
                    }

                    console.log('Message viewer found:', !!messageViewer);
                    console.log('Sessions found:', this.dataManager.projectData.currentFileSessions.length);

                    if (messageViewer) {
                        if (this.dataManager.projectData.currentFileSessions.length === 0) {
                            console.log('Showing no sessions state');
                            messageViewer.showNoSessions();
                        } else {
                            // Show first session by default
                            this.dataManager.projectData.currentSessionIndex = 0;
                            const sessionId = this.dataManager.projectData.currentFileSessions[0];
                            const session = this.dataManager.projectData.sessions[sessionId];
                            console.log('Showing session:', sessionId, session);
                            messageViewer.showSession(session);
                        }
                    } else {
                        console.error('Message viewer not found!');
                    }

                } catch (error) {
                    console.error('loadFileContent error:', error);
                    alert(`${this.languageManager.get('readFileError')}: ${error.message}`);
                }
            }

            async loadFilePreviews() {
                if (!this.projectData || !this.projectData.projects) return;

                const allFiles = [];
                Object.values(this.projectData.projects).forEach(project => {
                    if (project.files && project.files.length > 0) {
                        allFiles.push(...project.files);
                    }
                });

                // Load previews asynchronously
                for (let i = 0; i < allFiles.length; i++) {
                    setTimeout(() => this.loadFilePreview(allFiles[i]), 300);
                }
            }

            async loadFilePreview(file) {
                try {
                    const fileObj = await file.handle.getFile();
                    const content = await fileObj.text();
                    const fileName = fileObj.name;

                    // Parse JSONL for preview
                    const sessions = await this.parseJSONLForPreview(content, fileName);

                    // Update file preview element
                    this.updateFilePreviewElement(file, sessions);

                } catch (error) {
                    console.error('loadFilePreview error:', file.name, error);
                    this.updateFilePreviewElement(file, []);
                }
            }

            async parseJSONLForPreview(content, fileName) {
                const lines = content.split('\n').filter(line => line.trim());
                const sessions = [];

                for (let i = 0; i < lines.length; i++) {
                    try {
                        // Skip lines that don't start with { or [ (likely not JSON)
                        const line = lines[i].trim();
                        if (!line.startsWith('{') && !line.startsWith('[')) {
                            continue;
                        }

                        const jsonData = JSON.parse(line);

                        // Extract basic info
                        let sessionId = jsonData.sessionId;
                        const timestamp = jsonData.timestamp;
                        const type = jsonData.type;

                        // Generate sessionId if not present
                        if (!sessionId) {
                            sessionId = fileName.replace(/\.[^/.]+$/, '');
                        }

                        // Find or create session
                        let session = sessions.find(s => s.id === sessionId);
                        if (!session) {
                            session = {
                                id: sessionId,
                                messages: [],
                                startTime: timestamp,
                                endTime: timestamp
                            };
                            sessions.push(session);
                        }

                        // Update session time range
                        if (timestamp < session.startTime) {
                            session.startTime = timestamp;
                        }
                        if (timestamp > session.endTime) {
                            session.endTime = timestamp;
                        }

                        // Create message object
                        const message = {
                            timestamp: timestamp,
                            type: type,
                            rawData: jsonData
                        };

                        // Extract content based on type
                        if (type === 'user') {
                            message.role = 'user';
                            message.content = this.dataManager.extractUserContent(jsonData);
                        } else if (type === 'assistant') {
                            message.role = 'assistant';
                            message.content = this.dataManager.extractAssistantContent(jsonData);
                        }

                        // Add to session
                        session.messages.push(message);

                    } catch (error) {
                        // Silently skip malformed JSON lines (likely debug logs)
                        // Only log in development mode
                        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                            console.debug('parseJSONLForPreview skipping line ' + (i + 1) + ':', lines[i]?.substring(0, 50) + '...');
                        }
                    }
                }

                // Sort messages by time
                sessions.forEach(session => {
                    if (session.messages) {
                        session.messages.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    }
                });

                return sessions;
            }

            updateFilePreviewElement(file, sessions) {
                // Find corresponding file element by data-file-name attribute using direct selector
                const previewElement = this.shadowRoot.querySelector(`.claude-file-preview[data-file-name="${file.name}"]`);

                if (!previewElement) return;

                if (sessions.length === 0) {
                    previewElement.textContent = this.languageManager.get('noValidSessions');
                    previewElement.classList.remove('text-gray-500');
                    previewElement.classList.add('text-gray-400');
                } else {
                    // Get first user message from first session as preview
                    const firstSession = sessions[0];
                    if (firstSession && firstSession.messages && firstSession.messages.length > 0) {
                        // Find the first user message specifically
                        const firstUserMessage = firstSession.messages.find(msg => msg.role === 'user' && msg?.content != 'Warmup');
                        let previewText = firstUserMessage ? firstUserMessage.content : this.languageManager.get('noUserMessage');

                        if (previewText.length > 100) {
                            previewText = previewText.substring(0, 100) + '...';
                        }

                        previewElement.textContent = `(${firstSession.messages.length})` + previewText;
                        previewElement.classList.remove('text-gray-500');
                        previewElement.classList.add('text-gray-600');
                    } else {
                        previewElement.textContent = this.languageManager.get('noMessageContent');
                        previewElement.classList.remove('text-gray-500');
                        previewElement.classList.add('text-gray-400');
                    }
                }
            }

            expandAll() {
                const treeChildren = this.shadowRoot.querySelectorAll('.claude-tree-children');
                if (treeChildren.length === 0) return;

                treeChildren.forEach(el => {
                    el.classList.remove('hidden');
                });
                this.shadowRoot.querySelectorAll('.claude-tree-toggle').forEach(toggle => {
                    toggle.innerHTML = '<span class="text-xs">‚ñº</span>';
                });
            }

            collapseAll() {
                const treeChildren = this.shadowRoot.querySelectorAll('.claude-tree-children');
                if (treeChildren.length === 0) return;

                treeChildren.forEach(el => {
                    el.classList.add('hidden');
                });
                this.shadowRoot.querySelectorAll('.claude-tree-toggle').forEach(toggle => {
                    toggle.innerHTML = '<span class="text-xs">‚ñ∂</span>';
                });
            }

            updateLanguage() {
                // Update file browser UI elements with current language
                const projectStructureTitle = this.shadowRoot.getElementById('projectStructureTitle');
                if (projectStructureTitle) {
                    projectStructureTitle.textContent = this.languageManager.get('projectStructure');
                }

                // Update file previews if they exist
                const loadingPreviews = this.shadowRoot.querySelectorAll('.claude-file-preview');
                loadingPreviews.forEach(preview => {
                    if (preview.textContent === this.languageManager.get('loadingPreview') ||
                        preview.textContent === 'Âä†ËΩΩ‰∏≠...') {
                        preview.textContent = this.languageManager.get('loadingPreview');
                    }
                });
            }

            forceTextColorUpdate(element) {
                // Force update all text elements inside the active file item
                const textElements = element.querySelectorAll('*');
                textElements.forEach(el => {
                    if (el.style.color) {
                        el.style.setProperty('color', '#ffffff', 'important');
                    }
                });

                // Handle specific elements
                const fileDate = element.querySelector('.font-medium');
                if (fileDate) {
                    fileDate.style.setProperty('color', '#ffffff', 'important');
                }

                const filePreview = element.querySelector('.claude-file-preview');
                if (filePreview) {
                    filePreview.style.setProperty('color', 'rgba(255, 255, 255, 0.9)', 'important');
                }

                const icons = element.querySelectorAll('.file-icon, .folder-icon');
                icons.forEach(icon => {
                    icon.style.setProperty('color', '#ffffff', 'important');
                });
            }

            resetTextColors(element) {
                // Reset text colors when element is no longer active
                const textElements = element.querySelectorAll('*');
                textElements.forEach(el => {
                    if (el.style.color && el.style.getPropertyPriority('color') === 'important') {
                        el.style.removeProperty('color');
                    }
                });

                // Reset specific elements
                const fileDate = element.querySelector('.font-medium');
                if (fileDate) {
                    fileDate.style.removeProperty('color');
                    fileDate.style.setProperty('color', 'var(--text-secondary)');
                }

                const filePreview = element.querySelector('.claude-file-preview');
                if (filePreview) {
                    filePreview.style.removeProperty('color');
                }
            }
        }


        // Message viewer component
        class MessageViewer extends HTMLElement {
            constructor() {
                super();
                this.dataManager = window.dataManager;
                this.styleManager = window.styleManager || new StyleManager();
                this.languageManager = window.languageManager;
                this.attachShadow({ mode: 'open' });
            }

            connectedCallback() {
                this.render();
                this.showInitialState();

                // Listen for theme changes
                document.addEventListener('themeChanged', (event) => {
                    this.handleThemeChanged(event.detail);
                });
            }

            handleThemeChanged(themeDetails) {
                // Update CSS variables in shadow DOM
                const style = document.createElement('style');
                style.textContent = `
                    :host {
                        --bg-primary: ${themeDetails.colors.bg.primary};
                        --bg-secondary: ${themeDetails.colors.bg.secondary};
                        --bg-tertiary: ${themeDetails.colors.bg.tertiary};
                        --bg-quaternary: ${themeDetails.colors.bg.quaternary};

                        --text-primary: ${themeDetails.colors.text.primary};
                        --text-secondary: ${themeDetails.colors.text.secondary};
                        --text-tertiary: ${themeDetails.colors.text.tertiary};
                        --text-quaternary: ${themeDetails.colors.text.quaternary};
                        --text-inverse: ${themeDetails.colors.text.inverse};

                        --border-primary: ${themeDetails.colors.border.primary};
                        --border-secondary: ${themeDetails.colors.border.secondary};
                        --border-tertiary: ${themeDetails.colors.border.tertiary};

                        --button-primary: ${themeDetails.colors.button.primary};
                        --button-primary-hover: ${themeDetails.colors.button.primaryHover};
                        --button-secondary: ${themeDetails.colors.button.secondary};
                        --button-secondary-hover: ${themeDetails.colors.button.secondaryHover};

                        --shadow-color: ${themeDetails.colors.bg.primary === '#ffffff' ? 'rgba(0, 0, 0, 0.1)' : 'rgba(0, 0, 0, 0.3)'};
                    }
                `;

                // Remove old theme style if exists
                const oldStyle = this.shadowRoot.getElementById('theme-style');
                if (oldStyle) {
                    oldStyle.remove();
                }

                style.id = 'theme-style';
                this.shadowRoot.appendChild(style);
            }

            render() {
                this.shadowRoot.innerHTML = `
            <style>
                ${this.styleManager.generateTailwindStyles()}
                ${this.styleManager.getMessageViewerStyles()}
            </style>
            <div id="conversationDetail" class="message-viewer-container p-4 h-full hidden flex flex-col">
                <h2 class="text-lg font-semibold mb-4 flex items-center" style="color: var(--text-primary);">
                    <span class="mr-2" style="color: var(--button-primary);">üí¨</span>${this.languageManager.get('conversationDetails')}
                </h2>
                <div id="conversationContent" class="flex-1">
                    <!-- Conversation content will be dynamically generated -->
                </div>
            </div>

            <!-- Initial state -->
            <div id="initialState"
                class="message-viewer-container p-6 h-full flex flex-col items-center justify-center text-center">
                <span class="text-5xl mb-4" style="color: var(--text-quaternary);">üìÅ</span>
                <h3 class="text-xl font-semibold mb-2" style="color: var(--text-primary);">${this.languageManager.get('initialStateTitle')}</h3>
                <p class="max-w-md" style="color: var(--text-secondary);">${this.languageManager.get('initialStateDescription')}</p>
            </div>
        `;
            }

            showInitialState() {
                this.shadowRoot.getElementById('initialState').classList.remove('hidden');
                this.shadowRoot.getElementById('conversationDetail').classList.add('hidden');
            }

            showLoading() {
                this.shadowRoot.getElementById('initialState').classList.add('hidden');
                this.shadowRoot.getElementById('conversationDetail').classList.remove('hidden');

                const content = this.shadowRoot.getElementById('conversationContent');
                content.innerHTML = `
            <div class="text-center text-gray-500 py-8">
                <div class="loading-spinner mb-4"></div>
                <p class="text-md">${this.languageManager.get('loading')}</p>
            </div>
        `;
            }

            showProjectOverview(projectData) {
                this.shadowRoot.getElementById('initialState').classList.add('hidden');
                this.shadowRoot.getElementById('conversationDetail').classList.remove('hidden');

                const content = this.shadowRoot.getElementById('conversationContent');

                // Calculate file count
                let fileCount = 0;
                Object.values(projectData.projects).forEach(project => {
                    fileCount += project.files ? project.files.length : 0;
                });

                const directoryHandle = this.dataManager.getDirectoryHandle();

                content.innerHTML = `
            <div class="mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-2">${this.languageManager.get('projectOverview')}</h2>
                <p class="text-gray-600">${this.languageManager.get('projectFolderLabel')}: <span class="font-medium">${directoryHandle.name}</span></p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="bg-white border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center">
                        <div class="bg-blue-100 p-3 rounded-full mr-4">
                            <span class="text-blue-500">üìÅ</span>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">${this.languageManager.get('projectCount')}</p>
                            <p class="text-2xl font-bold text-gray-800">${Object.keys(projectData.projects).length}</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center">
                        <div class="bg-green-100 p-3 rounded-full mr-4">
                            <span class="text-green-500">üìÑ</span>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">${this.languageManager.get('jsonlFiles')}</p>
                            <p class="text-2xl font-bold text-gray-800">${fileCount}</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <h3 class="text-lg font-semibold text-blue-800 mb-2">${this.languageManager.get('nextStep')}</h3>
                <p class="text-blue-700">${this.languageManager.get('nextStepDescription')}</p>
            </div>
        `;
            }

            showNoSessions() {
                this.shadowRoot.getElementById('initialState').classList.add('hidden');
                this.shadowRoot.getElementById('conversationDetail').classList.remove('hidden');

                const content = this.shadowRoot.getElementById('conversationContent');
                content.innerHTML = `
            <div class="text-center text-gray-500 py-8">
                <span class="text-3xl mb-3">üö´</span>
                <p class="text-md">${this.languageManager.get('noSessionsFound')}</p>
                <p class="text-xs mt-1">${this.languageManager.get('noSessionsDescription')}</p>
            </div>
        `;
            }

            showSession(session) {
                this.shadowRoot.getElementById('initialState').classList.add('hidden');
                this.shadowRoot.getElementById('conversationDetail').classList.remove('hidden');

                const content = this.shadowRoot.getElementById('conversationContent');
                content.innerHTML = '';

                if (!session) {
                    content.innerHTML = `
                <div class="text-center text-gray-500 py-8">
                    <span class="text-3xl mb-3">‚ö†Ô∏è</span>
                    <p class="text-md">${this.languageManager.get('invalidSession')}</p>
                </div>
            `;
                    return;
                }

                // Add session header
                const header = document.createElement('div');
                header.className = 'mb-4 pb-3 border-b border-gray-200';
                header.innerHTML = `
            <div class="grid grid-cols-2 gap-2 text-xs text-gray-600 bg-white border border-gray-200 rounded-lg p-3">
                <div class="flex items-center">
                    <span class="mr-1">#</span>
                    <span class="truncate">${session.id || this.languageManager.get('unknownSession')}</span>
                </div>
                <div class="flex items-center">
                    <span class="mr-1">üïê</span>
                    <span>${session.startTime ? new Date(session.startTime).toLocaleDateString(this.languageManager.getCurrentLanguage()) : this.languageManager.get('unknownSession')}</span>
                </div>
                <div class="flex items-center">
                    <span class="mr-1">üí¨</span>
                    <span>${this.languageManager.get('messagesCount')}: ${session.messages ? session.messages.length : 0}</span>
                </div>
                <div class="flex items-center">
                    <span class="mr-1">üìÑ</span>
                    <span class="truncate">${session.fileName || this.languageManager.get('unknownSession')}</span>
                </div>
            </div>
        `;
                content.appendChild(header);

                // Add messages
                const messagesContainer = document.createElement('div');
                messagesContainer.className = 'space-y-3';

                if (!session.messages || session.messages.length === 0) {
                    messagesContainer.innerHTML = `
                <div class="text-center text-gray-500 py-4">
                    <span class="text-2xl mb-2">üö´</span>
                    <p class="text-sm">${this.languageManager.get('noMessagesInSession')}</p>
                </div>
            `;
                } else {
                    session.messages.forEach((message, index) => {
                        // Add index to message for navigation
                        message.index = index;
                        const messageElement = this.createMessageElement(message);
                        messagesContainer.appendChild(messageElement);
                    });
                }

                content.appendChild(messagesContainer);

                // Add event listeners for diff buttons
                setTimeout(() => {
                    this.attachDiffButtonListeners(content);
                    this.enhanceDiffButtonStyles(content);
                }, 0);
            }

            createMessageElement(message) {
                const messageElement = document.createElement('div');

                // Add message index for navigation
                if (message.index !== undefined) {
                    messageElement.setAttribute('data-message-index', message.index);
                }

                if (message.role === 'user') {
                    messageElement.className = 'message-user p-3 rounded-lg';
                    messageElement.innerHTML = `
                <div class="flex items-center mb-1">
                    <span class="text-blue-500 mr-2 text-sm">üë§</span>
                    <span class="font-medium text-sm">${this.languageManager.get('user')}</span>
                    <span class="text-xs ml-auto" style="color: var(--text-tertiary);">${message.timestamp ? new Date(message.timestamp).toLocaleTimeString(this.languageManager.getCurrentLanguage()) : this.languageManager.get('unknownSession')}</span>
                </div>
                <div class="whitespace-pre-wrap text-sm" style="color: var(--text-primary);">${this.convertTodoToHTML(message.content) || this.languageManager.get('noMessageContent')}</div>
                ${message.rawData && message.rawData.thinkingMetadata ? `
                    <div class="mt-1 text-xs" style="color: var(--text-tertiary);">
                        <span class="mr-1">üß†</span>${this.languageManager.get('thinkingMode')}: ${message.rawData.thinkingMetadata.level || this.languageManager.get('unknownSession')}
                    </div>
                ` : ''}
            `;
                } else if (message.role === 'summary') {
                    messageElement.className = 'message-summary p-3 rounded-lg';
                    messageElement.innerHTML = `
                <div class="flex items-center mb-1">
                    <span class="text-yellow-500 mr-2 text-sm">üìù</span>
                    <span class="font-medium text-sm">${this.languageManager.get('summary')}</span>
                    <span class="text-xs ml-auto" style="color: var(--text-tertiary);">${message.timestamp ? new Date(message.timestamp).toLocaleTimeString(this.languageManager.getCurrentLanguage()) : this.languageManager.get('unknownSession')}</span>
                </div>
                <div class="whitespace-pre-wrap text-sm message-content">${this.convertTodoToHTML(message.content) || this.languageManager.get('noMessageContent')}</div>
            `;
                } else if (message.role === 'system') {
                    messageElement.className = 'message-system p-3 rounded-lg';
                    messageElement.innerHTML = `
                <div class="flex items-center mb-1">
                    <span class="mr-2 text-sm" style="color: #f59e0b;">‚öôÔ∏è</span>
                    <span class="font-medium text-sm">${this.languageManager.get('system')}</span>
                    <span class="text-xs ml-auto" style="color: var(--text-tertiary);">${message.timestamp ? new Date(message.timestamp).toLocaleTimeString(this.languageManager.getCurrentLanguage()) : this.languageManager.get('unknownSession')}</span>
                </div>
                <div class="whitespace-pre-wrap text-sm message-content">${this.convertTodoToHTML(message.content) || this.languageManager.get('noMessageContent')}</div>
                ${message.rawData && message.rawData.subtype ? `
                    <div class="mt-1 text-xs" style="color: var(--text-tertiary);">
                        <span class="mr-1">üè∑Ô∏è</span>${this.languageManager.get('subtype')}: ${this.formatSubtype(message.rawData.subtype)}
                    </div>
                ` : ''}
            `;
                } else if (message.role === 'assistant') {
                    messageElement.className = 'message-assistant p-3 rounded-lg';

                    let modelInfo = '';
                    if (message.rawData && message.rawData.message && message.rawData.message.model) {
                        modelInfo = `<span class="text-xs px-1 py-0.5 rounded ml-1" style="background-color: #e9d5ff; color: #6b21a8;">${message.rawData.message.model}</span>`;
                    }

                    let contentElements = '';
                    let hasComplexContent = false;

                    // Check if we have complex content array
                    if (message.rawData &&
                        message.rawData.message &&
                        message.rawData.message.content &&
                        Array.isArray(message.rawData.message.content)) {

                        hasComplexContent = true;
                        contentElements = `<div class="mt-2 space-y-3">`;
                        message.rawData.message.content.forEach(item => {
                            contentElements += this.renderMessageContentItem(item);
                        });
                        contentElements += `</div>`;
                    }

                    // Handle simple text content
                    let simpleContent = '';
                    if (!hasComplexContent && message.content) {
                        simpleContent = `<div class="whitespace-pre-wrap text-sm" style="color: var(--text-primary);">${this.convertTodoToHTML(message.content) || this.languageManager.get('noMessageContent')}</div>`;
                    }

                    messageElement.innerHTML = `
                <div class="flex items-center mb-1">
                    <span class="text-green-500 mr-2 text-sm">ü§ñ</span>
                    <span class="font-medium text-sm">${this.languageManager.get('assistant')}</span>
                    ${modelInfo}
                    <span class="text-xs ml-auto" style="color: var(--text-tertiary);">${message.timestamp ? new Date(message.timestamp).toLocaleTimeString(this.languageManager.getCurrentLanguage()) : this.languageManager.get('unknownSession')}</span>
                </div>
                ${contentElements}
                ${simpleContent}
                ${message.rawData && message.rawData.message && message.rawData.message.usage ? `
                    <div class="mt-1 text-xs text-gray-500 flex space-x-3">
                        <span><span class="mr-1">üì•</span>${this.languageManager.get('inputTokens')}: ${message.rawData.message.usage.input_tokens || 0}</span>
                        <span><span class="mr-1">üì§</span>${this.languageManager.get('outputTokens')}: ${message.rawData.message.usage.output_tokens || 0}</span>
                    </div>
                ` : ''}
            `;
                } else {
                    // Handle other message types
                    messageElement.className = 'message-system p-3 rounded-lg';
                    messageElement.innerHTML = `
                <div class="flex items-center mb-1">
                    <span class="text-yellow-500 mr-2 text-sm">‚ùì</span>
                    <span class="font-medium text-sm">${message.type || this.languageManager.get('unknownType')}</span>
                    <span class="text-xs ml-auto" style="color: var(--text-tertiary);">${message.timestamp ? new Date(message.timestamp).toLocaleTimeString(this.languageManager.getCurrentLanguage()) : this.languageManager.get('unknownSession')}</span>
                </div>
                <div class="json-code">
                    <pre>${this.formatJSON(message.rawData || {})}</pre>
                </div>
            `;
                }

                return messageElement;
            }

            renderMessageContentItem(item) {
                switch (item.type) {
                    case 'text':
                        const textContent = this.convertTodoToHTML(item.text || '');
                        // Only show "ÊñáÊú¨ÂÜÖÂÆπ" label if there are multiple content types
                        const showLabel = false; // Simplified - no label for cleaner display 
                        return `
                    <div class="text-content">
                        ${showLabel ? '<div class="text-xs text-gray-500 mb-1">' + this.languageManager.get('textContent') + '</div>' : ''}
                        <div class="whitespace-pre-wrap text-sm" style="color: var(--text-primary);">${textContent}</div>
                    </div>
                `;

                    case 'summary':
                        const summaryContent = item.summary || '';
                        return `
                    <div class="summary-content bg-yellow-50 p-3 rounded border border-yellow-200">
                        <div class="text-xs text-yellow-600 mb-1">${this.languageManager.get('summary')}</div>
                        <div class="whitespace-pre-wrap summary-content-text">${summaryContent}</div>
                    </div>
                `;

                    case 'system':
                        const systemContent = item.content || '';
                        return `
                    <div class="system-content bg-blue-50 p-3 rounded border border-blue-200">
                        <div class="text-xs text-blue-600 mb-1">${this.languageManager.get('system')}Ê∂àÊÅØ</div>
                        <div class="whitespace-pre-wrap system-content-text">${systemContent}</div>
                    </div>
                `;

                    case 'tool_use':
                        return this.renderToolUseItem(item);

                    case 'tool_result':
                        return this.renderToolResultItem(item);

                    default:
                        return `
                    <div class="unknown-content">
                        <div class="text-xs text-gray-500 mb-1">${item.type || this.languageManager.get('unknownType')}</div>
                        <div class="json-code">
                            <pre>${this.formatJSON(item)}</pre>
                        </div>
                    </div>
                `;
                }
            }

            renderToolUseItem(item) {
                let toolDisplay = '';
                let comparisonButton = '';
                let showJsonDisplay = true;

                // Handle local-command-stdout
                if (item.name === 'local-command-stdout' && item.input && item.input.stdout) {
                    const cleanedStdout = this.dataManager.removeANSICodes(item.input.stdout);
                    toolDisplay = `
                <div class="p-3 rounded text-sm font-mono whitespace-pre-wrap overflow-x-auto command-output">
                    ${cleanedStdout}
                </div>
            `;
                }
                // Handle TodoWrite
                else if (item.name === 'TodoWrite' && item.input && item.input.todos) {
                    const todoHTML = this.renderTodoList(item.input.todos);
                    toolDisplay = `
                <div class="todo-container p-3 rounded" style="background-color: var(--bg-primary); border: 1px solid var(--border-primary);">
                    ${todoHTML}
                </div>
            `;
                }
                // Handle MultiEdit and Edit tools
                else if ((item.name === 'MultiEdit' || item.name === 'Edit') && item.input) {
                    let editsData = [];

                    if (item.name === 'Edit' && (item.input.old_string || item.input.new_string)) {
                        editsData.push({
                            old_string: item.input.old_string || '',
                            new_string: item.input.new_string || '',
                            file_path: item.input.file_path || 'Êñá‰ª∂'
                        });
                    }
                    else if (item.name === 'MultiEdit' && item.input.edits && Array.isArray(item.input.edits) && item.input.edits.length > 0) {
                        item.input.edits.forEach((edit, index) => {
                            if (edit.old_string || edit.new_string) {
                                editsData.push({
                                    old_string: edit.old_string || '',
                                    new_string: edit.new_string || '',
                                    file_path: edit.file_path || `ÁºñËæë ${index + 1}`
                                });
                            }
                        });
                    }

                    if (editsData.length > 0) {
                        const editId = 'edit_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                        this.dataManager.setEditData(editId, {
                            edits: editsData,
                            toolName: item.name
                        });

                        comparisonButton = `
                    <button class="diff-button"
                            data-edit-id="${editId}"
                            title="${this.languageManager.get('compareText')}${editsData.length > 1 ? ` (${editsData.length} ${this.languageManager.get('editsCount')})` : ''}"
                            style="
                                background: linear-gradient(145deg, #6366f1 0%, #8b5cf6 100%) !important;
                                color: #ffffff !important;
                                border: 1px solid rgba(255, 255, 255, 0.2) !important;
                                padding: 6px 14px !important;
                                border-radius: 10px !important;
                                cursor: pointer !important;
                                font-size: 12px !important;
                                font-weight: 600 !important;
                                transition: all 0.25s ease !important;
                                box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3) !important;
                                display: inline-flex !important;
                                align-items: center !important;
                                gap: 4px !important;
                                min-height: 32px !important;
                                margin-left: 8px !important;
                                text-transform: none !important;
                                text-shadow: none !important;
                                position: relative !important;
                                overflow: hidden !important;
                            ">
                        <span style="font-size: 14px !important; margin-right: 2px !important;">üîç</span>
                        <span>${this.languageManager.get('compareText')}</span>
                        ${editsData.length > 1 ? `<span style="
                            background: rgba(255, 255, 255, 0.25) !important;
                            color: #ffffff !important;
                            font-size: 10px !important;
                            padding: 2px 6px !important;
                            border-radius: 4px !important;
                            margin-left: 4px !important;
                            font-weight: 700 !important;
                        ">${editsData.length}</span>` : ''}
                    </button>
                `;

                        if (item.name === 'MultiEdit' || item.name === 'Edit') {
                            showJsonDisplay = false;
                        }
                    }
                }

                // Show JSON for other tools
                if (showJsonDisplay && item.input && !toolDisplay) {
                    toolDisplay = `
                <div class="json-code">
                    <pre>${this.formatJSON(item.input)}</pre>
                </div>
            `;
                }

                return `
            <div class="tool-call">
                <div class="tool-name flex items-center">
                    <span class="text-purple-500 mr-2">üõ†Ô∏è</span>
                    ${item.name || this.languageManager.get('unknownTool')}
                    ${comparisonButton}
                </div>
                ${toolDisplay}
            </div>
        `;
            }

            renderToolResultItem(item) {
                let resultDisplay = '';
                if (typeof item.content === 'string') {
                    // For Write tool outputs, display as plain text without HTML escaping
                    let displayContent = item.content;

                    // Only escape HTML tags for non-Write tool results
                    const hasHtmlTags = /<[^>]*>/.test(item.content);
                    if (hasHtmlTags) {
                        displayContent = item.content.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    }

                    resultDisplay = `
                <div class="bg-green-50 p-3 rounded border border-green-200">
                    <div class="text-xs text-green-600 mb-1">${this.languageManager.get('toolResult')}</div>
                    <div class="whitespace-pre-wrap" style="color: var(--text-primary);">${displayContent}</div>
                </div>
            `;
                } else {
                    resultDisplay = `
                <div class="json-code">
                    <pre>${this.formatJSON(item.content)}</pre>
                </div>
            `;
                }

                return `
            <div class="tool-result">
                <div class="tool-name flex items-center text-green-600">
                    <span class="mr-2">‚úÖ</span>
                    ${this.languageManager.get('toolResult')}
                </div>
                ${resultDisplay}
            </div>
        `;
            }

            attachDiffButtonListeners(content) {
                const diffButtons = content.querySelectorAll('.diff-button');
                diffButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const editId = button.getAttribute('data-edit-id');
                        if (editId) {
                            const editData = this.dataManager.getEditData(editId);
                            if (editData) {
                                this.showMultiEditComparison(editData.edits, editData.toolName);
                            }
                        }
                    });
                });
            }

            forceTextColorUpdate(element) {
                // Force update all text elements inside the active file item
                const textElements = element.querySelectorAll('*');
                textElements.forEach(el => {
                    if (el.style.color) {
                        el.style.setProperty('color', '#ffffff', 'important');
                    }
                });

                // Handle specific elements
                const fileDate = element.querySelector('.font-medium');
                if (fileDate) {
                    fileDate.style.setProperty('color', '#ffffff', 'important');
                }

                const filePreview = element.querySelector('.claude-file-preview');
                if (filePreview) {
                    filePreview.style.setProperty('color', 'rgba(255, 255, 255, 0.9)', 'important');
                }

                const icons = element.querySelectorAll('.file-icon, .folder-icon');
                icons.forEach(icon => {
                    icon.style.setProperty('color', '#ffffff', 'important');
                });
            }

            resetTextColors(element) {
                // Reset text colors when element is no longer active
                const textElements = element.querySelectorAll('*');
                textElements.forEach(el => {
                    if (el.style.color && el.style.getPropertyPriority('color') === 'important') {
                        el.style.removeProperty('color');
                    }
                });

                // Reset specific elements
                const fileDate = element.querySelector('.font-medium');
                if (fileDate) {
                    fileDate.style.removeProperty('color');
                    fileDate.style.setProperty('color', 'var(--text-secondary)');
                }

                const filePreview = element.querySelector('.claude-file-preview');
                if (filePreview) {
                    filePreview.style.removeProperty('color');
                }
            }

            enhanceDiffButtonStyles(content) {
                const diffButtons = content.querySelectorAll('.diff-button');
                diffButtons.forEach(button => {
                    // Add hover effects
                    button.addEventListener('mouseenter', () => {
                        button.style.transform = 'translateY(-2px) scale(1.02)';
                        button.style.boxShadow = '0 8px 20px rgba(99, 102, 241, 0.4), 0 4px 8px rgba(0, 0, 0, 0.1)';
                        button.style.background = 'linear-gradient(145deg, #7c3aed 0%, #a855f7 100%)';
                    });

                    button.addEventListener('mouseleave', () => {
                        button.style.transform = 'translateY(0) scale(1)';
                        button.style.boxShadow = '0 4px 12px rgba(99, 102, 241, 0.3)';
                        button.style.background = 'linear-gradient(145deg, #6366f1 0%, #8b5cf6 100%)';
                    });

                    button.addEventListener('mousedown', () => {
                        button.style.transform = 'translateY(0) scale(0.98)';
                        button.style.boxShadow = '0 2px 6px rgba(99, 102, 241, 0.2)';
                    });

                    button.addEventListener('mouseup', () => {
                        button.style.transform = 'translateY(-2px) scale(1.02)';
                        button.style.boxShadow = '0 8px 20px rgba(99, 102, 241, 0.4), 0 4px 8px rgba(0, 0, 0, 0.1)';
                    });

                    // Dark theme detection
                    const updateTheme = () => {
                        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                        if (isDark) {
                            button.style.background = 'linear-gradient(145deg, #4f46e5 0%, #7c3aed 100%)';
                            button.style.borderColor = 'rgba(255, 255, 255, 0.15)';
                        } else {
                            button.style.background = 'linear-gradient(145deg, #6366f1 0%, #8b5cf6 100%)';
                            button.style.borderColor = 'rgba(255, 255, 255, 0.2)';
                        }
                    };

                    // Initial theme setup
                    updateTheme();

                    // Listen for theme changes
                    const observer = new MutationObserver(updateTheme);
                    observer.observe(document.documentElement, {
                        attributes: true,
                        attributeFilter: ['data-theme']
                    });
                });
            }

            showMultiEditComparison(edits, toolName = '') {
                // Create modal
                const modal = document.createElement('div');
                modal.className = 'diff-modal';

                let modalContent = `
            <div class="diff-modal-content">
                <div class="diff-modal-header">
                    <h3 class="text-lg font-semibold" style="color: var(--text-primary);">${this.languageManager.get('textComparison')} - ${toolName} (${edits.length}${this.languageManager.get('editsCount')})</h3>
                    <button class="diff-button-secondary close-diff-modal">${this.languageManager.get('closeButton')}</button>
                </div>
                <div class="diff-edit-tabs">
        `;

                // Create edit tabs
                edits.forEach((edit, index) => {
                    const filePath = edit.file_path || `ÁºñËæë ${index + 1}`;
                    const isActive = index === 0 ? 'active' : '';
                    modalContent += `
                <button class="diff-edit-tab ${isActive}" data-edit-index="${index}">${filePath}</button>
            `;
                });

                modalContent += `
                </div>
                <div class="diff-modal-body">
                    <div class="diff-content-tabs">
                        <button class="diff-content-tab active" data-content-tab="original">${this.languageManager.get('originalText')}</button>
                        <button class="diff-content-tab" data-content-tab="new">${this.languageManager.get('newText')}</button>
                        <button class="diff-content-tab" data-content-tab="diff">${this.languageManager.get('diffComparison')}</button>
                    </div>
                    <div class="diff-content-area">
                        <div class="diff-panel active" id="original-panel">
                            <div class="diff-panel-header">${this.languageManager.get('originalText')}</div>
                            <textarea class="diff-textarea" id="original-textarea" readonly></textarea>
                        </div>
                        <div class="diff-panel" id="new-panel">
                            <div class="diff-panel-header">${this.languageManager.get('newText')}</div>
                            <textarea class="diff-textarea" id="new-textarea" readonly></textarea>
                        </div>
                        <div class="diff-panel" id="diff-panel">
                            <div class="diff-panel-header">${this.languageManager.get('diffComparison')}</div>
                            <div class="diff-comparison" id="diff-content"></div>
                        </div>
                    </div>
                </div>
            </div>
        `;

                // Set content first
                modal.innerHTML = modalContent;

                // Add styles to the modal
                const styleElement = document.createElement('style');
                styleElement.textContent = this.styleManager.getDiffModalStyles();
                modal.appendChild(styleElement);

                // Set theme attribute
                const currentTheme = this.styleManager.getThemeManager().getCurrentTheme();
                modal.setAttribute('data-theme', currentTheme);

                document.body.appendChild(modal);

                // Initialize first edit content
                this.updateEditContent(0, edits, modal);

                // Edit tab switching
                const editTabs = modal.querySelectorAll('.diff-edit-tab');
                editTabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        const editIndex = parseInt(tab.getAttribute('data-edit-index'));
                        editTabs.forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        this.updateEditContent(editIndex, edits, modal);
                    });
                });

                // Content tab switching
                const contentTabs = modal.querySelectorAll('.diff-content-tab');
                contentTabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        const contentTab = tab.getAttribute('data-content-tab');
                        contentTabs.forEach(t => t.classList.remove('active'));
                        modal.querySelectorAll('.diff-panel').forEach(p => p.classList.remove('active'));
                        tab.classList.add('active');
                        modal.querySelector(`#${contentTab}-panel`).classList.add('active');
                    });
                });

                // Close modal
                const closeBtn = modal.querySelector('.close-diff-modal');
                closeBtn.addEventListener('click', () => {
                    document.body.removeChild(modal);
                });

                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                });
            }

            updateEditContent(editIndex, edits, modal) {
                const edit = edits[editIndex];
                const oldText = edit.old_string || '';
                const newText = edit.new_string || '';

                modal.querySelector('#original-textarea').value = oldText;
                modal.querySelector('#new-textarea').value = newText;
                modal.querySelector('#diff-content').innerHTML = this.calculateTextDiff(oldText, newText);
            }

            calculateTextDiff(oldText, newText) {
                if (!oldText && !newText) {
                    return `<div class="diff-line diff-unchanged">${this.languageManager.get('noTextContent')}</div>`;
                }

                if (!oldText) {
                    return `<div class="diff-line diff-added">+ ${this.escapeHTML(newText)}</div>`;
                }

                if (!newText) {
                    return `<div class="diff-line diff-removed">- ${this.escapeHTML(oldText)}</div>`;
                }

                const oldLines = oldText.split('\n');
                const newLines = newText.split('\n');
                const maxLength = Math.max(oldLines.length, newLines.length);
                let diffHTML = '';

                for (let i = 0; i < maxLength; i++) {
                    const oldLine = oldLines[i] || '';
                    const newLine = newLines[i] || '';

                    if (oldLine === newLine) {
                        diffHTML += `<div class="diff-line diff-unchanged">  ${this.escapeHTML(oldLine)}</div>`;
                    } else {
                        if (oldLine) {
                            diffHTML += `<div class="diff-line diff-removed">- ${this.escapeHTML(oldLine)}</div>`;
                        }
                        if (newLine) {
                            diffHTML += `<div class="diff-line diff-added">+ ${this.escapeHTML(newLine)}</div>`;
                        }
                    }
                }

                return diffHTML || `<div class="diff-line diff-unchanged">${this.languageManager.get('noDifference')}</div>`;
            }

            escapeHTML(text) {
                if (!text) return '';
                return text
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
            }

            convertTodoToHTML(content) {
                if (!content) return content;

                // Handle string content
                if (typeof content === 'string') {
                    try {
                        // Try to parse JSON todo data
                        const todoData = JSON.parse(content);
                        if (todoData && todoData.todos && Array.isArray(todoData.todos)) {
                            return this.renderTodoList(todoData.todos);
                        }
                    } catch (error) {
                        // Handle old todo node format
                        const todoRegex = /\[todo\]([^\[]*?)\[\/todo\]/gi;
                        let result = content;

                        result = result.replace(todoRegex, (match, todoContent) => {
                            const trimmedContent = todoContent.trim();
                            if (!trimmedContent) return '';

                            return `<div class="flex items-start mb-1">
                        <input type="checkbox" class="mt-1 mr-2" disabled>
                        <span style="color: var(--text-primary);">${trimmedContent}</span>
                    </div>`;
                        });

                        return result;
                    }
                }

                // Handle object todo data
                if (typeof content === 'object' && content.todos && Array.isArray(content.todos)) {
                    return this.renderTodoList(content.todos);
                }

                return content;
            }

            renderTodoList(todos) {
                if (!todos || !Array.isArray(todos) || todos.length === 0) {
                    return `<div class="text-sm" style="color: var(--text-tertiary);">Êó†ÂæÖÂäû‰∫ãÈ°π</div>`;
                }

                let todoHTML = '<div class="todo-list space-y-2">';

                todos.forEach(todo => {
                    const status = todo.status || 'pending';
                    const todoContent = todo.content || '';
                    const isCompleted = status === 'completed';
                    const isInProgress = status === 'in_progress';

                    let statusStyle = 'color: var(--text-primary);';
                    let statusIcon = '';

                    if (isCompleted) {
                        statusStyle = 'color: #86efac; text-decoration: line-through;';
                        statusIcon = '<span class="mr-2" style="color: #22c55e;">‚úÖ</span>';
                    } else if (isInProgress) {
                        statusStyle = 'color: #60a5fa;';
                        statusIcon = '<span class="mr-2" style="color: #3b82f6;">‚è≥</span>';
                    } else {
                        statusIcon = '<span class="mr-2" style="color: var(--text-quaternary);">‚≠ï</span>';
                    }

                    todoHTML += `
                <div class="flex items-start p-2 rounded" style="background-color: var(--bg-secondary); border: 1px solid var(--border-primary);">
                    <div class="flex items-center flex-1">
                        ${statusIcon}
                        <span style="${statusStyle}">${todoContent}</span>
                    </div>
                    <span class="text-xs ml-2 px-2 py-1 rounded" style="color: var(--text-secondary); background-color: var(--bg-tertiary);">${status}</span>
                </div>
            `;
                });

                todoHTML += '</div>';
                return todoHTML;
            }

            formatJSON(obj) {
                try {
                    return JSON.stringify(obj, null, 2)
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"([^"]+)":/g, '<span class="json-key">"$1"</span>:')
                        .replace(/: "([^"]*)"/g, ': <span class="json-string">"$1"</span>')
                        .replace(/: (\d+)/g, ': <span class="json-number">$1</span>')
                        .replace(/: (true|false)/g, ': <span class="json-boolean">$1</span>')
                        .replace(/: null/g, ': <span class="json-null">null</span>');
                } catch (error) {
                    console.error('Ê†ºÂºèÂåñJSONÊó∂Âá∫Èîô:', error);
                    return 'Êó†Ê≥ïÊ†ºÂºèÂåñJSONÊï∞ÊçÆ';
                }
            }

            formatSubtype(subtype) {
                if (!subtype) return '';

                // Handle common subtypes with friendly names
                const subtypeMap = {
                    'local_command': this.languageManager.getCurrentLanguage() === 'zh-CN' ? 'Êú¨Âú∞ÂëΩ‰ª§' : 'Local Command',
                    'local_command_stdout': this.languageManager.getCurrentLanguage() === 'zh-CN' ? 'Êú¨Âú∞ÂëΩ‰ª§ËæìÂá∫' : 'Local Command Output',
                    'local_command_stderr': this.languageManager.getCurrentLanguage() === 'zh-CN' ? 'Êú¨Âú∞ÂëΩ‰ª§ÈîôËØØ' : 'Local Command Error',
                    'shell_command': this.languageManager.getCurrentLanguage() === 'zh-CN' ? 'ShellÂëΩ‰ª§' : 'Shell Command',
                    'bash_command': this.languageManager.getCurrentLanguage() === 'zh-CN' ? 'BashÂëΩ‰ª§' : 'Bash Command',
                    'python_command': this.languageManager.getCurrentLanguage() === 'zh-CN' ? 'PythonÂëΩ‰ª§' : 'Python Command',
                    'system_command': this.languageManager.getCurrentLanguage() === 'zh-CN' ? 'Á≥ªÁªüÂëΩ‰ª§' : 'System Command',
                    'user_command': this.languageManager.getCurrentLanguage() === 'zh-CN' ? 'Áî®Êà∑ÂëΩ‰ª§' : 'User Command'
                };

                // Convert underscores to spaces and capitalize first letter for unknown subtypes
                const formattedSubtype = subtypeMap[subtype] ||
                    subtype.replace(/_/g, ' ')
                        .replace(/\b\w/g, l => l.toUpperCase());

                return formattedSubtype;
            }

            updateLanguage() {
                // Update message viewer UI elements with current language
                const conversationDetails = this.shadowRoot.querySelector('h2');
                if (conversationDetails) {
                    const iconSpan = conversationDetails.querySelector('span');
                    if (iconSpan) {
                        conversationDetails.innerHTML = `${iconSpan.outerHTML}${this.languageManager.get('conversationDetails')}`;
                    } else {
                        conversationDetails.textContent = this.languageManager.get('conversationDetails');
                    }
                }

                // Update initial state text
                const initialState = this.shadowRoot.getElementById('initialState');
                if (initialState) {
                    const title = initialState.querySelector('h3');
                    const description = initialState.querySelector('p');
                    if (title) title.textContent = this.languageManager.get('initialStateTitle');
                    if (description) description.textContent = this.languageManager.get('initialStateDescription');
                }

                // Update loading text
                const loadingElements = this.shadowRoot.querySelectorAll('.loading-spinner + p');
                loadingElements.forEach(element => {
                    if (element.textContent === this.languageManager.get('loading') ||
                        element.textContent === 'Âä†ËΩΩ‰∏≠...') {
                        element.textContent = this.languageManager.get('loading');
                    }
                });
            }
        }

        // Language manager component
        class LanguageManager {
            constructor() {
                this.currentLanguage = this.detectLanguage();
                this.translations = {
                    'zh-CN': {
                        // App title
                        'appTitle': 'Claude JSONL È°πÁõÆÂéÜÂè≤Ëß£ÊûêÂô®',

                        // Main app
                        'projectFolder': 'È°πÁõÆÊñá‰ª∂Â§π',
                        'selectFolderPlaceholder': 'ÁÇπÂáªÂè≥‰æßÊåâÈíÆÈÄâÊã©È°πÁõÆÊñá‰ª∂Â§π',
                        'selectButton': 'ÈÄâÊã©',
                        'selectingButton': 'ÈÄâÊã©‰∏≠...',
                        'refreshButton': 'Âà∑Êñ∞',
                        'refreshingButton': 'Âà∑Êñ∞‰∏≠...',
                        'expandAllButton': 'Â±ïÂºÄ',
                        'collapseAllButton': 'ÊäòÂè†',
                        'resetButton': 'ÈáçÁΩÆ',
                        'browserSupportInfo': 'ÈúÄË¶ÅÁé∞‰ª£ÊµèËßàÂô®ÊîØÊåÅÔºàChrome 86+ Êàñ Edge 86+Ôºâ',

                        // File browser
                        'projectStructure': 'È°πÁõÆÁªìÊûÑ',
                        'noProjectData': 'Êó†È°πÁõÆÊï∞ÊçÆ',
                        'unnamedProject': 'Êú™ÂëΩÂêçÈ°πÁõÆ',
                        'loadingPreview': 'Âä†ËΩΩ‰∏≠...',
                        'noValidSessions': 'Êó†ÊúâÊïà‰ºöËØù',
                        'noUserMessage': 'Êó†Áî®Êà∑Ê∂àÊÅØ',
                        'noMessageContent': 'Êó†Ê∂àÊÅØÂÜÖÂÆπ',

                        // Message viewer
                        'conversationDetails': 'ÂØπËØùËØ¶ÊÉÖ',
                        'initialStateTitle': 'ÈÄâÊã©È°πÁõÆÊñá‰ª∂Â§πÂºÄÂßã',
                        'initialStateDescription': 'ÁÇπÂáª"ÈÄâÊã©"ÊåâÈíÆÔºåÁÑ∂ÂêéÈÄâÊã©ÂåÖÂê´ClaudeÂØπËØùÂéÜÂè≤JSONLÊñá‰ª∂ÁöÑÈ°πÁõÆÊñá‰ª∂Â§π„ÄÇ',
                        'loading': 'Âä†ËΩΩ‰∏≠...',
                        'projectOverview': 'È°πÁõÆÊ¶ÇËßà',
                        'projectFolderLabel': 'È°πÁõÆÊñá‰ª∂Â§π',
                        'projectCount': 'È°πÁõÆÊï∞Èáè',
                        'jsonlFiles': 'JSONLÊñá‰ª∂',
                        'nextStep': '‰∏ã‰∏ÄÊ≠•',
                        'nextStepDescription': 'ÁÇπÂáªÂ∑¶‰æßÈ°πÁõÆÁªìÊûÑ‰∏≠ÁöÑJSONLÊñá‰ª∂Êü•ÁúãÂØπËØùËØ¶ÊÉÖ„ÄÇ',
                        'noSessionsFound': 'Êú™ÊâæÂà∞ÊúâÊïà‰ºöËØù',
                        'noSessionsDescription': 'Ê≠§Êñá‰ª∂‰∏≠Ê≤°ÊúâÊâæÂà∞ÊúâÊïàÁöÑClaudeÂØπËØùËÆ∞ÂΩï',
                        'invalidSession': '‰ºöËØùÊï∞ÊçÆÊó†Êïà',
                        'noMessagesInSession': 'Ê≠§‰ºöËØù‰∏≠Ê≤°ÊúâÊ∂àÊÅØ',
                        'unknownSession': 'Êú™Áü•',
                        'messagesCount': 'Ê∂àÊÅØ',
                        'fileName': 'Êñá‰ª∂Âêç',

                        // Message types
                        'user': 'Áî®Êà∑',
                        'assistant': 'Âä©Êâã',
                        'summary': 'ÊÄªÁªì',
                        'system': 'Á≥ªÁªü',
                        'unknownType': 'Êú™Áü•Á±ªÂûã',
                        'textContent': 'ÊñáÊú¨ÂÜÖÂÆπ',

                        // Tool related
                        'thinkingMode': 'ÊÄùËÄÉÊ®°Âºè',
                        'subtype': 'Â≠êÁ±ªÂûã',
                        'inputTokens': 'ËæìÂÖ•',
                        'outputTokens': 'ËæìÂá∫',
                        'toolCall': 'Â∑•ÂÖ∑Ë∞ÉÁî®',
                        'toolResult': 'Â∑•ÂÖ∑ÁªìÊûú',
                        'unknownTool': 'Êú™Áü•Â∑•ÂÖ∑',
                        'compareText': 'ÂØπÊØîÊñáÊú¨',

                        // Text comparison modal
                        'textComparison': 'ÊñáÊú¨ÂØπÊØî',
                        'editsCount': '‰∏™ÁºñËæë',
                        'closeButton': 'ÂÖ≥Èó≠',
                        'originalText': 'ÂéüÂßãÊñáÊú¨',
                        'newText': 'Êñ∞ÊñáÊú¨',
                        'diffComparison': 'Â∑ÆÂºÇÂØπÊØî',
                        'noTextContent': 'Êó†ÊñáÊú¨ÂÜÖÂÆπ',
                        'noDifference': 'Êó†Â∑ÆÂºÇ',

                        // Todo related
                        'noTodos': 'Êó†ÂæÖÂäû‰∫ãÈ°π',

                        // Content extraction
                        'noContent': 'Êó†ÂÜÖÂÆπ',
                        'noTextContent': 'Êó†ÊñáÊú¨ÂÜÖÂÆπ',
                        'toolCallLabel': 'Â∑•ÂÖ∑Ë∞ÉÁî®',
                        'toolResultLabel': 'Â∑•ÂÖ∑ÁªìÊûú',
                        'unknownTool': 'Êú™Áü•',
                        'commandOutput': 'ÂëΩ‰ª§ËæìÂá∫',

                        // Date formatting
                        'today': '‰ªäÂ§©',
                        'yesterday': 'Êò®Â§©',
                        'daysAgo': 'Â§©Ââç',

                        // Errors and alerts
                        'folderSelectionError': 'ÈÄâÊã©Êñá‰ª∂Â§πÊó∂Âá∫Èîô',
                        'refreshError': 'Âà∑Êñ∞Êó∂Âá∫Èîô',
                        'directoryAccessExpired': 'ÁõÆÂΩïËÆøÈóÆÊùÉÈôêÂ∑≤Â§±ÊïàÔºåËØ∑ÈáçÊñ∞ÈÄâÊã©È°πÁõÆÊñá‰ª∂Â§π',
                        'loadProjectError': 'Âä†ËΩΩÈ°πÁõÆÊó∂Âá∫Èîô',
                        'readFileError': 'Êó†Ê≥ïËØªÂèñÊñá‰ª∂',
                        'resetConfirmation': 'Á°ÆÂÆöË¶ÅÈáçÁΩÆÂ∫îÁî®ÂêóÔºüËøôÂ∞ÜÊ∏ÖÈô§ÂΩìÂâçÈÄâÊã©ÁöÑÊñá‰ª∂Â§πÂíåÊâÄÊúâÊï∞ÊçÆ„ÄÇ',
                        'browserNotSupported': 'ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅÊñá‰ª∂Á≥ªÁªüËÆøÈóÆAPI„ÄÇËØ∑‰ΩøÁî®Chrome 86+ÊàñEdge 86+ÁâàÊú¨„ÄÇ',
                        'browserNotSupportedButton': '‰∏çÊîØÊåÅ',

                        // Search functionality
                        'search': 'ÊêúÁ¥¢',
                        'searchPlaceholder': 'ÊêúÁ¥¢ÂØπËØùÂÜÖÂÆπ...',
                        'searching': 'ÊêúÁ¥¢‰∏≠...',
                        'searchResults': 'ÊêúÁ¥¢ÁªìÊûú',
                        'noSearchResults': 'Êú™ÊâæÂà∞ÂåπÈÖçÁªìÊûú',
                        'searchInFile': 'Âú®Êñá‰ª∂‰∏≠ÊêúÁ¥¢',
                        'searchInProject': 'Âú®È°πÁõÆ‰∏≠ÊêúÁ¥¢',
                        'searchOptions': 'ÊêúÁ¥¢ÈÄâÈ°π',
                        'caseSensitive': 'Âå∫ÂàÜÂ§ßÂ∞èÂÜô',
                        'useRegex': '‰ΩøÁî®Ê≠£ÂàôË°®ËææÂºè',
                        'includeFilenames': 'ÂåÖÂê´Êñá‰ª∂Âêç',
                        'searchScope': 'ÊêúÁ¥¢ËåÉÂõ¥',
                        'searchAllFiles': 'ÊâÄÊúâÊñá‰ª∂',
                        'searchCurrentFile': 'ÂΩìÂâçÊñá‰ª∂',
                        'matchesFound': '‰∏™ÂåπÈÖçÁªìÊûú',
                        'fileMatches': 'Êñá‰ª∂ÂåπÈÖçÔºö',
                        'contentMatches': 'ÂÜÖÂÆπÂåπÈÖçÔºö',
                        'clearSearch': 'Ê∏ÖÈô§ÊêúÁ¥¢',
                        'searchNavigation': 'ÊêúÁ¥¢ÂØºËà™',
                        'previousMatch': '‰∏ä‰∏Ä‰∏™ÂåπÈÖç',
                        'nextMatch': '‰∏ã‰∏Ä‰∏™ÂåπÈÖç',
                        'jumpToMatch': 'Ë∑≥ËΩ¨Âà∞ÂåπÈÖçÈ°π',
                        'navigateToFile': 'ÂØºËà™Âà∞Ôºö',
                        'openFile': 'ÊâìÂºÄÊñá‰ª∂Âπ∂Ë∑≥ËΩ¨Âà∞ÂåπÈÖç'
                    },
                    'en': {
                        // App title
                        'appTitle': 'Claude JSONL Project History Viewer',

                        // Main app
                        'projectFolder': 'Project Folder',
                        'selectFolderPlaceholder': 'Click the button on the right to select project folder',
                        'selectButton': 'Select',
                        'selectingButton': 'Selecting...',
                        'refreshButton': 'Refresh',
                        'refreshingButton': 'Refreshing...',
                        'expandAllButton': 'Expand All',
                        'collapseAllButton': 'Collapse All',
                        'resetButton': 'Reset',
                        'browserSupportInfo': 'Requires modern browser support (Chrome 86+ or Edge 86+)',

                        // File browser
                        'projectStructure': 'Project Structure',
                        'noProjectData': 'No project data',
                        'unnamedProject': 'Unnamed Project',
                        'loadingPreview': 'Loading...',
                        'noValidSessions': 'No valid sessions',
                        'noUserMessage': 'No user message',
                        'noMessageContent': 'No message content',

                        // Message viewer
                        'conversationDetails': 'Conversation Details',
                        'initialStateTitle': 'Select Project Folder to Start',
                        'initialStateDescription': 'Click the "Select" button, then choose a project folder containing Claude conversation history JSONL files.',
                        'loading': 'Loading...',
                        'projectOverview': 'Project Overview',
                        'projectFolderLabel': 'Project Folder',
                        'projectCount': 'Project Count',
                        'jsonlFiles': 'JSONL Files',
                        'nextStep': 'Next Step',
                        'nextStepDescription': 'Click on JSONL files in the project structure to view conversation details.',
                        'noSessionsFound': 'No Valid Sessions Found',
                        'noSessionsDescription': 'No valid Claude conversation records found in this file',
                        'invalidSession': 'Invalid Session Data',
                        'noMessagesInSession': 'No messages in this session',
                        'unknownSession': 'Unknown',
                        'messagesCount': 'Messages',
                        'fileName': 'File Name',

                        // Message types
                        'user': 'User',
                        'assistant': 'Assistant',
                        'summary': 'Summary',
                        'system': 'System',
                        'unknownType': 'Unknown Type',
                        'textContent': 'Text Content',


                        // Tool related
                        'thinkingMode': 'Thinking Mode',
                        'subtype': 'Subtype',
                        'inputTokens': 'Input',
                        'outputTokens': 'Output',
                        'toolCall': 'Tool Call',
                        'toolResult': 'Tool Result',
                        'unknownTool': 'Unknown Tool',
                        'compareText': 'Compare Text',

                        // Text comparison modal
                        'textComparison': 'Text Comparison',
                        'editsCount': 'edits',
                        'closeButton': 'Close',
                        'originalText': 'Original Text',
                        'newText': 'New Text',
                        'diffComparison': 'Difference Comparison',
                        'noTextContent': 'No text content',
                        'noDifference': 'No difference',

                        // Todo related
                        'noTodos': 'No todos',

                        // Content extraction
                        'noContent': 'No content',
                        'noTextContent': 'No text content',
                        'toolCallLabel': 'Tool Call',
                        'toolResultLabel': 'Tool Result',
                        'unknownTool': 'Unknown',
                        'commandOutput': 'Command Output',

                        // Date formatting
                        'today': 'Today',
                        'yesterday': 'Yesterday',
                        'daysAgo': 'days ago',

                        // Errors and alerts
                        'folderSelectionError': 'Error selecting folder',
                        'refreshError': 'Error refreshing',
                        'directoryAccessExpired': 'Directory access permission has expired, please reselect the project folder',
                        'loadProjectError': 'Error loading project',
                        'readFileError': 'Unable to read file',
                        'resetConfirmation': 'Are you sure you want to reset the application? This will clear the currently selected folder and all data.',
                        'browserNotSupported': 'Your browser does not support the File System Access API. Please use Chrome 86+ or Edge 86+.',
                        'browserNotSupportedButton': 'Not Supported',

                        // Search functionality
                        'search': 'Search',
                        'searchPlaceholder': 'Search conversation content...',
                        'searching': 'Searching...',
                        'searchResults': 'Search Results',
                        'noSearchResults': 'No matches found',
                        'searchInFile': 'Search in File',
                        'searchInProject': 'Search in Project',
                        'searchOptions': 'Search Options',
                        'caseSensitive': 'Case Sensitive',
                        'useRegex': 'Use Regex',
                        'includeFilenames': 'Include Filenames',
                        'searchScope': 'Search Scope',
                        'searchAllFiles': 'All Files',
                        'searchCurrentFile': 'Current File',
                        'matchesFound': 'matches found',
                        'fileMatches': 'File matches:',
                        'contentMatches': 'Content matches:',
                        'clearSearch': 'Clear Search',
                        'searchNavigation': 'Search Navigation',
                        'previousMatch': 'Previous Match',
                        'nextMatch': 'Next Match',
                        'jumpToMatch': 'Jump to Match',
                        'navigateToFile': 'Navigate to:',
                        'openFile': 'Open File & Go to Match'
                    }
                };
            }

            detectLanguage() {
                const browserLang = navigator.language || navigator.userLanguage;
                return browserLang.startsWith('zh') ? 'zh-CN' : 'en';
            }

            get(key) {
                const translation = this.translations[this.currentLanguage];
                return translation && translation[key] !== undefined ? translation[key] : key;
            }

            setLanguage(language) {
                if (this.translations[language]) {
                    this.currentLanguage = language;
                    this.updatePageLanguage();
                    this.notifyLanguageChange();
                    return true;
                }
                return false;
            }

            updatePageLanguage() {
                document.documentElement.lang = this.currentLanguage;
            }

            notifyLanguageChange() {
                // Dispatch custom event for components to update
                const event = new CustomEvent('languageChanged', {
                    detail: { language: this.currentLanguage }
                });
                document.dispatchEvent(event);
            }

            getCurrentLanguage() {
                return this.currentLanguage;
            }

            // Helper method to get all available languages
            getAvailableLanguages() {
                return Object.keys(this.translations);
            }
        }

        // Search functionality manager
        class SearchManager {
            constructor() {
                this.searchResults = [];
                this.currentSearchTerm = '';
                this.searchOptions = {
                    caseSensitive: false,
                    useRegex: false,
                    includeFilenames: true,
                    searchScope: 'all' // 'current' or 'all'
                };
                this.isSearching = false;
                this.languageManager = window.languageManager;
                this.dataManager = window.dataManager;
            }

            // Search options management
            setSearchOptions(options) {
                this.searchOptions = { ...this.searchOptions, ...options };
            }

            getSearchOptions() {
                return { ...this.searchOptions };
            }

            // Main search function
            async search(searchTerm) {
                if (!searchTerm || searchTerm.trim() === '') {
                    this.clearSearch();
                    return [];
                }

                this.isSearching = true;
                this.currentSearchTerm = searchTerm.trim();
                this.searchResults = [];

                try {
                    if (this.searchOptions.searchScope === 'current') {
                        this.searchResults = await this.searchInCurrentFile();
                    } else {
                        this.searchResults = await this.searchInAllFiles();
                    }
                } catch (error) {
                    console.error('Search error:', error);
                    this.searchResults = [];
                } finally {
                    this.isSearching = false;
                }

                return this.searchResults;
            }

            // Search in current file
            async searchInCurrentFile() {
                const projectData = this.dataManager.getProjectData();
                const currentFile = projectData.currentFile;

                console.log('Debug - Current file:', currentFile);
                console.log('Debug - Current file sessions:', projectData.currentFileSessions);
                console.log('Debug - Total sessions available:', Object.keys(projectData.sessions).length);

                if (!currentFile) {
                    console.warn('No current file loaded');
                    return [];
                }

                const results = [];

                // Search in filename if enabled
                if (this.searchOptions.includeFilenames) {
                    const filenameMatches = this.searchInText(currentFile, this.currentSearchTerm);
                    if (filenameMatches.length > 0) {
                        results.push({
                            type: 'filename',
                            file: currentFile,
                            matches: filenameMatches,
                            sessionId: null,
                            messageIndex: null,
                            content: currentFile
                        });
                    }
                }

                // Search in file content using DataManager's session data
                const sessionIds = projectData.currentFileSessions || [];
                console.log('Debug - Session IDs for current file:', sessionIds.length);

                for (const sessionId of sessionIds) {
                    const session = projectData.sessions[sessionId];
                    if (!session || !session.messages) {
                        console.warn('No session or messages for:', sessionId);
                        continue;
                    }

                    console.log('Debug - Processing session:', sessionId, 'Messages:', session.messages.length);

                    for (let i = 0; i < session.messages.length; i++) {
                        const message = session.messages[i];
                        const content = this.extractMessageContent(message);

                        if (content && content.length > 0) {
                            const contentMatches = this.searchInText(content, this.currentSearchTerm);
                            if (contentMatches.length > 0) {
                                results.push({
                                    type: 'content',
                                    file: currentFile,
                                    matches: contentMatches,
                                    sessionId: sessionId,
                                    sessionTitle: session.title || this.languageManager.get('unknownSession'),
                                    messageIndex: i,
                                    messageType: message.type || message.role || this.languageManager.get('unknownType'),
                                    content: content
                                });
                            }
                        }
                    }
                }

                console.log('Debug - Total results found in current file:', results.length);
                return results;
            }

            // Search in all files
            async searchInAllFiles() {
                const results = [];

                console.log('Debug - Searching in all files using DataManager');

                try {
                    // Use DataManager's new method to search all files directly
                    results.push(...await this.dataManager.searchInAllFilesDirectly(this.currentSearchTerm, this.searchOptions));
                } catch (error) {
                    console.error('Error searching all files:', error);
                }

                console.log('Debug - Total results found in all files:', results.length);
                return results;
            }

            // Search in text with options
            searchInText(text, searchTerm) {
                const matches = [];
                const searchRegex = this.createSearchRegex(searchTerm);

                if (!searchRegex) return matches;

                let match;
                while ((match = searchRegex.exec(text)) !== null) {
                    matches.push({
                        text: match[0],
                        index: match.index,
                        length: match[0].length
                    });
                }

                return matches;
            }

            // Create search regex based on options
            createSearchRegex(searchTerm) {
                try {
                    let pattern;

                    if (this.searchOptions.useRegex) {
                        pattern = searchTerm;
                    } else {
                        pattern = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    }

                    const flags = this.searchOptions.caseSensitive ? 'g' : 'gi';
                    return new RegExp(pattern, flags);
                } catch (error) {
                    console.warn('Invalid search pattern:', error);
                    return null;
                }
            }

  
            // Extract message content for searching
            extractMessageContent(message) {
                const content = [];

                // Main content
                if (message.content) {
                    if (typeof message.content === 'string') {
                        content.push(message.content);
                    } else if (Array.isArray(message.content)) {
                        content.push(...message.content.map(item =>
                            typeof item === 'string' ? item : (item.text || '')
                        ));
                    }
                }

                // Try to extract content from other possible fields
                if (message.text) {
                    content.push(message.text);
                }

                if (message.input) {
                    if (typeof message.input === 'string') {
                        content.push(message.input);
                    } else if (typeof message.input === 'object') {
                        content.push(JSON.stringify(message.input));
                    }
                }

                // Tool calls and results
                if (message.tool_calls) {
                    message.tool_calls.forEach(toolCall => {
                        if (toolCall.function && toolCall.function.name) {
                            content.push(toolCall.function.name);
                            if (toolCall.function.arguments) {
                                content.push(toolCall.function.arguments);
                            }
                        }
                    });
                }

                if (message.function_call) {
                    if (message.function_call.name) {
                        content.push(message.function_call.name);
                    }
                    if (message.function_call.arguments) {
                        content.push(message.function_call.arguments);
                    }
                }

                if (message.result && typeof message.result === 'string') {
                    content.push(message.result);
                }

                if (message.output) {
                    content.push(message.output);
                }

                // Try to get content from assistant/role fields
                if (message.assistant) {
                    if (typeof message.assistant === 'string') {
                        content.push(message.assistant);
                    } else if (message.assistant.content) {
                        content.push(message.assistant.content);
                    }
                }

                // Add message type/role as searchable content
                if (message.type) {
                    content.push(message.type);
                }
                if (message.role) {
                    content.push(message.role);
                }

                // If no specific content found, stringify the whole message as fallback
                if (content.length === 0) {
                    const messageStr = JSON.stringify(message);
                    if (messageStr && messageStr.length > 2) { // Not empty object
                        content.push(messageStr);
                    }
                }

                const result = content.join(' ').trim();
                console.log('Debug - Extracted content length:', result.length, 'from message keys:', Object.keys(message));
                return result;
            }

            // Note: File handling methods removed - we now use DataManager's session data directly

            // Note: parseSessions removed - we now use DataManager's session data directly

            // Clear search results
            clearSearch() {
                this.searchResults = [];
                this.currentSearchTerm = '';
                this.isSearching = false;
            }

            // Get search results
            getSearchResults() {
                return [...this.searchResults];
            }

            // Get current search state
            getSearchState() {
                return {
                    isSearching: this.isSearching,
                    searchTerm: this.currentSearchTerm,
                    resultCount: this.searchResults.length,
                    options: { ...this.searchOptions }
                };
            }

            // Navigate to search result
            async navigateToResult(result) {
                if (result.type === 'content' && result.sessionId && (result.file || result.filePath)) {
                    // Load the file if not already loaded
                    const projectData = this.dataManager.getProjectData();
                    const fileName = result.file || result.filePath;

                    if (projectData.currentFile !== fileName) {
                        // This would need to be implemented in DataManager
                        // For now, we'll dispatch an event
                        document.dispatchEvent(new CustomEvent('navigateToFile', {
                            detail: {
                                file: fileName,
                                sessionId: result.sessionId,
                                messageIndex: result.messageIndex,
                                filePath: result.filePath
                            }
                        }));
                    } else {
                        // Navigate to the specific message
                        document.dispatchEvent(new CustomEvent('navigateToMessage', {
                            detail: { sessionId: result.sessionId, messageIndex: result.messageIndex }
                        }));
                    }
                }
            }
        }

        // Initialize managers
        window.languageManager = new LanguageManager();
        window.dataManager = new DataManager();
        window.styleManager = new StyleManager();
        window.searchManager = new SearchManager();

        // Search Results Viewer Component
        class SearchResultsViewer extends HTMLElement {
            constructor() {
                super();
                this.searchManager = window.searchManager;
                this.dataManager = window.dataManager;
                this.languageManager = window.languageManager;
                this.styleManager = window.styleManager;
                this.currentResults = [];
                this.selectedResultIndex = -1;
                this.attachShadow({ mode: 'open' });
            }

            connectedCallback() {
                this.render();
                this.attachEventListeners();
            }

            render() {
                this.shadowRoot.innerHTML = `
            <style>
                ${this.styleManager.generateTailwindStyles()}
                ${this.getSearchResultsStyles()}
            </style>
            <div class="search-results-container" style="height: 100%; display: flex; flex-direction: column;">
                <div class="search-results-header" style="padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-primary); flex-shrink: 0;">
                    <h3 class="search-results-title" style="color: var(--text-primary); font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem;">
                        üîç ${this.languageManager.get('searchResults')}
                    </h3>
                    <div class="search-results-info" style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 0.5rem;">
                        ${this.getResultsInfo()}
                    </div>
                </div>

                <div class="search-results-list" style="flex: 1; overflow-y: auto; padding: 0.5rem 1.5rem 1rem 1.5rem;">
                    ${this.renderResults()}
                </div>
            </div>
        `;
            }

            getSearchResultsStyles() {
                return `
                .search-result-item {
                    padding: 0.75rem;
                    border-bottom: 1px solid var(--border-primary);
                    cursor: pointer;
                    transition: background-color 0.2s;
                }

                .search-result-item:hover {
                    background-color: var(--bg-secondary);
                }

                .search-result-item.selected {
                    background-color: var(--bg-tertiary);
                    border-left: 3px solid var(--button-primary);
                }

                .search-result-type {
                    display: inline-block;
                    padding: 0.125rem 0.375rem;
                    border-radius: 0.25rem;
                    font-size: 0.75rem;
                    font-weight: 500;
                    margin-right: 0.5rem;
                }

                .search-result-type.filename {
                    background-color: var(--button-secondary);
                    color: var(--text-primary);
                }

                .search-result-type.content {
                    background-color: var(--button-primary);
                    color: var(--text-inverse);
                }

                .search-result-file {
                    font-weight: 500;
                    color: var(--text-primary);
                    margin-bottom: 0.25rem;
                }

                .search-result-session {
                    font-size: 0.875rem;
                    color: var(--text-secondary);
                    margin-bottom: 0.25rem;
                }

                .search-result-context {
                    font-size: 0.875rem;
                    color: var(--text-primary);
                    line-height: 1.4;
                    margin-top: 0.5rem;
                    padding: 0.5rem;
                    background-color: var(--bg-secondary);
                    border-radius: 0.375rem;
                    border-left: 3px solid var(--button-primary);
                }

                .search-highlight {
                    background-color: #fef3c7;
                    color: #92400e;
                    padding: 0.0625rem 0.125rem;
                    border-radius: 0.125rem;
                    font-weight: 500;
                }

                /* Dark theme support for search highlight */
                @media (prefers-color-scheme: dark) {
                    .search-highlight {
                        background-color: #92400e;
                        color: #fef3c7;
                    }
                }

                .search-navigation {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 0.75rem;
                    border-top: 1px solid var(--border-primary);
                    background-color: var(--bg-secondary);
                }

                .search-nav-buttons {
                    display: flex;
                    gap: 0.5rem;
                }

                .search-nav-button {
                    padding: 0.375rem 0.75rem;
                    border-radius: 0.375rem;
                    font-size: 0.875rem;
                    border: 1px solid var(--border-primary);
                    background-color: var(--bg-primary);
                    color: var(--text-primary);
                    cursor: pointer;
                    transition: all 0.2s;
                }

                .search-nav-button:hover:not(:disabled) {
                    background-color: var(--button-primary);
                    color: var(--text-inverse);
                    border-color: var(--button-primary);
                }

                .search-nav-button:disabled {
                    opacity: 0.5;
                    cursor: not-allowed;
                }

                .search-nav-info {
                    font-size: 0.875rem;
                    color: var(--text-secondary);
                }

                .navigate-btn:hover {
                    background-color: var(--button-hover) !important;
                    transform: translateY(-1px);
                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                }

                .navigate-btn:active {
                    transform: translateY(0);
                    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
                }
                `;
            }

            getResultsInfo() {
                if (this.searchManager.isSearching) {
                    return `${this.languageManager.get('searching')}...`;
                }

                const totalMatches = this.currentResults.reduce((sum, result) => sum + result.matches.length, 0);
                const fileCount = new Set(this.currentResults.map(r => r.file)).size;

                if (this.currentResults.length === 0) {
                    return this.languageManager.get('noSearchResults');
                }

                return `${fileCount} ${this.languageManager.get('fileMatches')} ${totalMatches} ${this.languageManager.get('matchesFound')}`;
            }

            renderResults() {
                if (this.currentResults.length === 0) {
                    return `
                    <div class="no-results" style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üîç</div>
                        <div>${this.languageManager.get('noSearchResults')}</div>
                    </div>
                `;
                }

                return this.currentResults.map((result, index) => this.renderResult(result, index)).join('');
            }

            renderResult(result, index) {
                const isSelected = index === this.selectedResultIndex;
                const typeClass = result.type;
                const typeLabel = result.type === 'filename' ?
                    this.languageManager.get('fileName') :
                    this.languageManager.get('content');

                // Format date
                let dateInfo = '';
                if (result.lastModified) {
                    const date = new Date(result.lastModified);
                    dateInfo = this.formatDate(date);
                } else if (result.timestamp) {
                    const date = new Date(result.timestamp);
                    dateInfo = this.formatDate(date);
                }

                return `
                <div class="search-result-item ${isSelected ? 'selected' : ''}" data-index="${index}" style="cursor: pointer;">
                    <div class="search-result-header">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.25rem;">
                            <span class="search-result-type ${typeClass}">${typeLabel}</span>
                            ${dateInfo ? `<div style="font-size: 0.75rem; color: var(--text-tertiary); white-space: nowrap;">${dateInfo}</div>` : ''}
                        </div>
                        <div class="search-result-file">${result.file}</div>
                        ${result.projectName ? `<div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.25rem;">üìÅ ${result.projectName}</div>` : ''}
                        ${result.sessionTitle ? `<div class="search-result-session">${result.sessionTitle}</div>` : ''}
                        ${result.messageType ? `<div style="font-size: 0.75rem; color: var(--text-tertiary);">${result.messageType}</div>` : ''}
                    </div>
                    ${result.matches.length > 0 ? this.renderResultContext(result) : ''}
                    ${isSelected ? this.renderNavigationOptions(result) : ''}
                </div>
                `;
            }

            formatDate(date) {
                if (!date) return '';

                const now = new Date();
                const diffMs = now - date;
                const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                const diffWeeks = Math.floor(diffDays / 7);

                if (diffDays === 0) {
                    return this.languageManager.get('today') + ' ' + date.toLocaleTimeString({ hour: '2-digit', minute: '2-digit' });
                } else if (diffDays === 1) {
                    return this.languageManager.get('yesterday') + ' ' + date.toLocaleTimeString({ hour: '2-digit', minute: '2-digit' });
                } else if (diffDays >= 2 && diffDays <= 6) {
                    return `${diffDays}${this.languageManager.get('daysAgo')}`;
                } else if (diffWeeks === 1) {
                    return this.languageManager.get('lastWeek');
                } else if (diffWeeks >= 2 && diffWeeks <= 3) {
                    return `${diffWeeks}${this.languageManager.get('weeksAgo')}`;
                } else {
                    return date.toLocaleDateString();
                }
            }

            renderResultContext(result) {
                const match = result.matches[0]; // Show first match as preview
                const context = this.getContextAroundMatch(result.content, match.index, match.length);

                return `
                <div class="search-result-context">
                    ${this.highlightSearchTerm(context)}
                </div>
                `;
            }

            renderNavigationOptions(result) {
                return `
                <div class="search-navigation-options" style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border-primary);">
                    <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                        ${this.languageManager.get('navigateToFile') || 'Navigate to:'}
                    </div>
                    <button class="navigate-btn" data-result-index="${this.currentResults.indexOf(result)}"
                            style="background-color: var(--button-primary); color: var(--text-inverse);
                                   border: none; padding: 0.5rem 1rem; border-radius: 0.375rem;
                                   font-size: 0.8rem; cursor: pointer; transition: all 0.2s ease;
                                   display: flex; align-items: center; gap: 0.5rem;">
                        <span>üìÑ</span>
                        <span>${this.languageManager.get('openFile') || 'Open File & Go to Match'}</span>
                    </button>
                </div>
                `;
            }

            getContextAroundMatch(content, matchIndex, matchLength, contextLength = 100) {
                const start = Math.max(0, matchIndex - contextLength);
                const end = Math.min(content.length, matchIndex + matchLength + contextLength);

                let context = content.substring(start, end);

                if (start > 0) {
                    context = '...' + context;
                }
                if (end < content.length) {
                    context = context + '...';
                }

                return context;
            }

            highlightSearchTerm(text) {
                if (!this.searchManager.currentSearchTerm) return text;

                try {
                    const regex = this.searchManager.createSearchRegex(this.searchManager.currentSearchTerm);
                    return text.replace(regex, match => `<span class="search-highlight">${match}</span>`);
                } catch (error) {
                    return text;
                }
            }

            renderNavigation() {
                return `
                <div class="search-navigation">
                    <div class="search-nav-buttons">
                        <button class="search-nav-button" id="prevResult" ${this.selectedResultIndex <= 0 ? 'disabled' : ''}>
                            ‚Üë ${this.languageManager.get('previousMatch')}
                        </button>
                        <button class="search-nav-button" id="nextResult" ${this.selectedResultIndex >= this.currentResults.length - 1 ? 'disabled' : ''}>
                            ${this.languageManager.get('nextMatch')} ‚Üì
                        </button>
                    </div>
                    <div class="search-nav-info">
                        ${this.selectedResultIndex >= 0 ?
                            `${this.selectedResultIndex + 1} / ${this.currentResults.length}` :
                            this.languageManager.get('searchNavigation')
                        }
                    </div>
                </div>
                `;
            }

            attachEventListeners() {
                // Result item clicks for selection
                this.shadowRoot.addEventListener('click', (e) => {
                    const resultItem = e.target.closest('.search-result-item');
                    if (resultItem) {
                        const index = parseInt(resultItem.dataset.index);
                        this.selectResult(index);
                    }

                    // Navigation button clicks
                    const navigateBtn = e.target.closest('.navigate-btn');
                    if (navigateBtn) {
                        const resultIndex = parseInt(navigateBtn.dataset.resultIndex);
                        this.navigateToResult(resultIndex);
                    }
                });

                // Listen for search updates
                document.addEventListener('searchUpdated', () => {
                    this.updateResults();
                });
            }

            updateResults() {
                this.currentResults = this.searchManager.getSearchResults();
                this.selectedResultIndex = this.currentResults.length > 0 ? 0 : -1;
                this.render();
            }

            selectResult(index) {
                this.selectedResultIndex = index;
                this.render();
                this.scrollToResult(index);
            }

            selectPreviousResult() {
                if (this.selectedResultIndex > 0) {
                    this.selectResult(this.selectedResultIndex - 1);
                }
            }

            selectNextResult() {
                if (this.selectedResultIndex < this.currentResults.length - 1) {
                    this.selectResult(this.selectedResultIndex + 1);
                }
            }

            scrollToResult(index) {
                const resultItems = this.shadowRoot.querySelectorAll('.search-result-item');
                if (resultItems[index]) {
                    resultItems[index].scrollIntoView({
                        block: 'nearest',
                        behavior: 'smooth'
                    });
                }
            }

            async navigateToResult(index) {
                if (index >= 0 && index < this.currentResults.length) {
                    const result = this.currentResults[index];
                    await this.searchManager.navigateToResult(result);
                }
            }
        }

        // Initialize theme globally
        window.styleManager.initializeTheme();

        // Register custom elements
        customElements.define('claude-history-app', ClaudeCodeHistoryApp);
        customElements.define('file-browser', FileBrowser);
        customElements.define('message-viewer', MessageViewer);
        customElements.define('search-results-viewer', SearchResultsViewer);
    </script>
</body>

</html>